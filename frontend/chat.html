<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIDEON 3.0 - Futuristic Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Neon Colors */
            --neon-cyan: #00f5ff;
            --neon-magenta: #ff00ff;
            --neon-blue: #0080ff;
            --neon-purple: #8000ff;
            --neon-green: #00ff88;
            --neon-yellow: #ffcc00;
            
            /* Mode Colors */
            --pilot-color: #00ff88;
            --copilot-color: #00f5ff;
            --passive-color: #888888;
            --executive-color: #ff00ff;
            
            /* Backgrounds */
            --dark-bg: #0a0a0f;
            --dark-card: rgba(15, 15, 25, 0.9);
            --glass-border: rgba(0, 245, 255, 0.3);
            
            /* Current mode */
            --current-mode-color: var(--copilot-color);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--dark-bg);
            height: 100vh;
            color: #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        /* Animated background grid */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, rgba(0,245,255,0.03) 1px, transparent 1px),
                linear-gradient(rgba(0,245,255,0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes gridMove {
            0% { transform: perspective(500px) rotateX(60deg) translateY(0); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(50px); }
        }
        
        /* Glowing orbs background */
        body::after {
            content: '';
            position: fixed;
            top: 20%;
            left: 10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(0,245,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(60px);
            animation: floatOrb 8s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes floatOrb {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(100px, 50px) scale(1.2); }
        }
        
        /* Second orb */
        .orb-2 {
            position: fixed;
            bottom: 10%;
            right: 5%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255,0,255,0.08) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(50px);
            animation: floatOrb2 10s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes floatOrb2 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-80px, -40px) scale(1.3); }
        }
        
        /* ============ GIDEON TOOLS SIDEBAR ============ */
        .gideon-toolbar {
            position: fixed;
            top: 80px;
            left: 0;
            width: 60px;
            height: calc(100vh - 80px);
            background: rgba(10, 10, 20, 0.95);
            border-right: 2px solid rgba(0, 245, 255, 0.3);
            z-index: 500;
            display: flex;
            flex-direction: column;
            padding: 10px 5px;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .gideon-toolbar:hover,
        .gideon-toolbar.expanded {
            width: 280px;
        }
        
        .toolbar-toggle {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-blue));
            border: none;
            border-radius: 10px;
            color: #000;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .toolbar-toggle:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
        }
        
        .toolbar-toggle .toggle-text {
            display: none;
            white-space: nowrap;
        }
        
        .gideon-toolbar:hover .toggle-text,
        .gideon-toolbar.expanded .toggle-text {
            display: inline;
        }
        
        .toolbar-section {
            margin-bottom: 5px;
        }
        
        .toolbar-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        .toolbar-section-header:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--neon-cyan);
        }
        
        .toolbar-section-header .icon {
            font-size: 1.2rem;
            min-width: 30px;
            text-align: center;
        }
        
        .toolbar-section-header .label {
            display: none;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            font-size: 0.85rem;
            color: #fff;
            white-space: nowrap;
            flex: 1;
        }
        
        .gideon-toolbar:hover .toolbar-section-header .label,
        .gideon-toolbar.expanded .toolbar-section-header .label {
            display: block;
        }
        
        .toolbar-section-header .arrow {
            display: none;
            transition: transform 0.3s ease;
        }
        
        .gideon-toolbar:hover .toolbar-section-header .arrow,
        .gideon-toolbar.expanded .toolbar-section-header .arrow {
            display: block;
        }
        
        .toolbar-section.open .toolbar-section-header .arrow {
            transform: rotate(180deg);
        }
        
        .toolbar-section-content {
            display: none;
            padding: 5px 0 5px 15px;
            flex-direction: column;
            gap: 4px;
        }
        
        .toolbar-section.open .toolbar-section-content {
            display: flex;
        }
        
        .toolbar-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .toolbar-btn:hover {
            background: rgba(0, 245, 255, 0.1);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
            transform: translateX(5px);
        }
        
        .toolbar-btn .btn-icon {
            font-size: 1rem;
            min-width: 20px;
            text-align: center;
        }
        
        /* Section specific colors */
        .toolbar-section.security .toolbar-section-header { border-left: 3px solid #ffd700; }
        .toolbar-section.security .toolbar-btn:hover { border-color: #ffd700; color: #ffd700; }
        
        .toolbar-section.health .toolbar-section-header { border-left: 3px solid #00ff88; }
        .toolbar-section.health .toolbar-btn:hover { border-color: #00ff88; color: #00ff88; }
        
        .toolbar-section.science .toolbar-section-header { border-left: 3px solid #9f7aea; }
        .toolbar-section.science .toolbar-btn:hover { border-color: #9f7aea; color: #9f7aea; }
        
        .toolbar-section.chemistry .toolbar-section-header { border-left: 3px solid #00bfff; }
        .toolbar-section.chemistry .toolbar-btn:hover { border-color: #00bfff; color: #00bfff; }
        
        .toolbar-section.archaeology .toolbar-section-header { border-left: 3px solid #d4a574; }
        .toolbar-section.archaeology .toolbar-btn:hover { border-color: #d4a574; color: #d4a574; }
        
        .toolbar-section.military .toolbar-section-header { border-left: 3px solid #888; }
        .toolbar-section.military .toolbar-btn:hover { border-color: #aaa; color: #ccc; }
        
        .toolbar-section.monitor .toolbar-section-header { border-left: 3px solid #00f5ff; }
        .toolbar-section.monitor .toolbar-btn:hover { border-color: #00f5ff; color: #00f5ff; }
        
        .toolbar-section.cyber .toolbar-section-header { border-left: 3px solid #ff4466; }
        .toolbar-section.cyber .toolbar-btn:hover { border-color: #ff4466; color: #ff4466; }
        
        .toolbar-section.analysis .toolbar-section-header { border-left: 3px solid #ff8c00; }
        .toolbar-section.analysis .toolbar-btn:hover { border-color: #ff8c00; color: #ff8c00; }
        
        .toolbar-section.utilities .toolbar-section-header { border-left: 3px solid #32cd32; }
        .toolbar-section.utilities .toolbar-btn:hover { border-color: #32cd32; color: #32cd32; }
        
        .toolbar-section.ai .toolbar-section-header { border-left: 3px solid #ff00ff; }
        .toolbar-section.ai .toolbar-btn:hover { border-color: #ff00ff; color: #ff00ff; }
        
        .toolbar-section.data .toolbar-section-header { border-left: 3px solid #1e90ff; }
        .toolbar-section.data .toolbar-btn:hover { border-color: #1e90ff; color: #1e90ff; }
        
        .toolbar-section.core .toolbar-section-header { border-left: 3px solid #00ffcc; }
        .toolbar-section.core .toolbar-btn:hover { border-color: #00ffcc; color: #00ffcc; }
        
        /* Advanced tool buttons styling */
        .toolbar-btn.advanced {
            background: linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,200,255,0.1));
            border: 1px solid rgba(0,255,136,0.3);
            position: relative;
        }
        .toolbar-btn.advanced:hover {
            background: linear-gradient(135deg, rgba(0,255,136,0.2), rgba(0,200,255,0.2));
            border-color: #00ff88;
            color: #00ff88;
        }
        .toolbar-btn.advanced::after {
            content: 'âœ¨';
            position: absolute;
            right: 5px;
            font-size: 0.7em;
            opacity: 0.7;
        }
        
        /* Toolbar divider and label */
        .toolbar-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent);
            margin: 8px 0;
        }
        .toolbar-label {
            font-size: 0.7em;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 4px 8px;
            margin-bottom: 4px;
        }
        
        /* Adjust main content when toolbar is present */
        .chat-header,
        .stats-bar,
        .chat-container,
        .input-area {
            margin-left: 60px;
            transition: margin-left 0.3s ease;
        }
        
        /* Loading indicator for toolbar actions */
        .toolbar-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px 50px;
            border-radius: 15px;
            border: 2px solid var(--neon-cyan);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .toolbar-loading.active {
            display: flex;
        }
        
        .toolbar-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 245, 255, 0.2);
            border-top-color: var(--neon-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .toolbar-loading .loading-text {
            font-family: 'Orbitron', monospace;
            color: var(--neon-cyan);
            font-size: 0.9rem;
        }
        
        /* Results panel */
        .results-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            background: rgba(10, 10, 25, 0.98);
            border: 2px solid var(--neon-cyan);
            border-radius: 15px;
            z-index: 9000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 245, 255, 0.3);
        }
        
        .results-panel.active {
            display: flex;
            animation: slideIn 0.3s ease;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(0, 245, 255, 0.2), rgba(0, 128, 255, 0.1));
            border-bottom: 1px solid rgba(0, 245, 255, 0.3);
        }
        
        .results-header h3 {
            font-family: 'Orbitron', monospace;
            color: var(--neon-cyan);
            font-size: 1rem;
        }
        
        .results-close {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .results-close:hover {
            background: rgba(255, 68, 68, 0.4);
            transform: scale(1.1);
        }
        
        .results-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .results-content pre {
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .results-content .result-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border-left: 3px solid var(--neon-cyan);
        }
        
        .results-content .result-section h4 {
            color: var(--neon-cyan);
            margin-bottom: 10px;
            font-family: 'Orbitron', monospace;
        }
        
        /* ============ HEADER ============ */
        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 25px;
            background: var(--dark-card);
            border-bottom: 2px solid var(--glass-border);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--current-mode-color), var(--neon-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            font-size: 20px;
            box-shadow: 0 0 30px var(--current-mode-color);
            border: 2px solid var(--current-mode-color);
            transition: all 0.3s ease;
            animation: avatarPulse 3s ease-in-out infinite;
        }
        
        @keyframes avatarPulse {
            0%, 100% { box-shadow: 0 0 20px var(--current-mode-color); }
            50% { box-shadow: 0 0 40px var(--current-mode-color), 0 0 60px var(--current-mode-color); }
        }
        
        .header-info {
            display: flex;
            flex-direction: column;
        }
        
        .header-name {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 1.3em;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 3px;
        }
        
        .header-status {
            font-size: 0.8em;
            color: var(--neon-cyan);
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Rajdhani', sans-serif;
            letter-spacing: 1px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green);
            animation: statusPulse 1.5s infinite;
        }
        
        @keyframes statusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }
        
        /* Mode Indicator */
        .mode-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 18px;
            background: var(--dark-card);
            border: 2px solid var(--current-mode-color);
            border-radius: 25px;
            font-family: 'Orbitron', monospace;
            font-size: 0.75em;
            letter-spacing: 2px;
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .mode-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--current-mode-color);
            box-shadow: 0 0 15px var(--current-mode-color);
            animation: modePulse 2s ease-in-out infinite;
        }
        
        @keyframes modePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.85); }
        }
        
        .mode-text {
            color: var(--current-mode-color);
            font-weight: 700;
            text-shadow: 0 0 10px var(--current-mode-color);
        }
        
        /* Mode Selector */
        .mode-selector {
            display: flex;
            gap: 6px;
        }
        
        .mode-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: var(--dark-card);
            color: rgba(255,255,255,0.5);
            font-family: 'Orbitron', monospace;
            font-size: 0.65em;
            font-weight: 600;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .mode-btn:hover {
            transform: translateY(-2px);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, rgba(0,245,255,0.2), rgba(128,0,255,0.1));
            border-color: var(--current-mode-color);
            color: var(--current-mode-color);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
        }
        
        /* ============ STATS BAR ============ */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 10px 20px;
            background: rgba(10, 10, 20, 0.7);
            border-bottom: 1px solid var(--glass-border);
            font-family: 'Orbitron', monospace;
            font-size: 0.7em;
            letter-spacing: 1px;
            flex-shrink: 0;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255,255,255,0.6);
        }
        
        .stat-item span:last-child {
            color: var(--neon-cyan);
            font-weight: 600;
        }
        
        /* VOICE ACTIVATION BUTTON */
        .voice-activate-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 20px;
            background: linear-gradient(135deg, rgba(255, 0, 100, 0.2), rgba(255, 0, 100, 0.1));
            border: 2px solid #ff0066;
            border-radius: 25px;
            color: #ff0066;
            font-family: 'Orbitron', monospace;
            font-size: 0.8em;
            font-weight: 700;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 0, 100, 0.3);
        }
        
        .voice-activate-btn svg {
            width: 20px;
            height: 20px;
        }
        
        .voice-activate-btn:hover {
            background: linear-gradient(135deg, rgba(255, 0, 100, 0.4), rgba(255, 0, 100, 0.2));
            transform: scale(1.05);
            box-shadow: 0 0 35px rgba(255, 0, 100, 0.5);
        }
        
        .voice-activate-btn.listening {
            background: linear-gradient(135deg, #ff0066, #ff3388);
            color: white;
            animation: voiceBtnPulse 1s ease-in-out infinite;
            box-shadow: 0 0 40px rgba(255, 0, 100, 0.7);
        }
        
        @keyframes voiceBtnPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        /* ============ CHAT CONTAINER ============ */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }
        
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: var(--neon-cyan);
            border-radius: 3px;
            box-shadow: 0 0 10px var(--neon-cyan);
        }
        
        /* Welcome Message */
        .welcome-message {
            text-align: center;
            padding: 40px;
            background: var(--dark-card);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .welcome-title {
            font-family: 'Orbitron', monospace;
            font-size: 2em;
            font-weight: 900;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            letter-spacing: 4px;
            animation: glowPulse 2s ease-in-out infinite;
        }
        
        @keyframes glowPulse {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(0,245,255,0.5)); }
            50% { filter: drop-shadow(0 0 25px rgba(0,245,255,0.8)); }
        }
        
        .welcome-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        
        .welcome-date {
            color: var(--neon-cyan);
            font-family: 'Orbitron', monospace;
            font-size: 0.85em;
            letter-spacing: 2px;
        }
        
        /* Date Divider */
        .date-divider {
            text-align: center;
            padding: 15px 0;
        }
        
        .date-divider span {
            background: var(--dark-card);
            padding: 8px 20px;
            border-radius: 20px;
            font-family: 'Orbitron', monospace;
            font-size: 0.7em;
            color: var(--neon-cyan);
            letter-spacing: 2px;
            border: 1px solid var(--glass-border);
        }
        
        /* Messages */
        .message {
            display: flex;
            flex-direction: column;
            max-width: 75%;
            animation: messageSlide 0.3s ease-out;
        }
        
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            align-self: flex-end;
        }
        
        .message.assistant {
            align-self: flex-start;
        }
        
        .message-content {
            padding: 15px 20px;
            border-radius: 18px;
            font-size: 0.95em;
            line-height: 1.6;
            position: relative;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 20px rgba(0, 128, 255, 0.3);
        }
        
        .message.assistant .message-content {
            background: var(--dark-card);
            border: 1px solid var(--glass-border);
            border-bottom-left-radius: 4px;
            border-left: 3px solid var(--current-mode-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .message-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 5px;
            font-size: 0.7em;
            color: rgba(255,255,255,0.5);
            font-family: 'Rajdhani', sans-serif;
        }
        
        .message.user .message-meta {
            justify-content: flex-end;
        }
        
        .message-mode-badge {
            font-family: 'Orbitron', monospace;
            font-size: 0.85em;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        /* Confidence Bar */
        .confidence-bar {
            height: 3px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        .confidence-high .confidence-fill { background: linear-gradient(90deg, var(--neon-green), var(--neon-cyan)); box-shadow: 0 0 10px var(--neon-green); }
        .confidence-medium .confidence-fill { background: linear-gradient(90deg, var(--neon-yellow), #ff9900); box-shadow: 0 0 10px var(--neon-yellow); }
        .confidence-low .confidence-fill { background: linear-gradient(90deg, #ff6666, #ff3333); box-shadow: 0 0 10px #ff6666; }
        
        /* Typing Indicator */
        .typing-indicator {
            display: none;
            align-self: flex-start;
            padding: 20px;
            background: var(--dark-card);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            border-bottom-left-radius: 4px;
        }
        
        .typing-indicator.active {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .typing-dots {
            display: flex;
            gap: 5px;
        }
        
        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--neon-cyan);
            animation: typingBounce 1.4s infinite;
            box-shadow: 0 0 10px var(--neon-cyan);
        }
        
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
        
        .typing-text {
            font-family: 'Orbitron', monospace;
            font-size: 0.75em;
            color: var(--neon-cyan);
            letter-spacing: 1px;
        }
        
        /* Reasoning Preview */
        .reasoning-preview {
            display: none;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75em;
            color: var(--neon-purple);
            padding: 10px 15px;
            background: rgba(128, 0, 255, 0.1);
            border-left: 2px solid var(--neon-purple);
            border-radius: 0 8px 8px 0;
            margin-top: 8px;
        }
        
        .reasoning-preview.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* ============ RESPONSE MODE SELECTOR ============ */
        .response-mode-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            justify-content: center;
        }
        
        .response-mode-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.3);
            color: #888;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .response-mode-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
        }
        
        .response-mode-btn.active {
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
            background: rgba(0, 245, 255, 0.15);
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.3);
        }
        
        .response-mode-btn.eco.active {
            border-color: #00ff66;
            color: #00ff66;
            background: rgba(0, 255, 100, 0.15);
            box-shadow: 0 0 15px rgba(0, 255, 100, 0.3);
        }
        
        .response-mode-btn.fast.active {
            border-color: #ffaa00;
            color: #ffaa00;
            background: rgba(255, 170, 0, 0.15);
            box-shadow: 0 0 15px rgba(255, 170, 0, 0.3);
        }
        
        .response-mode-btn.deep.active {
            border-color: #aa66ff;
            color: #aa66ff;
            background: rgba(170, 100, 255, 0.15);
            box-shadow: 0 0 15px rgba(170, 100, 255, 0.3);
        }
        
        .mode-indicator {
            font-size: 1.1em;
        }
        
        /* ============ INPUT AREA ============ */
        .input-area {
            padding: 20px;
            background: var(--dark-card);
            border-top: 2px solid var(--glass-border);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 8px;
            padding-bottom: 15px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        
        .quick-actions::-webkit-scrollbar { display: none; }
        
        .quick-action {
            padding: 10px 18px;
            background: rgba(0, 245, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            color: var(--neon-cyan);
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }
        
        .quick-action:hover {
            background: rgba(0, 245, 255, 0.15);
            border-color: var(--neon-cyan);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 245, 255, 0.3);
        }
        
        /* Input Wrapper */
        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-container {
            flex: 1;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--glass-border);
            border-radius: 25px;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }
        
        .input-container:focus-within {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 30px rgba(0, 245, 255, 0.2);
        }
        
        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1em;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            outline: none;
            letter-spacing: 0.5px;
        }
        
        textarea::placeholder {
            color: rgba(255,255,255,0.4);
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: rgba(0, 245, 255, 0.1);
            color: var(--neon-cyan);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-btn:hover {
            background: rgba(0, 245, 255, 0.2);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
        }
        
        .action-btn svg {
            width: 20px;
            height: 20px;
        }
        
        /* Camera Button Hover */
        #camera-btn:hover {
            background: rgba(0, 200, 255, 0.3);
            color: #00c8ff;
        }
        
        /* Image Options Popup */
        .image-options-popup {
            position: fixed;
            bottom: 100px;
            right: 30px;
            background: linear-gradient(145deg, rgba(20, 25, 45, 0.98), rgba(30, 40, 60, 0.95));
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 16px;
            padding: 20px;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 30px rgba(0, 245, 255, 0.2);
            backdrop-filter: blur(20px);
            animation: popupSlide 0.3s ease;
        }
        
        @keyframes popupSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .image-options-content h3 {
            margin: 0 0 15px 0;
            font-family: 'Orbitron', monospace;
            font-size: 1em;
            color: var(--neon-cyan);
            text-align: center;
        }
        
        .image-option-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .image-option-btn:hover {
            background: rgba(0, 245, 255, 0.15);
            border-color: rgba(0, 245, 255, 0.4);
            transform: translateX(5px);
        }
        
        .option-icon {
            font-size: 1.5em;
        }
        
        .option-text {
            font-family: 'Orbitron', monospace;
            font-size: 0.9em;
            color: #fff;
            font-weight: 600;
        }
        
        .option-desc {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.5);
            margin-left: auto;
        }
        
        .image-option-close {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            background: rgba(255, 0, 100, 0.2);
            border: 1px solid rgba(255, 0, 100, 0.3);
            border-radius: 8px;
            color: #ff6699;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }
        
        .image-option-close:hover {
            background: rgba(255, 0, 100, 0.4);
        }
        
        /* Image Preview Container */
        #image-preview-container {
            position: relative;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(0, 245, 255, 0.2);
        }
        
        .image-preview-wrapper {
            position: relative;
            display: inline-block;
            max-width: 150px;
            margin-bottom: 10px;
        }
        
        #image-preview {
            max-width: 150px;
            max-height: 100px;
            border-radius: 10px;
            border: 2px solid rgba(0, 245, 255, 0.5);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
        }
        
        .remove-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: rgba(255, 0, 100, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .remove-image-btn:hover {
            background: #ff0066;
            transform: scale(1.1);
        }
        
        .image-question-input {
            width: 100%;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 0.9em;
            outline: none;
        }
        
        .image-question-input:focus {
            border-color: rgba(0, 245, 255, 0.6);
            box-shadow: 0 0 10px rgba(0, 245, 255, 0.2);
        }
        
        .image-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .image-input-row .image-question-input {
            flex: 1;
        }
        
        .send-image-btn {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, rgba(0, 245, 255, 0.3), rgba(0, 200, 255, 0.2));
            color: var(--neon-cyan);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .send-image-btn:hover {
            background: rgba(0, 245, 255, 0.5);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
            transform: scale(1.05);
        }
        
        .send-image-btn svg {
            width: 20px;
            height: 20px;
        }
        
        /* Voice Button States */
        .action-btn.listening {
            background: rgba(255, 0, 100, 0.3);
            color: #ff0066;
            animation: voicePulse 1s ease-in-out infinite;
            box-shadow: 0 0 30px rgba(255, 0, 100, 0.5);
        }
        
        @keyframes voicePulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 0, 100, 0.5); }
            50% { transform: scale(1.15); box-shadow: 0 0 40px rgba(255, 0, 100, 0.8); }
        }
        
        /* Voice Status Bar */
        .voice-status-bar {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px 20px;
            background: linear-gradient(135deg, rgba(255, 0, 100, 0.2), rgba(0, 245, 255, 0.1));
            border-bottom: 1px solid rgba(255, 0, 100, 0.3);
            font-family: 'Orbitron', monospace;
            font-size: 0.8em;
            letter-spacing: 1px;
            animation: fadeIn 0.3s ease;
        }
        
        .voice-status-bar.active {
            display: flex;
        }
        
        .voice-wave {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 20px;
        }
        
        .voice-wave span {
            width: 3px;
            background: var(--neon-magenta);
            border-radius: 2px;
            animation: waveAnim 0.5s ease-in-out infinite;
        }
        
        .voice-wave span:nth-child(1) { height: 8px; animation-delay: 0s; }
        .voice-wave span:nth-child(2) { height: 16px; animation-delay: 0.1s; }
        .voice-wave span:nth-child(3) { height: 12px; animation-delay: 0.2s; }
        .voice-wave span:nth-child(4) { height: 20px; animation-delay: 0.3s; }
        .voice-wave span:nth-child(5) { height: 10px; animation-delay: 0.4s; }
        
        @keyframes waveAnim {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.5); }
        }
        
        .voice-transcript {
            color: var(--neon-cyan);
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* TTS Speaking Indicator */
        .avatar.speaking {
            animation: speakingPulse 0.5s ease-in-out infinite !important;
        }
        
        @keyframes speakingPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px var(--neon-green); }
            50% { transform: scale(1.08); box-shadow: 0 0 50px var(--neon-green), 0 0 80px var(--neon-cyan); }
        }
        
        /* Hands-free Toggle */
        .handsfree-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Orbitron', monospace;
            font-size: 0.65em;
            color: rgba(255,255,255,0.6);
            letter-spacing: 1px;
        }
        
        .handsfree-toggle:hover {
            border-color: var(--neon-green);
            color: var(--neon-green);
        }
        
        .handsfree-toggle.active {
            background: rgba(0, 255, 136, 0.2);
            border-color: var(--neon-green);
            color: var(--neon-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }
        
        .handsfree-toggle .toggle-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }
        
        .handsfree-toggle.active .toggle-dot {
            background: var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green);
        }
        
        /* TTS Toggle */
        .tts-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: rgba(0, 245, 255, 0.1);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Orbitron', monospace;
            font-size: 0.65em;
            color: rgba(255,255,255,0.6);
            letter-spacing: 1px;
        }
        
        .tts-toggle:hover {
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
        }
        
        .tts-toggle.active {
            background: rgba(0, 245, 255, 0.2);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
        }
        
        .tts-toggle .toggle-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }
        
        .tts-toggle.active .toggle-dot {
            background: var(--neon-cyan);
            box-shadow: 0 0 10px var(--neon-cyan);
        }
        
        .tts-toggle.speaking .toggle-dot {
            animation: pulse-speaking 0.5s ease-in-out infinite;
        }
        
        @keyframes pulse-speaking {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
        }
        
        .tts-toggle.no-voices {
            background: rgba(255, 100, 100, 0.2);
            border-color: #ff6666;
            color: #ff6666;
        }
        
        .tts-status-indicator {
            position: fixed;
            top: 70px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--neon-cyan);
            border-radius: 8px;
            font-family: 'Orbitron', monospace;
            font-size: 0.7em;
            color: var(--neon-cyan);
            z-index: 1000;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tts-status-indicator.visible {
            display: block;
        }
        
        .tts-status-indicator.error {
            border-color: #ff6666;
            color: #ff6666;
        }
        
        .tts-status-indicator.speaking {
            border-color: var(--neon-green);
            color: var(--neon-green);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .stop-speech-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            border: none;
            border-radius: 20px;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }
        
        .stop-speech-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
        }
        
        .stop-speech-btn.active {
            display: flex;
            align-items: center;
            gap: 5px;
            animation: pulseRed 1s infinite;
        }
        
        @keyframes pulseRed {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 68, 68, 0.4); }
            50% { box-shadow: 0 0 20px rgba(255, 68, 68, 0.8); }
        }
        
        /* Debug Button */
        .debug-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #ff9800, #f57c00);
            border: none;
            border-radius: 20px;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .debug-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.5);
        }
        
        .debug-btn.active {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }
        
        /* Debug Panel */
        .debug-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 400px;
            max-height: calc(100vh - 120px);
            background: rgba(15, 15, 25, 0.98);
            border: 2px solid #ff9800;
            border-radius: 15px;
            z-index: 1000;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(255, 152, 0, 0.3);
            backdrop-filter: blur(20px);
            overflow: hidden;
        }
        
        .debug-panel.active {
            display: flex;
            animation: slideIn 0.3s ease;
        }
        
        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.2), rgba(245, 124, 0, 0.1));
            border-bottom: 1px solid rgba(255, 152, 0, 0.3);
        }
        
        .debug-header h3 {
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            color: #ff9800;
            letter-spacing: 2px;
        }
        
        .close-debug {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .close-debug:hover {
            background: rgba(255, 68, 68, 0.4);
            transform: scale(1.1);
        }
        
        .debug-content {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }
        
        .debug-section {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255, 152, 0, 0.05);
            border: 1px solid rgba(255, 152, 0, 0.2);
            border-radius: 10px;
        }
        
        .debug-section h4 {
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
            color: #ff9800;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        
        .debug-section p {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .debug-section span {
            color: #00f5ff;
        }
        
        .debug-log {
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
        }
        
        .debug-log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
        }
        
        .debug-log-entry.error {
            color: #ff4444;
        }
        
        .debug-log-entry.success {
            color: #00ff88;
        }
        
        .debug-log-entry.info {
            color: #00f5ff;
        }
        
        .debug-log-entry .timestamp {
            color: rgba(255, 255, 255, 0.4);
            margin-right: 8px;
        }
        
        .debug-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 15px;
            border-top: 1px solid rgba(255, 152, 0, 0.2);
        }
        
        .debug-actions button {
            flex: 1;
            min-width: 80px;
            padding: 8px 12px;
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.3);
            border-radius: 8px;
            color: #ff9800;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .debug-actions button:hover {
            background: rgba(255, 152, 0, 0.2);
            transform: translateY(-2px);
        }
        
        /* STOP Button */
        .stop-btn {
            width: 55px;
            height: 55px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(255, 68, 68, 0.4);
            animation: stopPulse 1s infinite;
        }
        
        .stop-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(255, 68, 68, 0.6);
        }
        
        .stop-btn svg {
            width: 24px;
            height: 24px;
        }
        
        .stop-btn.active {
            display: flex;
        }
        
        @keyframes stopPulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(255, 68, 68, 0.4); }
            50% { box-shadow: 0 6px 25px rgba(255, 68, 68, 0.8); }
        }
        
        .send-btn {
            width: 55px;
            height: 55px;
            min-width: 55px;
            min-height: 55px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-blue));
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 245, 255, 0.4);
            flex-shrink: 0;
        }
        
        .send-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(0, 245, 255, 0.6);
        }
        
        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        .send-btn svg {
            width: 24px;
            height: 24px;
        }
        
        .send-btn.hidden {
            display: none;
        }
        
        /* Code blocks */
        code {
            font-family: 'JetBrains Mono', monospace;
            background: rgba(0, 245, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--neon-cyan);
            font-size: 0.9em;
        }
        
        /* ============ AUTOMATION PANEL ============ */
        .automation-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 380px;
            height: 100vh;
            background: rgba(10, 10, 20, 0.98);
            border-left: 2px solid var(--neon-cyan);
            box-shadow: -10px 0 50px rgba(0, 245, 255, 0.2);
            z-index: 1000;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .automation-panel.active {
            right: 0;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(180deg, rgba(0, 245, 255, 0.1), transparent);
            border-bottom: 1px solid var(--glass-border);
        }
        
        .panel-header h3 {
            font-family: 'Orbitron', monospace;
            color: var(--neon-cyan);
            letter-spacing: 2px;
            font-size: 1em;
        }
        
        .close-panel {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 100, 100, 0.2);
            color: #ff6666;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .close-panel:hover {
            background: rgba(255, 100, 100, 0.4);
            transform: rotate(90deg);
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .panel-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 245, 255, 0.03);
            border: 1px solid rgba(0, 245, 255, 0.1);
            border-radius: 12px;
        }
        
        .panel-section h4 {
            font-family: 'Rajdhani', sans-serif;
            color: var(--neon-cyan);
            margin-bottom: 12px;
            font-size: 0.9em;
            letter-spacing: 1px;
        }
        
        .panel-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .panel-btn {
            padding: 10px 12px;
            background: rgba(0, 245, 255, 0.08);
            border: 1px solid rgba(0, 245, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .panel-btn:hover {
            background: rgba(0, 245, 255, 0.2);
            border-color: var(--neon-cyan);
            transform: translateX(3px);
        }
        
        .emergency-section {
            background: rgba(255, 50, 50, 0.05);
            border-color: rgba(255, 50, 50, 0.3);
        }
        
        .emergency-section h4 {
            color: #ff6666;
        }
        
        .emergency-btn {
            background: rgba(255, 50, 50, 0.1);
            border-color: rgba(255, 50, 50, 0.3);
            color: #ff6666;
        }
        
        .emergency-btn:hover {
            background: rgba(255, 50, 50, 0.3);
            border-color: #ff6666;
        }
        
        .success-btn {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.3);
            color: var(--neon-green);
        }
        
        .success-btn:hover {
            background: rgba(0, 255, 136, 0.3);
            border-color: var(--neon-green);
        }

        /* ============ SECURITY SECTION ============ */
        .security-section {
            background: linear-gradient(135deg, rgba(255, 204, 0, 0.08), rgba(255, 150, 0, 0.05));
            border-color: rgba(255, 204, 0, 0.4);
        }
        
        .security-section h4 {
            color: #ffcc00;
        }
        
        .security-section .panel-btn {
            background: rgba(255, 204, 0, 0.1);
            border-color: rgba(255, 204, 0, 0.3);
            color: #ffdd55;
        }
        
        .security-section .panel-btn:hover {
            background: rgba(255, 204, 0, 0.25);
            border-color: #ffcc00;
            box-shadow: 0 0 12px rgba(255, 204, 0, 0.3);
        }

        /* ============ HEALTH SECTION ============ */
        .health-section {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.08), rgba(0, 200, 100, 0.05));
            border-color: rgba(0, 255, 136, 0.4);
        }
        
        .health-section h4 {
            color: #00ff88;
        }
        
        .health-section .panel-btn {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.3);
            color: #66ffaa;
        }
        
        .health-section .panel-btn:hover {
            background: rgba(0, 255, 136, 0.25);
            border-color: #00ff88;
            box-shadow: 0 0 12px rgba(0, 255, 136, 0.3);
        }

        /* ============ PREVENTION SECTION ============ */
        .prevention-section {
            background: linear-gradient(135deg, rgba(0, 150, 255, 0.08), rgba(0, 100, 200, 0.05));
            border-color: rgba(0, 150, 255, 0.4);
        }
        
        .prevention-section h4 {
            color: #00aaff;
        }
        
        .prevention-section .panel-btn {
            background: rgba(0, 150, 255, 0.1);
            border-color: rgba(0, 150, 255, 0.3);
            color: #66ccff;
        }
        
        .prevention-section .panel-btn:hover {
            background: rgba(0, 150, 255, 0.25);
            border-color: #00aaff;
            box-shadow: 0 0 12px rgba(0, 150, 255, 0.3);
        }

        /* ============ WORKFLOWS SECTION ============ */
        .workflows-section {
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.08), rgba(200, 0, 200, 0.05));
            border-color: rgba(255, 0, 255, 0.4);
        }
        
        .workflows-section h4 {
            color: #ff66ff;
        }
        
        .workflows-section .panel-btn {
            background: rgba(255, 0, 255, 0.1);
            border-color: rgba(255, 0, 255, 0.3);
            color: #ff99ff;
        }
        
        .workflows-section .panel-btn:hover {
            background: rgba(255, 0, 255, 0.25);
            border-color: #ff66ff;
            box-shadow: 0 0 12px rgba(255, 0, 255, 0.3);
        }

        /* ============ CYBERSECURITY SECTION ============ */
        .cyber-section {
            background: linear-gradient(135deg, rgba(255, 0, 80, 0.08), rgba(200, 0, 60, 0.05));
            border-color: rgba(255, 0, 80, 0.4);
        }
        
        .cyber-section h4 {
            color: #ff3366;
        }
        
        .cyber-section .panel-btn {
            background: rgba(255, 0, 80, 0.1);
            border-color: rgba(255, 0, 80, 0.3);
            color: #ff6699;
        }
        
        .cyber-section .panel-btn:hover {
            background: rgba(255, 0, 80, 0.25);
            border-color: #ff3366;
            box-shadow: 0 0 12px rgba(255, 0, 80, 0.4);
        }

        /* ============ MILITARY SECTION ============ */
        .military-section {
            background: linear-gradient(135deg, rgba(100, 100, 100, 0.15), rgba(50, 50, 50, 0.1));
            border-color: rgba(180, 180, 180, 0.4);
        }
        
        .military-section h4 {
            color: #cccccc;
        }
        
        .military-section .panel-btn {
            background: rgba(100, 100, 100, 0.15);
            border-color: rgba(150, 150, 150, 0.3);
            color: #dddddd;
        }
        
        .military-section .panel-btn:hover {
            background: rgba(150, 150, 150, 0.25);
            border-color: #aaaaaa;
            box-shadow: 0 0 12px rgba(200, 200, 200, 0.3);
        }

        /* ============ SCIENCE SECTION ============ */
        .science-section {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.08), rgba(75, 0, 130, 0.05));
            border-color: rgba(138, 43, 226, 0.4);
        }
        
        .science-section h4 {
            color: #aa66ff;
        }
        
        .science-section .panel-btn {
            background: rgba(138, 43, 226, 0.1);
            border-color: rgba(138, 43, 226, 0.3);
            color: #cc99ff;
        }
        
        .science-section .panel-btn:hover {
            background: rgba(138, 43, 226, 0.25);
            border-color: #aa66ff;
            box-shadow: 0 0 12px rgba(138, 43, 226, 0.4);
        }

        /* ============ MEDICAL SECTION ============ */
        .medical-section {
            background: linear-gradient(135deg, rgba(255, 100, 100, 0.08), rgba(200, 50, 50, 0.05));
            border-color: rgba(255, 100, 100, 0.4);
        }
        
        .medical-section h4 {
            color: #ff7777;
        }
        
        .medical-section .panel-btn {
            background: rgba(255, 100, 100, 0.1);
            border-color: rgba(255, 100, 100, 0.3);
            color: #ffaaaa;
        }
        
        .medical-section .panel-btn:hover {
            background: rgba(255, 100, 100, 0.25);
            border-color: #ff7777;
            box-shadow: 0 0 12px rgba(255, 100, 100, 0.4);
        }

        /* ============ MONITOR SECTION ============ */
        .monitor-section {
            background: linear-gradient(135deg, rgba(0, 200, 255, 0.08), rgba(0, 150, 200, 0.05));
            border-color: rgba(0, 200, 255, 0.4);
        }
        
        .monitor-section h4 {
            color: #00ccff;
        }
        
        .monitor-section .panel-btn {
            background: rgba(0, 200, 255, 0.1);
            border-color: rgba(0, 200, 255, 0.3);
            color: #66ddff;
        }
        
        .monitor-section .panel-btn:hover {
            background: rgba(0, 200, 255, 0.25);
            border-color: #00ccff;
            box-shadow: 0 0 12px rgba(0, 200, 255, 0.4);
        }

        /* ============ WORK/PRODUCTIVITY SECTION ============ */
        .work-section {
            background: linear-gradient(135deg, rgba(255, 200, 0, 0.08), rgba(200, 150, 0, 0.05));
            border-color: rgba(255, 200, 0, 0.4);
        }
        
        .work-section h4 {
            color: #ffcc00;
        }
        
        .work-section .panel-btn {
            background: rgba(255, 200, 0, 0.1);
            border-color: rgba(255, 200, 0, 0.3);
            color: #ffdd66;
        }
        
        .work-section .panel-btn:hover {
            background: rgba(255, 200, 0, 0.25);
            border-color: #ffcc00;
            box-shadow: 0 0 12px rgba(255, 200, 0, 0.4);
        }

        /* Resources Section */
        .resources-section {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 95, 70, 0.1));
            border-color: rgba(16, 185, 129, 0.4);
        }
        
        .resources-section h4 {
            color: #10b981;
        }
        
        .resources-section .panel-btn {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: #6ee7b7;
        }
        
        .resources-section .panel-btn:hover {
            background: rgba(16, 185, 129, 0.25);
            border-color: #10b981;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
        }

        /* Archaeology Section */
        .archaeology-section {
            background: linear-gradient(135deg, rgba(180, 130, 70, 0.1), rgba(139, 90, 43, 0.1));
            border-color: rgba(180, 130, 70, 0.4);
        }
        
        .archaeology-section h4 {
            color: #d4a574;
        }
        
        .archaeology-section .panel-btn {
            background: rgba(180, 130, 70, 0.1);
            border-color: rgba(180, 130, 70, 0.3);
            color: #e8c49a;
        }
        
        .archaeology-section .panel-btn:hover {
            background: rgba(180, 130, 70, 0.25);
            border-color: #d4a574;
            box-shadow: 0 0 12px rgba(180, 130, 70, 0.4);
        }

        /* Enhanced Tooltip System */
        .panel-btn[data-tooltip] {
            position: relative;
        }
        
        .panel-btn[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-family: 'Rajdhani', sans-serif;
            white-space: normal;
            width: 220px;
            text-align: left;
            line-height: 1.4;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            border: 1px solid var(--neon-cyan);
            box-shadow: 0 5px 20px rgba(0, 245, 255, 0.2);
            pointer-events: none;
        }
        
        .panel-btn[data-tooltip]::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--neon-cyan);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1001;
        }
        
        .panel-btn[data-tooltip]:hover::after,
        .panel-btn[data-tooltip]:hover::before {
            opacity: 1;
            visibility: visible;
        }

        /* ============ AI HUB SECTION ============ */
        .ai-hub-section {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.1), rgba(0, 191, 255, 0.1));
            border-color: rgba(138, 43, 226, 0.4);
        }
        
        .ai-hub-section h4 {
            color: #9f7aea;
            background: linear-gradient(90deg, #9f7aea, #00bfff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .ai-btn {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.2), rgba(0, 191, 255, 0.2));
            border-color: rgba(138, 43, 226, 0.4);
            color: #c4b5fd;
        }
        
        .ai-btn:hover {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.4), rgba(0, 191, 255, 0.4));
            border-color: #9f7aea;
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.4);
            transform: translateY(-2px);
        }
        
        /* AI Hub Modal */
        .ai-hub-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        
        .ai-hub-modal.active {
            display: flex;
        }
        
        .ai-hub-content {
            background: linear-gradient(145deg, rgba(20, 25, 45, 0.98), rgba(30, 40, 60, 0.95));
            border: 2px solid rgba(138, 43, 226, 0.5);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .ai-hub-content h2 {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(90deg, #9f7aea, #00bfff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .ai-hub-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .ai-hub-form label {
            color: #c4b5fd;
            font-size: 0.9em;
        }
        
        .ai-hub-form input,
        .ai-hub-form textarea,
        .ai-hub-form select {
            background: rgba(138, 43, 226, 0.1);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 10px;
            padding: 12px;
            color: white;
            font-size: 1em;
        }
        
        .ai-hub-form textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .ai-hub-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .ai-hub-submit {
            background: linear-gradient(135deg, #9f7aea, #00bfff);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .ai-hub-submit:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.5);
        }
        
        .ai-hub-cancel {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6666;
            border: 1px solid rgba(255, 100, 100, 0.3);
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
        }

        /* ============ PILOT DIALOG ============ */
        .pilot-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .pilot-dialog.active {
            display: flex;
        }
        
        .pilot-dialog-content {
            background: var(--dark-card);
            border: 2px solid var(--neon-green);
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 60px rgba(0, 255, 136, 0.3);
            animation: dialogSlide 0.4s ease;
        }
        
        @keyframes dialogSlide {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .pilot-dialog-content h3 {
            font-family: 'Orbitron', monospace;
            color: var(--neon-green);
            margin-bottom: 15px;
            letter-spacing: 2px;
        }
        
        .pilot-dialog-content p {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 20px;
            font-size: 0.95em;
        }
        
        .pilot-dialog-content input {
            width: 100%;
            padding: 15px 20px;
            background: rgba(0, 255, 136, 0.05);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1em;
            outline: none;
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 1px;
        }
        
        .pilot-dialog-content input:focus {
            border-color: var(--neon-green);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }
        
        .pilot-dialog-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .pilot-cancel, .pilot-confirm {
            padding: 12px 30px;
            border-radius: 25px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid;
        }
        
        .pilot-cancel {
            background: transparent;
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.7);
        }
        
        .pilot-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #fff;
            color: #fff;
        }
        
        .pilot-confirm {
            background: var(--neon-green);
            border-color: var(--neon-green);
            color: #000;
        }
        
        .pilot-confirm:hover {
            background: transparent;
            color: var(--neon-green);
            box-shadow: 0 0 25px rgba(0, 255, 136, 0.5);
        }
        
        .pilot-hint {
            margin-top: 15px;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.4);
        }
        
        /* Result popup */
        .result-popup {
            position: fixed;
            bottom: 100px;
            right: 20px;
            max-width: 400px;
            padding: 15px 20px;
            background: var(--dark-card);
            border: 1px solid var(--neon-cyan);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 245, 255, 0.2);
            z-index: 500;
            animation: slideInRight 0.3s ease;
        }
        
        .result-popup.success {
            border-color: var(--neon-green);
        }
        
        .result-popup.error {
            border-color: #ff6666;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-name { font-size: 1em; }
            .mode-selector { display: none; }
            .stats-bar { gap: 15px; font-size: 0.6em; }
            .message { max-width: 90%; }
            .welcome-title { font-size: 1.5em; }
            .automation-panel { width: 100%; right: -100%; }
        }
    </style>
</head>
<body>
    <div class="orb-2"></div>
    
    <!-- ============ GIDEON TOOLS SIDEBAR ============ -->
    <aside class="gideon-toolbar" id="gideon-toolbar">
        <button class="toolbar-toggle" onclick="toggleToolbar()">
            <span>ðŸ› ï¸</span>
            <span class="toggle-text">GIDEON TOOLS</span>
        </button>
        
        <!-- SICUREZZA -->
        <div class="toolbar-section security" id="section-security">
            <div class="toolbar-section-header" onclick="toggleSection('security')">
                <span class="icon">ðŸ”’</span>
                <span class="label">Sicurezza</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="toolbar-section-content">
                <button class="toolbar-btn" onclick="runGideonTool('security', 'full_scan')">
                    <span class="btn-icon">ðŸ”</span> Scansione Completa
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('security', 'vuln_check')">
                    <span class="btn-icon">âš ï¸</span> Verifica VulnerabilitÃ 
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('security', 'firewall')">
                    <span class="btn-icon">ðŸ›¡ï¸</span> Stato Firewall
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('security', 'audit')">
                    <span class="btn-icon">ðŸ“‹</span> Audit Sistema
                </button>
                <div class="toolbar-divider"></div>
                <div class="toolbar-label">ðŸš€ Avanzato</div>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('security', 'predictive_risk_mapping')" title="Mappa predittiva dei rischi con cause e probabilitÃ ">
                    <span class="btn-icon">ðŸ—ºï¸</span> Risk Mapping
                </button>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('security', 'anomaly_narrator')" title="Narrativa anomalie leggibile per tutti">
                    <span class="btn-icon">ðŸ“–</span> Anomaly Narrator
                </button>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('security', 'defensive_scenario_simulator')" title="Simulatore scenari difensivi per training">
                    <span class="btn-icon">ðŸŽ®</span> Scenario Sim
                </button>
            </div>
        </div>
        
        <!-- SANITÃ€ -->
        <div class="toolbar-section health" id="section-health">
            <div class="toolbar-section-header" onclick="toggleSection('health')">
                <span class="icon">ðŸ’Š</span>
                <span class="label">SanitÃ </span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="toolbar-section-content">
                <button class="toolbar-btn" onclick="runGideonTool('health', 'diagnostics')">
                    <span class="btn-icon">ðŸ©º</span> Diagnostica Sintomi
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('health', 'medications')">
                    <span class="btn-icon">ðŸ’‰</span> Info Farmaci
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('health', 'wellness')">
                    <span class="btn-icon">â¤ï¸</span> Benessere
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('health', 'emergency')">
                    <span class="btn-icon">ðŸš‘</span> Emergenza
                </button>
            </div>
        </div>
        
        <!-- SCIENZA -->
        <div class="toolbar-section science" id="section-science">
            <div class="toolbar-section-header" onclick="toggleSection('science')">
                <span class="icon">ðŸ”¬</span>
                <span class="label">Scienza</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="toolbar-section-content">
                <button class="toolbar-btn" onclick="runGideonTool('science', 'research')">
                    <span class="btn-icon">ðŸ“š</span> Ricerca Articoli
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('science', 'physics')">
                    <span class="btn-icon">âš›ï¸</span> Fisica
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('science', 'biology')">
                    <span class="btn-icon">ðŸ§¬</span> Biologia
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('science', 'simulation')">
                    <span class="btn-icon">ðŸ“Š</span> Simulazioni
                </button>
                <div class="toolbar-divider"></div>
                <div class="toolbar-label">ðŸ§¬ Avanzato (SAFE MODE)</div>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('science', 'molecular_pattern_validator', {molecule_query: 'water'})" title="Analisi molecolare per stabilitÃ  - NO SINTESI">
                    <span class="btn-icon">ðŸ”¬</span> Molecular Validator
                </button>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('science', 'environmental_contamination_scan', {medium: 'air'})" title="Scansione contaminazione aria/acqua/suolo">
                    <span class="btn-icon">ðŸŒ</span> Contamination Scan
                </button>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('science', 'scientific_cross_check', {claim: 'Test claim', field: 'general'})" title="Verifica claim vs letteratura scientifica">
                    <span class="btn-icon">âœ…</span> Cross-Check
                </button>
            </div>
        </div>
        
        <!-- CHIMICA -->
        <div class="toolbar-section chemistry" id="section-chemistry">
            <div class="toolbar-section-header" onclick="toggleSection('chemistry')">
                <span class="icon">ðŸ§ª</span>
                <span class="label">Chimica</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="toolbar-section-content">
                <button class="toolbar-btn" onclick="runGideonTool('chemistry', 'compounds')">
                    <span class="btn-icon">âš—ï¸</span> Analisi Composti
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('chemistry', 'reactions')">
                    <span class="btn-icon">ðŸ’¥</span> Reazioni Chimiche
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('chemistry', 'periodic')">
                    <span class="btn-icon">ðŸ“‹</span> Tavola Periodica
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('chemistry', 'molecular')">
                    <span class="btn-icon">ðŸ”—</span> Modelli Molecolari
                </button>
            </div>
        </div>
        
        <!-- ARCHEOLOGIA -->
        <div class="toolbar-section archaeology" id="section-archaeology">
            <div class="toolbar-section-header" onclick="toggleSection('archaeology')">
                <span class="icon">ðŸ›ï¸</span>
                <span class="label">Archeologia</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="toolbar-section-content">
                <button class="toolbar-btn" onclick="runGideonTool('archaeology', 'artifacts')">
                    <span class="btn-icon">ðŸº</span> Catalogo Reperti
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('archaeology', 'dating')">
                    <span class="btn-icon">ðŸ“…</span> Datazione
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('archaeology', 'civilizations')">
                    <span class="btn-icon">ðŸ—¿</span> CiviltÃ  Antiche
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('archaeology', 'sites')">
                    <span class="btn-icon">ðŸ—ºï¸</span> Siti Archeologici
                </button>
                <div class="toolbar-divider"></div>
                <div class="toolbar-label">ðŸ›ï¸ Avanzato</div>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('archaeology', 'predictive_reconstruction', {artifact_description: 'Unknown artifact'})" title="Ricostruzione 3D con livelli incertezza">
                    <span class="btn-icon">ðŸ”®</span> Reconstruction
                </button>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('archaeology', 'temporal_layer_fusion', {subject: 'Test subject'})" title="Fonde testi, immagini, dati geologici">
                    <span class="btn-icon">ðŸ“œ</span> Layer Fusion
                </button>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('archaeology', 'authenticity_risk_assessment', {artifact_id: 'test_001'})" title="Valuta probabilitÃ  falso/errore">
                    <span class="btn-icon">ðŸ”</span> Authenticity Check
                </button>
            </div>
        </div>
        
        <!-- MILITARE -->
        <div class="toolbar-section military" id="section-military">
            <div class="toolbar-section-header" onclick="toggleSection('military')">
                <span class="icon">âš”ï¸</span>
                <span class="label">Militare</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="toolbar-section-content">
                <button class="toolbar-btn" onclick="runGideonTool('military', 'strategy')">
                    <span class="btn-icon">ðŸ“‹</span> Strategia
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('military', 'intel')">
                    <span class="btn-icon">ðŸ”</span> Intelligence
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('military', 'logistics')">
                    <span class="btn-icon">ðŸ“¦</span> Logistica
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('military', 'defense')">
                    <span class="btn-icon">ðŸ›¡ï¸</span> Difesa
                </button>
            </div>
        </div>
        
        <!-- MONITORAGGIO -->
        <div class="toolbar-section monitor" id="section-monitor">
            <div class="toolbar-section-header" onclick="toggleSection('monitor')">
                <span class="icon">ðŸ“Š</span>
                <span class="label">Monitoraggio</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="toolbar-section-content">
                <button class="toolbar-btn" onclick="runGideonTool('monitor', 'system')">
                    <span class="btn-icon">ðŸ’»</span> Sistema
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('monitor', 'network')">
                    <span class="btn-icon">ðŸŒ</span> Rete
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('monitor', 'performance')">
                    <span class="btn-icon">ðŸ“ˆ</span> Performance
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('monitor', 'logs')">
                    <span class="btn-icon">ðŸ“œ</span> Logs
                </button>
            </div>
        </div>
        
        <!-- CYBERSECURITY -->
        <div class="toolbar-section cyber" id="section-cyber">
            <div class="toolbar-section-header" onclick="toggleSection('cyber')">
                <span class="icon">ï¿½ï¸</span>
                <span class="label">Cybersecurity</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="toolbar-section-content">
                <button class="toolbar-btn" onclick="runGideonTool('cyber', 'threat_scan')">
                    <span class="btn-icon">ðŸ”´</span> Scan Minacce
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('cyber', 'intrusion')">
                    <span class="btn-icon">ðŸš¨</span> Detect Intrusioni
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('cyber', 'encryption')">
                    <span class="btn-icon">ðŸ”</span> Crittografia
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('cyber', 'pentest')">
                    <span class="btn-icon">ðŸ’€</span> Penetration Test
                </button>
                <div class="toolbar-divider"></div>
                <div class="toolbar-label">ðŸš€ Avanzato (AI-SOC)</div>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('cyber', 'behavioral_baseline_builder')" title="Costruisce baseline comportamentale per anomaly detection">
                    <span class="btn-icon">ðŸ“Š</span> Behavioral Baseline
                </button>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('cyber', 'incident_explainability_engine')" title="Spiega incidenti a tecnici, manager e operatori">
                    <span class="btn-icon">ðŸ“–</span> Incident Explainer
                </button>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('cyber', 'supply_chain_trust_scanner')" title="Scansiona supply chain per rischi dipendenze">
                    <span class="btn-icon">ðŸ”—</span> Supply Chain Trust
                </button>
            </div>
        </div>
        
        <!-- ANALISI -->
        <div class="toolbar-section analysis" id="section-analysis">
            <div class="toolbar-section-header" onclick="toggleSection('analysis')">
                <span class="icon">ðŸ“ˆ</span>
                <span class="label">Analisi</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="toolbar-section-content">
                <button class="toolbar-btn" onclick="runGideonTool('analysis', 'text')">
                    <span class="btn-icon">ðŸ“</span> Analisi Testo
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('analysis', 'sentiment')">
                    <span class="btn-icon">ðŸ˜Š</span> Sentiment Analysis
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('analysis', 'summary')">
                    <span class="btn-icon">ðŸ“‹</span> Riassunto Auto
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('analysis', 'translate')">
                    <span class="btn-icon">ðŸŒ</span> Traduci
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('analysis', 'code')">
                    <span class="btn-icon">ðŸ’»</span> Analisi Codice
                </button>
            </div>
        </div>
        
        <!-- UTILITÃ€ -->
        <div class="toolbar-section utilities" id="section-utilities">
            <div class="toolbar-section-header" onclick="toggleSection('utilities')">
                <span class="icon">ðŸ› ï¸</span>
                <span class="label">UtilitÃ </span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="toolbar-section-content">
                <button class="toolbar-btn" onclick="runGideonTool('utilities', 'calculator')">
                    <span class="btn-icon">ðŸ§®</span> Calcolatrice
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('utilities', 'converter')">
                    <span class="btn-icon">ðŸ”„</span> Convertitore
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('utilities', 'timer')">
                    <span class="btn-icon">â°</span> Timer/Promemoria
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('utilities', 'weather')">
                    <span class="btn-icon">ðŸŒ¤ï¸</span> Meteo
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('utilities', 'qrcode')">
                    <span class="btn-icon">ðŸ“±</span> QR Code
                </button>
            </div>
        </div>
        
        <!-- AI TOOLS -->
        <div class="toolbar-section ai" id="section-ai">
            <div class="toolbar-section-header" onclick="toggleSection('ai')">
                <span class="icon">ðŸ¤–</span>
                <span class="label">AI Tools</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="toolbar-section-content">
                <button class="toolbar-btn" onclick="runGideonTool('ai', 'image_gen')">
                    <span class="btn-icon">ðŸŽ¨</span> Genera Immagine
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('ai', 'image_analyze')">
                    <span class="btn-icon">ðŸ‘ï¸</span> Analizza Immagine
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('ai', 'voice')">
                    <span class="btn-icon">ðŸŽ¤</span> Voice Assistant
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('ai', 'reasoning')">
                    <span class="btn-icon">ðŸ§ </span> Deep Reasoning
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('ai', 'creative')">
                    <span class="btn-icon">âœ¨</span> Scrittura Creativa
                </button>
            </div>
        </div>
        
        <!-- DATA -->
        <div class="toolbar-section data" id="section-data">
            <div class="toolbar-section-header" onclick="toggleSection('data')">
                <span class="icon">ðŸ’¾</span>
                <span class="label">Dati</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="toolbar-section-content">
                <button class="toolbar-btn" onclick="runGideonTool('data', 'export')">
                    <span class="btn-icon">ðŸ“¤</span> Esporta Chat
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('data', 'import')">
                    <span class="btn-icon">ðŸ“¥</span> Importa Dati
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('data', 'backup')">
                    <span class="btn-icon">ðŸ’¿</span> Backup
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('data', 'history')">
                    <span class="btn-icon">ðŸ“œ</span> Cronologia
                </button>
                <button class="toolbar-btn" onclick="runGideonTool('data', 'settings')">
                    <span class="btn-icon">âš™ï¸</span> Impostazioni
                </button>
            </div>
        </div>
        
        <!-- GIDEON CORE - Sistema Centrale -->
        <div class="toolbar-section core" id="section-core">
            <div class="toolbar-section-header" onclick="toggleSection('core')">
                <span class="icon">ðŸ§ </span>
                <span class="label">GIDEON Core</span>
                <span class="arrow">â–¼</span>
            </div>
            <div class="toolbar-section-content">
                <div class="toolbar-label">ðŸ”„ Reasoning</div>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('core', 'multi_tool_reasoning', {query: 'Analisi sistema corrente'})" title="Interroga piÃ¹ tool, confronta risultati, segnala conflitti">
                    <span class="btn-icon">ðŸ”„</span> Multi-Tool Reasoning
                </button>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('core', 'confidence_weighted_output', {content: 'Test', analysis_type: 'system'})" title="Output con confidenza, fonti e limiti noti">
                    <span class="btn-icon">ðŸ“Š</span> Confidence Output
                </button>
                <div class="toolbar-divider"></div>
                <div class="toolbar-label">ðŸ›¡ï¸ Safety</div>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('core', 'human_override_gate', {gate_action: 'test', action_details: {}})" title="Gate umano per azioni critiche">
                    <span class="btn-icon">ðŸš¦</span> Human Gate
                </button>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('core', 'failsafe_trigger', {reason: 'Test manuale'})" title="Attiva failsafe di emergenza">
                    <span class="btn-icon">ðŸ›‘</span> Failsafe
                </button>
                <div class="toolbar-divider"></div>
                <div class="toolbar-label">ðŸ“‹ Audit</div>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('core', 'audit_trail', {limit: 50})" title="Log completo azioni">
                    <span class="btn-icon">ðŸ“</span> Audit Trail
                </button>
                <button class="toolbar-btn advanced" onclick="executeAdvancedTool('core', 'bias_and_drift_monitor')" title="Auto-diagnosi bias e deriva">
                    <span class="btn-icon">âš–ï¸</span> Bias Monitor
                </button>
            </div>
        </div>
    </aside>
    
    <!-- Loading Overlay for Toolbar -->
    <div class="toolbar-loading" id="toolbar-loading">
        <div class="spinner"></div>
        <span class="loading-text" id="loading-text">Elaborazione in corso...</span>
    </div>
    
    <!-- Results Panel -->
    <div class="results-panel" id="results-panel">
        <div class="results-header">
            <h3 id="results-title">ðŸ“Š Risultati Analisi</h3>
            <button class="results-close" onclick="closeResultsPanel()">âœ•</button>
        </div>
        <div class="results-content" id="results-content">
            <!-- Dynamic content -->
        </div>
    </div>
    
    <!-- Header -->
    <header class="chat-header">
        <div class="header-left">
            <div class="avatar">
                <span>G</span>
            </div>
            <div class="header-info">
                <div class="header-name">GIDEON 3.0</div>
                <div class="header-status">
                    <span class="status-dot"></span>
                    <span id="status-text">Online â€¢ Pronto ad aiutarti</span>
                </div>
            </div>
        </div>
        
        <div class="mode-indicator">
            <span class="mode-dot"></span>
            <span class="mode-text" id="mode-text">COPILOT</span>
        </div>
        
        <div class="mode-selector">
            <button class="mode-btn" data-mode="passive">PASSIVE</button>
            <button class="mode-btn active" data-mode="copilot">COPILOT</button>
            <button class="mode-btn" data-mode="pilot">PILOT</button>
        </div>
    </header>
    
    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-item">
            <span>ðŸ’¬</span>
            <span id="msg-count">0</span>
        </div>
        <div class="stat-item">
            <span>ðŸ”„</span>
            <span id="turn-count">0</span>
        </div>
        <div class="stat-item">
            <span>â±ï¸</span>
            <span id="session-time">0:00</span>
        </div>
        
        <!-- VOICE ACTIVATION BUTTON -->
        <button class="voice-activate-btn" id="voice-activate-btn" title="Attiva riconoscimento vocale">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" y1="19" x2="12" y2="23"/>
                <line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
            <span>PARLA</span>
        </button>
        
        <div class="handsfree-toggle" id="handsfree-toggle" title="ModalitÃ  Hands-Free (sempre in ascolto)">
            <span class="toggle-dot"></span>
            <span>ðŸŽ¤ HANDS-FREE</span>
        </div>
        <div class="tts-toggle active" id="tts-toggle" title="Text-to-Speech (GIDEON parla)">
            <span class="toggle-dot"></span>
            <span>ðŸ”Š TTS</span>
        </div>
        <button class="stop-speech-btn" id="stop-speech-btn" title="Ferma la voce">
            ðŸ›‘ FERMA VOCE
        </button>
        <button class="debug-btn" id="debug-btn" onclick="toggleDebugPanel()" title="Debug Panel">
            ðŸ› DEBUG
        </button>
    </div>
    
    <!-- Debug Panel -->
    <div class="debug-panel" id="debug-panel">
        <div class="debug-header">
            <h3>ðŸ› DEBUG CONSOLE</h3>
            <button class="close-debug" onclick="toggleDebugPanel()">âœ•</button>
        </div>
        <div class="debug-content">
            <div class="debug-section">
                <h4>ðŸ“¡ Connessione</h4>
                <div id="debug-connection">
                    <p>Backend: <span id="debug-backend-status">â³ Checking...</span></p>
                    <p>WebSocket: <span id="debug-ws-status">â³ Checking...</span></p>
                    <p>API URL: <span id="debug-api-url">-</span></p>
                </div>
            </div>
            <div class="debug-section">
                <h4>ðŸŽ™ï¸ Audio/TTS</h4>
                <div id="debug-audio">
                    <p>TTS Attivo: <span id="debug-tts-active">-</span></p>
                    <p>Voice Recognition: <span id="debug-voice-rec">-</span></p>
                    <p>Audio Player: <span id="debug-audio-player">-</span></p>
                </div>
            </div>
            <div class="debug-section">
                <h4>ðŸ’¾ Stato</h4>
                <div id="debug-state">
                    <p>ModalitÃ : <span id="debug-mode">-</span></p>
                    <p>Messaggi: <span id="debug-msg-count">0</span></p>
                    <p>Errori: <span id="debug-error-count">0</span></p>
                    <p>WS Reconnect: <span id="debug-ws-reconnect">0</span></p>
                </div>
            </div>
            <div class="debug-section">
                <h4>ðŸ“‹ Log</h4>
                <div class="debug-log" id="debug-log"></div>
            </div>
            <div class="debug-actions">
                <button onclick="refreshDebugInfo()">ðŸ”„ Refresh</button>
                <button onclick="testBackendConnection()">ðŸ§ª Test REST</button>
                <button onclick="testWebSocketConnection()">ðŸ”Œ Test WS</button>
                <button onclick="clearDebugLog()">ðŸ—‘ï¸ Clear</button>
                <button onclick="exportDebugLog()">ðŸ“¥ Export</button>
            </div>
        </div>
    </div>
    
    <!-- TTS Status Indicator -->
    <div class="tts-status-indicator" id="tts-status-indicator">
        <span id="tts-status-text">ðŸ”Š TTS Pronto</span>
    </div>
    
    <!-- Voice Status Bar -->
    <div class="voice-status-bar" id="voice-status-bar">
        <div class="voice-wave">
            <span></span><span></span><span></span><span></span><span></span>
        </div>
        <span class="voice-transcript" id="voice-transcript">In ascolto...</span>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chat-container">
        <!-- Welcome Message -->
        <div class="welcome-message">
            <div class="welcome-title">GIDEON ONLINE</div>
            <div class="welcome-subtitle">Benvenuto, <span id="welcome-time"></span></div>
            <div class="welcome-date" id="today-date"></div>
        </div>
        
        <div class="date-divider">
            <span>SESSIONE INIZIATA</span>
        </div>
        
        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typing-indicator">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span class="typing-text">ELABORAZIONE IN CORSO</span>
        </div>
        
        <!-- Reasoning Preview -->
        <div class="reasoning-preview" id="reasoning-preview">
            ðŸ§  Analizzando...
        </div>
    </div>
    
    <!-- Automation Panel (Hidden by default) -->
    <div id="automation-panel" class="automation-panel">
        <div class="panel-header">
            <h3>ðŸ¤– AUTOMAZIONI</h3>
            <button class="close-panel" onclick="toggleAutomationPanel()">âœ•</button>
        </div>
        <div class="panel-content">
            <!-- System Controls -->
            <div class="panel-section">
                <h4>ðŸ’» Sistema</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="executeAction('lock')">ðŸ”’ Blocca</button>
                    <button class="panel-btn" onclick="executeAction('sleep')">ðŸ˜´ Sospendi</button>
                    <button class="panel-btn" onclick="executeAction('restart', {delay: 60})">ðŸ”„ Riavvia</button>
                    <button class="panel-btn" onclick="executeAction('shutdown', {delay: 60})">â» Spegni</button>
                </div>
            </div>
            
            <!-- Audio Controls -->
            <div class="panel-section">
                <h4>ðŸ”Š Audio</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="executeAction('set_volume', {level: 0})">ðŸ”‡ Muto</button>
                    <button class="panel-btn" onclick="executeAction('set_volume', {level: 25})">ðŸ”ˆ 25%</button>
                    <button class="panel-btn" onclick="executeAction('set_volume', {level: 50})">ðŸ”‰ 50%</button>
                    <button class="panel-btn" onclick="executeAction('set_volume', {level: 100})">ðŸ”Š 100%</button>
                </div>
            </div>
            
            <!-- Apps -->
            <div class="panel-section">
                <h4>ðŸ“± Applicazioni</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="executeAction('open_app', {name: 'notepad'})">ðŸ“ Notepad</button>
                    <button class="panel-btn" onclick="executeAction('open_app', {name: 'calculator'})">ðŸ§® Calcolatrice</button>
                    <button class="panel-btn" onclick="executeAction('open_app', {name: 'explorer'})">ðŸ“ Explorer</button>
                    <button class="panel-btn" onclick="executeAction('open_app', {name: 'cmd'})">âŒ¨ï¸ CMD</button>
                    <button class="panel-btn" onclick="executeAction('open_app', {name: 'powershell'})">ðŸ’  PowerShell</button>
                    <button class="panel-btn" onclick="executeAction('open_app', {name: 'vscode'})">ðŸ”· VS Code</button>
                </div>
            </div>
            
            <!-- Web -->
            <div class="panel-section">
                <h4>ðŸŒ Web</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="executeAction('open_url', {url: 'https://google.com'})">ðŸ” Google</button>
                    <button class="panel-btn" onclick="executeAction('open_url', {url: 'https://youtube.com'})">â–¶ï¸ YouTube</button>
                    <button class="panel-btn" onclick="executeAction('open_url', {url: 'https://github.com'})">ðŸ™ GitHub</button>
                    <button class="panel-btn" onclick="executeAction('open_url', {url: 'https://chat.openai.com'})">ðŸ¤– ChatGPT</button>
                </div>
            </div>
            
            <!-- Processes -->
            <div class="panel-section">
                <h4>âš™ï¸ Processi</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="showProcesses()">ðŸ“‹ Lista Processi</button>
                    <button class="panel-btn" onclick="showWindows()">ðŸªŸ Finestre Aperte</button>
                    <button class="panel-btn" onclick="showSystemInfo()">ðŸ“Š Info Sistema</button>
                    <button class="panel-btn" onclick="showResourceUsage()">ðŸ“ˆ Risorse</button>
                </div>
            </div>
            
            <!-- Security & Privacy -->
            <div class="panel-section security-section">
                <h4>ðŸ”’ Sicurezza & Privacy</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="runSecurityTool('security_scan')" data-tooltip="ðŸ” SCANSIONE SICUREZZA: Analisi completa del sistema per vulnerabilitÃ , software obsoleto, configurazioni rischiose.">ðŸ” Scansione Sicurezza</button>
                    <button class="panel-btn" onclick="runSecurityTool('check_vulnerabilities')" data-tooltip="ðŸ›¡ï¸ CHECK VULNERABILITÃ€: Verifica CVE noti, patch mancanti, exploit potenziali nel sistema.">ðŸ›¡ï¸ Check VulnerabilitÃ </button>
                    <button class="panel-btn" onclick="runSecurityTool('clear_browser_data')" data-tooltip="ðŸ§¹ PULISCI BROWSER: Elimina cronologia, cookie, cache, password da tutti i browser installati.">ðŸ§¹ Pulisci Browser</button>
                    <button class="panel-btn" onclick="runSecurityTool('check_passwords')" data-tooltip="ðŸ”‘ AUDIT PASSWORD: Analizza password per forza, duplicati, presenza in data breach noti.">ðŸ”‘ Audit Password</button>
                    <button class="panel-btn" onclick="runSecurityTool('network_scan')" data-tooltip="ðŸ“¡ SCANSIONE RETE: Mappa dispositivi connessi, porte aperte, identifica device sconosciuti.">ðŸ“¡ Scansione Rete</button>
                    <button class="panel-btn" onclick="runSecurityTool('check_permissions')" data-tooltip="ðŸ“‹ CHECK PERMESSI: Audit permessi app, accessi webcam/microfono, autorizzazioni sistema.">ðŸ“‹ Check Permessi</button>
                    <button class="panel-btn" onclick="runSecurityTool('backup_credentials')" data-tooltip="ðŸ’¾ BACKUP CREDENZIALI: Esporta credenziali in formato crittografato sicuro.">ðŸ’¾ Backup Credenziali</button>
                    <button class="panel-btn" onclick="runSecurityTool('check_updates')" data-tooltip="ðŸ”„ AGGIORNAMENTI: Verifica Windows Update, driver, antivirus per patch di sicurezza.">ðŸ”„ Aggiornamenti Sicurezza</button>
                </div>
            </div>

            <!-- Health & Wellness -->
            <div class="panel-section health-section">
                <h4>ðŸ’Š Salute & Benessere</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="runHealthTool('posture_reminder')" data-tooltip="ðŸ§˜ REMINDER POSTURA: Notifiche periodiche per correggere postura. Include esercizi guidati.">ðŸ§˜ Reminder Postura</button>
                    <button class="panel-btn" onclick="runHealthTool('eye_break')" data-tooltip="ðŸ‘ï¸ PAUSA OCCHI 20-20-20: Ogni 20 min, guarda a 6m per 20 sec. Previene affaticamento.">ðŸ‘ï¸ Pausa Occhi (20-20-20)</button>
                    <button class="panel-btn" onclick="runHealthTool('hydration_reminder')" data-tooltip="ðŸ’§ REMINDER IDRATAZIONE: Notifiche per bere acqua. Traccia consumo giornaliero.">ðŸ’§ Reminder Idratazione</button>
                    <button class="panel-btn" onclick="runHealthTool('stretch_break')" data-tooltip="ðŸ¤¸ PAUSA STRETCHING: Timer per pause movimento con routine stretching guidate.">ðŸ¤¸ Pausa Stretching</button>
                    <button class="panel-btn" onclick="runHealthTool('screen_time_report')" data-tooltip="ðŸ“Š TEMPO SCHERMO: Statistiche uso computer: ore attive, app piÃ¹ usate, pattern.">ðŸ“Š Report Tempo Schermo</button>
                    <button class="panel-btn" onclick="runHealthTool('blue_light_filter')" data-tooltip="ðŸŒ™ FILTRO LUCE BLU: Attiva filtro automatico dopo tramonto. Protegge sonno.">ðŸŒ™ Filtro Luce Blu</button>
                    <button class="panel-btn" onclick="runHealthTool('focus_mode')" data-tooltip="ðŸŽ¯ MODALITÃ€ FOCUS: Blocca notifiche, silenzia app, attiva timer Pomodoro.">ðŸŽ¯ ModalitÃ  Focus</button>
                    <button class="panel-btn" onclick="runHealthTool('wellness_summary')" data-tooltip="ðŸ“‹ RIEPILOGO: Report giornaliero pause, tempo schermo, postura, suggerimenti.">ðŸ“‹ Riepilogo Benessere</button>
                </div>
            </div>

            <!-- Prevention & Maintenance -->
            <div class="panel-section prevention-section">
                <h4>ðŸ› ï¸ Prevenzione & Manutenzione</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="runPreventionTool('disk_health')" data-tooltip="ðŸ’½ SALUTE DISCO: Analisi S.M.A.R.T., settori danneggiati, temperatura, vita residua.">ðŸ’½ Salute Disco</button>
                    <button class="panel-btn" onclick="runPreventionTool('battery_health')" data-tooltip="ðŸ”‹ SALUTE BATTERIA: CapacitÃ  attuale vs originale, cicli carica, wear level.">ðŸ”‹ Salute Batteria</button>
                    <button class="panel-btn" onclick="runPreventionTool('temp_cleanup')" data-tooltip="ðŸ§¹ PULIZIA TEMP: Elimina file temporanei, cache, log vecchi. Libera spazio.">ðŸ§¹ Pulizia Temp</button>
                    <button class="panel-btn" onclick="runPreventionTool('defrag_analyze')" data-tooltip="ðŸ“€ FRAMMENTAZIONE: HDD: analizza/ottimizza. SSD: verifica TRIM attivo.">ðŸ“€ Analisi Frammentazione</button>
                    <button class="panel-btn" onclick="runPreventionTool('startup_optimize')" data-tooltip="ðŸš€ OTTIMIZZA AVVIO: Disabilita programmi inutili all'avvio, velocizza boot.">ðŸš€ Ottimizza Avvio</button>
                    <button class="panel-btn" onclick="runPreventionTool('driver_check')" data-tooltip="ðŸ”§ CHECK DRIVER: Verifica driver obsoleti, incompatibili, suggerisce update.">ðŸ”§ Check Driver</button>
                    <button class="panel-btn" onclick="runPreventionTool('event_log_analyze')" data-tooltip="ðŸ“ LOG EVENTI: Scansiona Event Viewer per errori, warning, crash ricorrenti.">ðŸ“ Analisi Log Eventi</button>
                    <button class="panel-btn" onclick="runPreventionTool('full_maintenance')" data-tooltip="âš¡ MANUTENZIONE TOTALE: Esegue tutte le operazioni: pulizia, ottimizzazione, verifica.">âš¡ Manutenzione Completa</button>
                </div>
            </div>

            <!-- Smart Workflows -->
            <div class="panel-section workflows-section">
                <h4>âš™ï¸ Workflow Intelligenti</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="runWorkflow('morning_routine')" data-tooltip="ðŸŒ… ROUTINE MATTINA: Avvia automaticamente le app del mattino (email, calendario, news), imposta luminositÃ  e volume ottimali, mostra riepilogo giornata.">ðŸŒ… Routine Mattina</button>
                    <button class="panel-btn" onclick="runWorkflow('work_setup')" data-tooltip="ðŸ’¼ SETUP LAVORO: Apre tutti gli strumenti necessari per lavorare (IDE, browser, Slack), organizza le finestre, attiva focus mode.">ðŸ’¼ Setup Lavoro</button>
                    <button class="panel-btn" onclick="runWorkflow('meeting_prep')" data-tooltip="ðŸ“… PREPARA MEETING: Verifica webcam/microfono, chiude app rumorose, prepara note meeting, apre calendario con eventi del giorno.">ðŸ“… Prepara Meeting</button>
                    <button class="panel-btn" onclick="runWorkflow('end_of_day')" data-tooltip="ðŸŒ™ FINE GIORNATA: Salva tutti i documenti, crea backup, genera report giornaliero, chiude app non necessarie, suggerisce pausa.">ðŸŒ™ Fine Giornata</button>
                    <button class="panel-btn" onclick="runWorkflow('backup_routine')" data-tooltip="ðŸ’¾ BACKUP ROUTINE: Esegue backup incrementale di documenti importanti, sincronizza con cloud, verifica integritÃ  dei backup esistenti.">ðŸ’¾ Backup Routine</button>
                    <button class="panel-btn" onclick="runWorkflow('cleanup_routine')" data-tooltip="ðŸ§¹ PULIZIA ROUTINE: Elimina file temporanei, svuota cestino, pulisce cache browser, libera spazio su disco, ottimizza registro.">ðŸ§¹ Pulizia Routine</button>
                    <button class="panel-btn" onclick="runWorkflow('security_routine')" data-tooltip="ðŸ”’ ROUTINE SICUREZZA: Scansione antivirus rapida, verifica aggiornamenti sicurezza, controlla firewall, audit permessi app.">ðŸ”’ Routine Sicurezza</button>
                    <button class="panel-btn" onclick="runWorkflow('custom')" data-tooltip="âœ¨ WORKFLOW PERSONALIZZATO: Crea un nuovo workflow combinando azioni a tua scelta. Salva e riutilizza le tue automazioni preferite.">âœ¨ Workflow Personalizzato</button>
                </div>
            </div>

            <!-- Resources -->
            <div class="panel-section resources-section">
                <h4>ðŸ“š Risorse & Database</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="runResourceTool('knowledge_base')" data-tooltip="ðŸ§  KNOWLEDGE BASE: Accede al database di conoscenze GIDEON con milioni di articoli, paper scientifici e documentazione tecnica.">ðŸ§  Knowledge Base</button>
                    <button class="panel-btn" onclick="runResourceTool('wiki_search')" data-tooltip="ðŸ“– WIKI SEARCH: Ricerca semantica su Wikipedia, Wikimedia e archivi enciclopedici. Risultati multi-lingua con traduzione automatica.">ðŸ“– Wiki Search</button>
                    <button class="panel-btn" onclick="runResourceTool('paper_search')" data-tooltip="ðŸ“„ PAPER SEARCH: Cerca paper accademici su arXiv, PubMed, IEEE, ACM. Analizza citazioni e impact factor.">ðŸ“„ Paper Search</button>
                    <button class="panel-btn" onclick="runResourceTool('patent_db')" data-tooltip="ðŸ’¡ PATENT DATABASE: Accesso a database brevetti USPTO, EPO, WIPO. Analisi prior art e ricerca innovazioni.">ðŸ’¡ Patent Database</button>
                    <button class="panel-btn" onclick="runResourceTool('legal_db')" data-tooltip="âš–ï¸ LEGAL DATABASE: Database legale con leggi, sentenze, giurisprudenza italiana ed europea. Ricerca per codice o keyword.">âš–ï¸ Legal Database</button>
                    <button class="panel-btn" onclick="runResourceTool('financial_data')" data-tooltip="ðŸ“ˆ FINANCIAL DATA: Dati finanziari real-time: azioni, crypto, forex, commodities. Analisi tecnica e fondamentale.">ðŸ“ˆ Financial Data</button>
                    <button class="panel-btn" onclick="runResourceTool('news_aggregator')" data-tooltip="ðŸ“° NEWS AGGREGATOR: Aggregatore notizie multi-fonte con AI per filtrare fake news. Breaking news e trend analysis.">ðŸ“° News Aggregator</button>
                    <button class="panel-btn" onclick="runResourceTool('open_data')" data-tooltip="ðŸŒ OPEN DATA: Accesso a dataset governativi aperti (ISTAT, Eurostat, data.gov). Visualizzazione e analisi dati.">ðŸŒ Open Data</button>
                    <button class="panel-btn" onclick="runResourceTool('api_catalog')" data-tooltip="ðŸ”Œ API CATALOG: Catalogo di API pubbliche organizzate per categoria. Test endpoint e documentazione integrata.">ðŸ”Œ API Catalog</button>
                    <button class="panel-btn" onclick="runResourceTool('code_repos')" data-tooltip="ðŸ’» CODE REPOS: Ricerca in repository GitHub, GitLab, Bitbucket. Analisi codice, dipendenze e vulnerabilitÃ .">ðŸ’» Code Repos</button>
                </div>
            </div>

            <!-- Archaeology -->
            <div class="panel-section archaeology-section">
                <h4>ðŸ›ï¸ Archeologia & Storia</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="runArchaeologyTool('site_analysis')" data-tooltip="ðŸ—¿ SITE ANALYSIS: Analisi siti archeologici con AI. Ricostruzione 3D, datazione stratigrafica, mappatura GIS.">ðŸ—¿ Analisi Siti</button>
                    <button class="panel-btn" onclick="runArchaeologyTool('artifact_id')" data-tooltip="ðŸº ARTIFACT ID: Identificazione reperti tramite image recognition. Confronto con database museali mondiali.">ðŸº ID Reperti</button>
                    <button class="panel-btn" onclick="runArchaeologyTool('dating_calc')" data-tooltip="ðŸ“… DATING CALC: Calcolatore datazione: Carbonio-14, dendrocronologia, termoluminescenza. Calibrazione con curve aggiornate.">ðŸ“… Datazione</button>
                    <button class="panel-btn" onclick="runArchaeologyTool('ancient_texts')" data-tooltip="ðŸ“œ ANCIENT TEXTS: Database testi antichi: papiri, iscrizioni, manoscritti. OCR specializzato per scritture antiche.">ðŸ“œ Testi Antichi</button>
                    <button class="panel-btn" onclick="runArchaeologyTool('3d_reconstruction')" data-tooltip="ðŸ—ï¸ 3D RECONSTRUCTION: Ricostruzione 3D monumenti e cittÃ  antiche basata su dati archeologici e fonti storiche.">ðŸ—ï¸ Ricostruzione 3D</button>
                    <button class="panel-btn" onclick="runArchaeologyTool('historical_maps')" data-tooltip="ðŸ—ºï¸ HISTORICAL MAPS: Archivio mappe storiche georeferenziate. Overlay su mappe moderne, analisi cambiamenti territoriali.">ðŸ—ºï¸ Mappe Storiche</button>
                    <button class="panel-btn" onclick="runArchaeologyTool('dynasty_db')" data-tooltip="ðŸ‘‘ DYNASTY DATABASE: Database dinastie e genealogie storiche. Alberi genealogici interattivi, collegamenti storici.">ðŸ‘‘ Dinastie</button>
                    <button class="panel-btn" onclick="runArchaeologyTool('museum_catalog')" data-tooltip="ðŸ›ï¸ MUSEUM CATALOG: Catalogo collezioni museali mondiali. Tour virtuali, schede tecniche reperti, prestiti tra musei.">ðŸ›ï¸ Catalogo Musei</button>
                </div>
            </div>

            <!-- Cybersecurity -->
            <div class="panel-section cyber-section">
                <h4>ðŸ–¥ï¸ Cybersecurity</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="runCyberTool('port_scan')" data-tooltip="ðŸ”Œ PORT SCAN: Scansiona le porte di rete aperte sul sistema. Identifica servizi attivi e potenziali vulnerabilitÃ . Usa Nmap-like scanning.">ðŸ”Œ Port Scan</button>
                    <button class="panel-btn" onclick="runCyberTool('firewall_check')" data-tooltip="ðŸ§± FIREWALL CHECK: Verifica stato firewall Windows/Linux. Controlla regole attive, porte bloccate e configurazione corrente.">ðŸ§± Check Firewall</button>
                    <button class="panel-btn" onclick="runCyberTool('malware_scan')" data-tooltip="ðŸ¦  MALWARE SCAN: Scansione euristica e signature-based per malware, virus, trojan, ransomware. Usa database aggiornato.">ðŸ¦  Scan Malware</button>
                    <button class="panel-btn" onclick="runCyberTool('intrusion_detect')" data-tooltip="ðŸš¨ INTRUSION DETECTION: Monitora traffico anomalo, tentativi di accesso sospetti, comportamenti malevoli. Alert in tempo reale.">ðŸš¨ Intrusion Detection</button>
                    <button class="panel-btn" onclick="runCyberTool('vuln_assessment')" data-tooltip="ðŸ”“ VULNERABILITY ASSESSMENT: Scansione CVE, verifica patch mancanti, software obsoleto, configurazioni insicure.">ðŸ”“ Vulnerability Assessment</button>
                    <button class="panel-btn" onclick="runCyberTool('traffic_monitor')" data-tooltip="ðŸ“Š TRAFFIC MONITOR: Analisi pacchetti rete in tempo reale. Identifica connessioni sospette, data exfiltration, botnet.">ðŸ“Š Traffic Monitor</button>
                    <button class="panel-btn" onclick="runCyberTool('ssl_check')" data-tooltip="ðŸ”’ SSL/TLS CHECK: Verifica certificati SSL, scadenze, vulnerabilitÃ  (POODLE, Heartbleed), configurazione TLS.">ðŸ”’ SSL/TLS Check</button>
                    <button class="panel-btn" onclick="runCyberTool('dns_lookup')" data-tooltip="ðŸŒ DNS LOOKUP: Query DNS avanzata (A, AAAA, MX, TXT, NS, SOA). Verifica propagazione, spoofing detection.">ðŸŒ DNS Lookup</button>
                    <button class="panel-btn" onclick="runCyberTool('whois')" data-tooltip="ðŸ“‹ WHOIS LOOKUP: Informazioni registrazione dominio: proprietario, date, name server, status. Verifica legittimitÃ  siti.">ðŸ“‹ WHOIS Lookup</button>
                    <button class="panel-btn" onclick="runCyberTool('hash_check')" data-tooltip="ðŸ” HASH VERIFICATION: Calcola e verifica hash MD5, SHA1, SHA256, SHA512. Confronta con VirusTotal e database malware.">ðŸ” Hash Verification</button>
                    <button class="panel-btn" onclick="runCyberTool('password_strength')" data-tooltip="ðŸ’ª PASSWORD STRENGTH: Analizza robustezza password: entropia, pattern comuni, tempo di crack stimato, suggerimenti.">ðŸ’ª Password Strength</button>
                    <button class="panel-btn" onclick="runCyberTool('breach_check')" data-tooltip="âš ï¸ BREACH CHECK: Verifica se email/password sono stati compromessi in data breach noti. Database HaveIBeenPwned.">âš ï¸ Breach Check</button>
                </div>
            </div>

            <!-- Military & Intelligence -->
            <div class="panel-section military-section">
                <h4>âš”ï¸ Militare & Intelligence</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="runMilitaryTool('sigint')" data-tooltip="ðŸ›°ï¸ SIGINT ANALYSIS: Signals Intelligence - Analisi segnali radio, intercettazioni, pattern comunicazioni. Decodifica protocolli.">ðŸ›°ï¸ SIGINT Analysis</button>
                    <button class="panel-btn" onclick="runMilitaryTool('osint')" data-tooltip="ðŸ” OSINT GATHERING: Open Source Intelligence - Raccolta info da fonti pubbliche: social, news, database aperti. Profiling automatico.">ðŸ” OSINT Gathering</button>
                    <button class="panel-btn" onclick="runMilitaryTool('tactical')" data-tooltip="ðŸŽ¯ TACTICAL AI: Supporto decisionale tattico. Analisi terreno, posizionamento, scenari what-if, simulazioni combattimento.">ðŸŽ¯ Tactical AI</button>
                    <button class="panel-btn" onclick="runMilitaryTool('cyber_defense')" data-tooltip="ðŸ›¡ï¸ CYBER DEFENSE: Difesa cibernetica avanzata. Honeypot, deception technology, threat hunting, incident response.">ðŸ›¡ï¸ Cyber Defense</button>
                    <button class="panel-btn" onclick="runMilitaryTool('c4isr')" data-tooltip="ðŸ“¡ C4ISR NETWORK: Command, Control, Communications, Computers, Intelligence, Surveillance, Reconnaissance. Dashboard integrata.">ðŸ“¡ C4ISR Network</button>
                    <button class="panel-btn" onclick="runMilitaryTool('intel_fusion')" data-tooltip="ðŸ—„ï¸ INTEL FUSION: Fusione dati multi-fonte: HUMINT, SIGINT, IMINT, MASINT. Correlazione automatica, pattern recognition.">ðŸ—„ï¸ Intel Fusion</button>
                    <button class="panel-btn" onclick="runMilitaryTool('geospatial')" data-tooltip="ðŸ—ºï¸ GEOSPATIAL INTEL: Intelligence geospaziale. Analisi immagini satellitari, tracciamento, change detection, 3D terrain.">ðŸ—ºï¸ Geospatial Intel</button>
                    <button class="panel-btn" onclick="runMilitaryTool('threat_assess')" data-tooltip="âš ï¸ THREAT ASSESSMENT: Valutazione minacce. Risk scoring, prioritizzazione target, analisi capacitÃ  avversario.">âš ï¸ Threat Assessment</button>
                    <button class="panel-btn" onclick="runMilitaryTool('comms_secure')" data-tooltip="ðŸ“» SECURE COMMS: Comunicazioni sicure. Crittografia end-to-end, canali steganografici, frequency hopping simulation.">ðŸ“» Secure Comms</button>
                    <button class="panel-btn" onclick="runMilitaryTool('crypto_ops')" data-tooltip="ðŸ” CRYPTO OPERATIONS: Operazioni crittografiche. Key management, cipher analysis, quantum-resistant algorithms, PKI.">ðŸ” Crypto Operations</button>
                </div>
            </div>

            <!-- Scientific -->
            <div class="panel-section science-section">
                <h4>ðŸ”¬ Scientifico</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="runScienceTool('data_analysis')" data-tooltip="ðŸ“Š DATA ANALYSIS: Analisi statistica avanzata. Regressione, clustering, PCA, test ipotesi. Visualizzazione dati interattiva.">ðŸ“Š Data Analysis</button>
                    <button class="panel-btn" onclick="runScienceTool('genomics')" data-tooltip="ðŸ§¬ GENOMICS LAB: Analisi sequenze DNA/RNA. Allineamento, annotazione geni, BLAST search, phylogenetics, CRISPR design.">ðŸ§¬ Genomics Lab</button>
                    <button class="panel-btn" onclick="runScienceTool('chemistry')" data-tooltip="ðŸ§ª CHEMISTRY LAB: Simulazione molecolare. Disegno strutture, calcolo proprietÃ , reazioni chimiche, drug design.">ðŸ§ª Chemistry Lab</button>
                    <button class="panel-btn" onclick="runScienceTool('physics')" data-tooltip="âš›ï¸ PHYSICS SIMULATOR: Simulazioni fisica. Meccanica quantistica, relativitÃ , elettromagnetismo, termodinamica, fluidi.">âš›ï¸ Physics Simulator</button>
                    <button class="panel-btn" onclick="runScienceTool('astronomy')" data-tooltip="ðŸ”­ ASTRONOMY TOOLS: Strumenti astronomia. Effemeridi, calcolo orbite, osservazioni celesti, exoplanet finder, cosmologia.">ðŸ”­ Astronomy Tools</button>
                    <button class="panel-btn" onclick="runScienceTool('climate')" data-tooltip="ðŸŒ¡ï¸ CLIMATE MODELING: Modellazione climatica. Previsioni meteo, scenari cambiamento climatico, analisi dati ambientali.">ðŸŒ¡ï¸ Climate Modeling</button>
                    <button class="panel-btn" onclick="runScienceTool('ml_lab')" data-tooltip="ðŸ¤– ML/AI LAB: Laboratorio Machine Learning. Training modelli, neural networks, computer vision, NLP, reinforcement learning.">ðŸ¤– ML/AI Lab</button>
                    <button class="panel-btn" onclick="runScienceTool('simulation')" data-tooltip="ðŸ–¥ï¸ SIMULATION ENGINE: Motore simulazione generale. Monte Carlo, agent-based, system dynamics, discrete events.">ðŸ–¥ï¸ Simulation Engine</button>
                </div>
            </div>

            <!-- Medical -->
            <div class="panel-section medical-section">
                <h4>ðŸ¥ Medico</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="runMedicalTool('diagnostics')" data-tooltip="ðŸ©º DIAGNOSTICA AI: Sistema diagnostico AI. Analisi sintomi, diagnosi differenziale, suggerimenti esami, triage automatico.">ðŸ©º Diagnostica AI</button>
                    <button class="panel-btn" onclick="runMedicalTool('biometry')" data-tooltip="ðŸ«€ BIOMETRIA: Analisi parametri vitali. ECG, SpO2, pressione, glicemia. Trend analysis, alert anomalie, report medico.">ðŸ«€ Biometria</button>
                    <button class="panel-btn" onclick="runMedicalTool('neuro')" data-tooltip="ðŸ§  NEUROIMAGING: Analisi immagini cerebrali. MRI, fMRI, EEG analysis. Segmentazione, lesion detection, brain mapping.">ðŸ§  Neuroimaging</button>
                    <button class="panel-btn" onclick="runMedicalTool('pharma')" data-tooltip="ðŸ’Š FARMACOLOGIA: Database farmaci. Interazioni, dosaggi, effetti collaterali, farmacocinetica, alternative generici.">ðŸ’Š Farmacologia</button>
                    <button class="panel-btn" onclick="runMedicalTool('epidemiology')" data-tooltip="ðŸ¦  EPIDEMIOLOGIA: Tracking epidemie. Modelli SIR/SEIR, mappe contagio, R0 calculation, previsioni outbreak.">ðŸ¦  Epidemiologia</button>
                    <button class="panel-btn" onclick="runMedicalTool('telemedicine')" data-tooltip="ðŸ“± TELEMEDICINA: Piattaforma telemedicina. Videoconsulti, monitoraggio remoto, prescrizioni digitali, cartelle cliniche.">ðŸ“± Telemedicina</button>
                    <button class="panel-btn" onclick="runMedicalTool('radiology')" data-tooltip="ðŸ©» RADIOLOGIA AI: Analisi immagini radiologiche. Raggi X, CT, MRI. Detection automatica anomalie, segmentazione, report.">ðŸ©» Radiologia AI</button>
                    <button class="panel-btn" onclick="runMedicalTool('patient_monitor')" data-tooltip="ðŸ“ˆ PATIENT MONITOR: Monitoraggio continuo paziente. Dashboard vitals, alert soglie, trend 24h, integrazione dispositivi IoT.">ðŸ“ˆ Patient Monitor</button>
                </div>
            </div>

            <!-- System Monitor -->
            <div class="panel-section monitor-section">
                <h4>ðŸ“Š Monitoraggio Sistema</h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="runMonitorTool('cpu_usage')" data-tooltip="ðŸ”¥ CPU USAGE: Utilizzo processore in tempo reale per core. Frequenza, temperature, throttling.">ðŸ”¥ CPU Usage</button>
                    <button class="panel-btn" onclick="runMonitorTool('ram_usage')" data-tooltip="ðŸ’¾ RAM USAGE: Memoria fisica e virtuale. Processi che consumano piÃ¹ RAM, cache, pagefile.">ðŸ’¾ RAM Usage</button>
                    <button class="panel-btn" onclick="runMonitorTool('disk_usage')" data-tooltip="ðŸ’½ DISK USAGE: Spazio su tutti i dischi. Lettura/scrittura, IOPS, file piÃ¹ grandi.">ðŸ’½ Disk Usage</button>
                    <button class="panel-btn" onclick="runMonitorTool('network_traffic')" data-tooltip="ðŸ“¡ NETWORK TRAFFIC: Traffico in/out per interfaccia. Connessioni attive, bandwidth, latenza.">ðŸ“¡ Network Traffic</button>
                    <button class="panel-btn" onclick="runMonitorTool('processes')" data-tooltip="ðŸ“‹ PROCESSI ATTIVI: Lista processi con CPU, RAM, IO. Ordina, filtra, termina processi.">ðŸ“‹ Processi Attivi</button>
                    <button class="panel-btn" onclick="runMonitorTool('services')" data-tooltip="âš™ï¸ SERVIZI: Stato servizi Windows. Avvia, ferma, riavvia servizi. Tipo avvio.">âš™ï¸ Servizi</button>
                    <button class="panel-btn" onclick="runMonitorTool('temperatures')" data-tooltip="ðŸŒ¡ï¸ TEMPERATURE: CPU, GPU, dischi, scheda madre. Alert soglie critiche.">ðŸŒ¡ï¸ Temperature</button>
                    <button class="panel-btn" onclick="runMonitorTool('battery')" data-tooltip="ðŸ”‹ BATTERIA: Carica %, stato salute, tempo rimanente, wattaggio consumo.">ðŸ”‹ Batteria</button>
                    <button class="panel-btn" onclick="runMonitorTool('gpu_usage')" data-tooltip="ðŸŽ® GPU USAGE: Utilizzo GPU, VRAM, temperature, frequenze, encoder/decoder.">ðŸŽ® GPU Usage</button>
                    <button class="panel-btn" onclick="runMonitorTool('system_uptime')" data-tooltip="â±ï¸ UPTIME: Tempo dall'ultimo riavvio. Storico riavvii, crash, BSOD.">â±ï¸ Uptime</button>
                    <button class="panel-btn" onclick="runMonitorTool('event_logs')" data-tooltip="ðŸ“ EVENT LOGS: Log Windows recenti. Errori, warning, info. Filtri avanzati.">ðŸ“ Event Logs</button>
                    <button class="panel-btn" onclick="runMonitorTool('full_report')" data-tooltip="ðŸ“Š REPORT COMPLETO: Genera report PDF/HTML con tutte le metriche di sistema.">ðŸ“Š Report Completo</button>
                </div>
            </div>

            <!-- Work & Productivity -->
            <div class="panel-section work-section">
                <h4>ðŸ’¼ Lavoro & ProduttivitÃ </h4>
                <div class="panel-buttons">
                    <button class="panel-btn" onclick="runWorkTool('pomodoro')" data-tooltip="ðŸ… POMODORO: Timer 25min lavoro + 5min pausa. Aumenta focus e produttivitÃ .">ðŸ… Pomodoro Timer</button>
                    <button class="panel-btn" onclick="runWorkTool('task_list')" data-tooltip="ðŸ“ TASK LIST: Gestisci attivitÃ  con prioritÃ , deadline, tag. Sottotask supportati.">ðŸ“ Task List</button>
                    <button class="panel-btn" onclick="runWorkTool('calendar')" data-tooltip="ðŸ“… CALENDARIO: Visualizza eventi, crea appuntamenti, reminder automatici.">ðŸ“… Calendario</button>
                    <button class="panel-btn" onclick="runWorkTool('notes')" data-tooltip="ðŸ—’ï¸ NOTE RAPIDE: Cattura idee velocemente. Supporta markdown, tag, ricerca.">ðŸ—’ï¸ Note Rapide</button>
                    <button class="panel-btn" onclick="runWorkTool('time_tracker')" data-tooltip="â° TIME TRACKER: Traccia tempo per progetto/task. Report settimanali, export.">â° Time Tracker</button>
                    <button class="panel-btn" onclick="runWorkTool('project_manager')" data-tooltip="ðŸ“‹ PROJECT MANAGER: Kanban board, milestone, team collaboration, Gantt.">ðŸ“‹ Project Manager</button>
                    <button class="panel-btn" onclick="runWorkTool('email_draft')" data-tooltip="âœ‰ï¸ BOZZA EMAIL: AI genera email professionali da input breve.">âœ‰ï¸ Bozza Email</button>
                    <button class="panel-btn" onclick="runWorkTool('meeting_notes')" data-tooltip="ðŸŽ¤ NOTE MEETING: Template meeting, action items, trascrizione audio.">ðŸŽ¤ Note Meeting</button>
                    <button class="panel-btn" onclick="runWorkTool('code_snippets')" data-tooltip="ðŸ’» CODE SNIPPETS: Libreria snippet personale. Syntax highlight, tag, search.">ðŸ’» Code Snippets</button>
                    <button class="panel-btn" onclick="runWorkTool('document_gen')" data-tooltip="ðŸ“„ GENERA DOCUMENTO: Crea report, lettere, presentazioni da template AI.">ðŸ“„ Genera Documento</button>
                    <button class="panel-btn" onclick="runWorkTool('productivity_stats')" data-tooltip="ðŸ“ˆ STATS PRODUTTIVITÃ€: Analisi tempo lavoro, focus score, trend settimanali.">ðŸ“ˆ Stats ProduttivitÃ </button>
                    <button class="panel-btn" onclick="runWorkTool('daily_summary')" data-tooltip="ðŸ“Š RIEPILOGO: Sommario giornata: task completati, tempo, note, domani.">ðŸ“Š Riepilogo Giornata</button>
                </div>
            </div>

            <!-- Emergency -->
            <div class="panel-section emergency-section">
                <h4>ðŸš¨ Emergenza</h4>
                <div class="panel-buttons">
                    <button class="panel-btn emergency-btn" onclick="emergencyAction('kill')">â›” KILL SWITCH</button>
                    <button class="panel-btn emergency-btn" onclick="emergencyAction('safe_mode')">ðŸ›¡ï¸ SAFE MODE</button>
                    <button class="panel-btn emergency-btn" onclick="emergencyAction('lockdown')">ðŸ” LOCKDOWN</button>
                    <button class="panel-btn success-btn" onclick="emergencyAction('resume')">âœ… RIPRENDI</button>
                </div>
            </div>
            
            <!-- AI HUB - Nuova Sezione -->
            <div class="panel-section ai-hub-section">
                <h4>ðŸš€ AI Hub</h4>
                <div class="panel-buttons">
                    <button class="panel-btn ai-btn" onclick="openAIHub('image')">ðŸŽ¨ Genera Immagine</button>
                    <button class="panel-btn ai-btn" onclick="openAIHub('video')">ðŸŽ¬ Genera Video</button>
                    <button class="panel-btn ai-btn" onclick="openAIHub('music')">ðŸŽµ Genera Musica</button>
                    <button class="panel-btn ai-btn" onclick="openAIHub('presentation')">ðŸ“Š Crea Slide</button>
                    <button class="panel-btn ai-btn" onclick="openAIHub('podcast')">ðŸŽ™ï¸ Crea Podcast</button>
                    <button class="panel-btn ai-btn" onclick="openAIHub('workflows')">âš™ï¸ Automazioni</button>
                </div>
                <!-- New AI Services -->
                <h5 style="margin-top:15px;color:var(--neon-magenta);">ðŸ”¥ Video AI</h5>
                <div class="panel-buttons">
                    <button class="panel-btn ai-btn" onclick="openAIHub('veo')">ðŸ“¹ Veo 3.1 (Google)</button>
                    <button class="panel-btn ai-btn" onclick="openAIHub('sora')">ðŸŽ¥ Sora 2 (OpenAI)</button>
                    <button class="panel-btn ai-btn" onclick="openAIHub('kling')">ðŸŽ¬ Kling AI</button>
                    <button class="panel-btn ai-btn" onclick="openAIHub('heygen')">ðŸ§‘â€ðŸ’¼ HeyGen Avatar</button>
                    <button class="panel-btn ai-btn" onclick="openAIHub('luma')">âœ¨ Luma Dream</button>
                    <button class="panel-btn ai-btn" onclick="openAIHub('pika')">ðŸŽžï¸ Pika Labs</button>
                </div>
                <h5 style="margin-top:15px;color:var(--neon-yellow);">ðŸ–¼ï¸ Image AI</h5>
                <div class="panel-buttons">
                    <button class="panel-btn ai-btn" onclick="openAIHub('seedream')">ðŸŒ¸ Seedream 3.0</button>
                    <button class="panel-btn ai-btn" onclick="openAIHub('seedvr')">ðŸŒ SeedVR (360Â°)</button>
                    <button class="panel-btn ai-btn" onclick="openAIHub('dalle')">ðŸ–Œï¸ DALL-E 3</button>
                    <button class="panel-btn ai-btn" onclick="openAIHub('flux')">âš¡ Flux AI</button>
                </div>
                <!-- Workflow Builder Link -->
                <div style="margin-top:20px;text-align:center;">
                    <a href="workflows.html" class="panel-btn ai-btn" style="display:inline-flex;align-items:center;gap:8px;text-decoration:none;background:linear-gradient(135deg,var(--neon-cyan),var(--neon-blue));color:#000;font-weight:700;padding:12px 25px;">
                        ðŸ”„ WORKFLOW BUILDER
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pilot Mode Dialog -->
    <div id="pilot-dialog" class="pilot-dialog">
        <div class="pilot-dialog-content">
            <h3>ðŸš€ ATTIVAZIONE PILOT MODE</h3>
            <p>Per attivare il controllo completo, inserisci la frase di sicurezza:</p>
            <input type="text" id="pilot-phrase" placeholder="Frase di autorizzazione..." autocomplete="off">
            <div class="pilot-dialog-buttons">
                <button class="pilot-cancel" onclick="closePilotDialog()">Annulla</button>
                <button class="pilot-confirm" onclick="confirmPilotMode()">Autorizza</button>
            </div>
            <p class="pilot-hint">ðŸ’¡ Suggerimento: "Autorizzazione Pilot Alfa Zero Uno"</p>
        </div>
    </div>
    
    <!-- Input Area -->
    <div class="input-area">
        <!-- Response Mode Selector -->
        <div class="response-mode-selector">
            <button class="response-mode-btn eco" data-mode="eco" title="Risposte brevi e veloci">
                <span class="mode-indicator">ðŸ’š</span> ECO
            </button>
            <button class="response-mode-btn fast active" data-mode="fast" title="Bilanciato velocitÃ /qualitÃ ">
                <span class="mode-indicator">âš¡</span> FAST
            </button>
            <button class="response-mode-btn deep" data-mode="deep" title="Risposte approfondite">
                <span class="mode-indicator">ðŸ§ </span> DEEP
            </button>
        </div>
        
        <!-- Quick Actions Row 1: Essenziali -->
        <div class="quick-actions">
            <button class="quick-action" data-message="Che ore sono?">ðŸ• ORA</button>
            <button class="quick-action" data-message="Che giorno Ã¨ oggi?">ðŸ“… DATA</button>
            <button class="quick-action" data-message="Com'Ã¨ il meteo oggi?">ðŸŒ¤ï¸ METEO</button>
            <button class="quick-action" data-action="open_app" data-params='{"name":"chrome"}'>ðŸŒ CHROME</button>
            <button class="quick-action" data-action="open_url" data-params='{"url":"https://youtube.com"}'>â–¶ï¸ YOUTUBE</button>
            <button class="quick-action" data-message="Mostra lo stato del sistema">ðŸ“Š SISTEMA</button>
            <button class="quick-action" data-message="Quanto fa 100 * 25?">ðŸ§® CALCOLA</button>
            <button class="quick-action" data-message="Fai uno screenshot">ðŸ“¸ SCREENSHOT</button>
            <button class="quick-action" data-action="open_app" data-params='{"name":"calculator"}'>ðŸ”¢ CALCOLATRICE</button>
            <button class="quick-action" data-action="lock">ðŸ”’ BLOCCA</button>
            <button class="quick-action" onclick="toggleAutomationPanel()">âš™ï¸ AUTOMAZIONI</button>
            <button class="quick-action" data-message="Quali comandi supporti?">â“ AIUTO</button>
        </div>
        
        <!-- Hidden file input for image upload -->
        <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
        
        <div class="input-wrapper">
            <div class="input-container">
                <textarea 
                    id="chat-input" 
                    placeholder="Scrivi un messaggio a GIDEON..." 
                    rows="1"
                ></textarea>
                <div class="action-buttons">
                    <!-- Camera/Image button -->
                    <button class="action-btn" id="camera-btn" title="Invia foto" onclick="showImageOptions()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                    </button>
                    <button class="action-btn" id="voice-btn" title="Messaggio vocale">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            <line x1="12" y1="19" x2="12" y2="23"/>
                            <line x1="8" y1="23" x2="16" y2="23"/>
                        </svg>
                    </button>
                </div>
            </div>
            <button class="stop-btn" id="stop-btn" title="Interrompi risposta">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <rect x="6" y="6" width="12" height="12" rx="2"/>
                </svg>
            </button>
            <button class="send-btn" id="send-btn" disabled>
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
        
        <!-- Image Options Popup -->
        <div id="image-options-popup" class="image-options-popup" style="display: none;">
            <div class="image-options-content">
                <h3>ðŸ“· Invia Immagine</h3>
                <button class="image-option-btn" onclick="openGallery()">
                    <span class="option-icon">ðŸ–¼ï¸</span>
                    <span class="option-text">Galleria</span>
                    <span class="option-desc">Scegli dalla galleria</span>
                </button>
                <button class="image-option-btn" onclick="openCamera()">
                    <span class="option-icon">ðŸ“¸</span>
                    <span class="option-text">Fotocamera</span>
                    <span class="option-desc">Scatta una foto</span>
                </button>
                <button class="image-option-btn" onclick="takeScreenshot()">
                    <span class="option-icon">ðŸ–¥ï¸</span>
                    <span class="option-text">Screenshot</span>
                    <span class="option-desc">Cattura lo schermo</span>
                </button>
                <button class="image-option-close" onclick="hideImageOptions()">âœ• Chiudi</button>
            </div>
        </div>
        
        <!-- AI Hub Modal -->
        <div id="ai-hub-modal" class="ai-hub-modal">
            <div class="ai-hub-content">
                <h2 id="ai-hub-title">ðŸš€ AI Hub</h2>
                <div id="ai-hub-form-container" class="ai-hub-form">
                    <!-- Form dinamico inserito da JS -->
                </div>
                <div id="ai-hub-result" style="display: none; margin-top: 20px; padding: 15px; background: rgba(0,255,100,0.1); border-radius: 10px;">
                    <!-- Risultato -->
                </div>
                <div class="ai-hub-buttons">
                    <button class="ai-hub-submit" onclick="submitAIHub()">âœ¨ Genera</button>
                    <button class="ai-hub-cancel" onclick="closeAIHub()">âœ• Chiudi</button>
                </div>
            </div>
        </div>
        
        <!-- Image Preview -->
        <div id="image-preview-container" style="display: none;">
            <div class="image-preview-wrapper">
                <img id="image-preview" src="" alt="Preview">
                <button class="remove-image-btn" onclick="removeImagePreview()">âœ•</button>
            </div>
            <div class="image-input-row">
                <input type="text" id="image-question" placeholder="Cosa vuoi sapere su questa immagine?" class="image-question-input">
                <button class="send-image-btn" onclick="sendImageForAnalysis()">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ============ CONFIGURATION ============
        const API_BASE = 'http://127.0.0.1:8001';
        const WS_BASE = 'ws://127.0.0.1:8001';
        
        // ============ AUDIO PLAYER (must be defined early) ============
        let gideonAudioPlayer = new Audio();
        gideonAudioPlayer.volume = 1.0;
        let audioUnlocked = false;
        
        // ============ STATE ============
        const state = {
            sessionId: 'session_' + Date.now(),
            currentMode: 'copilot',
            responseMode: 'fast',  // eco, fast, deep
            messages: [],
            isProcessing: false,
            turnCount: 0,
            sessionStartTime: Date.now(),
            conversationContext: [],
            ws: null,
            // Voice state
            isListening: false,
            isHandsFree: false,
            isTTSEnabled: true,
            recognition: null,
            synthesis: window.speechSynthesis,
            isSpeaking: false,
            // Stop control
            abortController: null,
            canInterrupt: true
        };
        
        // ============ DOM ELEMENTS ============
        const chatContainer = document.getElementById('chat-container');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        const reasoningPreview = document.getElementById('reasoning-preview');
        const modeText = document.getElementById('mode-text');
        const statusText = document.getElementById('status-text');
        const msgCount = document.getElementById('msg-count');
        const turnCount = document.getElementById('turn-count');
        const sessionTime = document.getElementById('session-time');
        const modeBtns = document.querySelectorAll('.mode-btn');
        const quickActions = document.querySelectorAll('.quick-action');
        const voiceBtn = document.getElementById('voice-btn');
        const voiceActivateBtn = document.getElementById('voice-activate-btn');
        const handsfreeToggle = document.getElementById('handsfree-toggle');
        const ttsToggle = document.getElementById('tts-toggle');
        const voiceStatusBar = document.getElementById('voice-status-bar');
        const voiceTranscript = document.getElementById('voice-transcript');
        const avatar = document.querySelector('.avatar');
        const stopBtn = document.getElementById('stop-btn');
        const stopSpeechBtn = document.getElementById('stop-speech-btn');
        
        // ============ GIDEON TOOLS SIDEBAR FUNCTIONS ============
        
        // Toggle toolbar expansion
        function toggleToolbar() {
            const toolbar = document.getElementById('gideon-toolbar');
            toolbar.classList.toggle('expanded');
        }
        
        // Toggle section open/close
        function toggleSection(sectionId) {
            const section = document.getElementById('section-' + sectionId);
            section.classList.toggle('open');
        }
        
        // Show loading indicator
        function showToolbarLoading(text = 'Elaborazione in corso...') {
            const loading = document.getElementById('toolbar-loading');
            const loadingText = document.getElementById('loading-text');
            loadingText.textContent = text;
            loading.classList.add('active');
        }
        
        // Hide loading indicator
        function hideToolbarLoading() {
            const loading = document.getElementById('toolbar-loading');
            loading.classList.remove('active');
        }
        
        // Show results panel
        function showResultsPanel(title, content) {
            const panel = document.getElementById('results-panel');
            const titleEl = document.getElementById('results-title');
            const contentEl = document.getElementById('results-content');
            
            titleEl.textContent = title;
            contentEl.innerHTML = content;
            panel.classList.add('active');
        }
        
        // Close results panel
        function closeResultsPanel() {
            const panel = document.getElementById('results-panel');
            panel.classList.remove('active');
        }
        
        // Main tool execution function - integrated with GIDEON backend
        async function runGideonTool(category, action) {
            const toolNames = {
                // Security
                'security_full_scan': 'ðŸ” Scansione Sicurezza Completa',
                'security_vuln_check': 'âš ï¸ Verifica VulnerabilitÃ ',
                'security_firewall': 'ðŸ›¡ï¸ Stato Firewall',
                'security_audit': 'ðŸ“‹ Audit di Sistema',
                // Health
                'health_diagnostics': 'ðŸ©º Diagnostica Sintomi',
                'health_medications': 'ðŸ’‰ Informazioni Farmaci',
                'health_wellness': 'â¤ï¸ Analisi Benessere',
                'health_emergency': 'ðŸš‘ Protocollo Emergenza',
                // Science
                'science_research': 'ðŸ“š Ricerca Scientifica',
                'science_physics': 'âš›ï¸ Calcoli Fisica',
                'science_biology': 'ðŸ§¬ Analisi Biologica',
                'science_simulation': 'ðŸ“Š Simulazione',
                // Chemistry
                'chemistry_compounds': 'âš—ï¸ Analisi Composti',
                'chemistry_reactions': 'ðŸ’¥ Reazioni Chimiche',
                'chemistry_periodic': 'ðŸ“‹ Tavola Periodica',
                'chemistry_molecular': 'ðŸ”— Modelli Molecolari',
                // Archaeology
                'archaeology_artifacts': 'ðŸº Catalogo Reperti',
                'archaeology_dating': 'ðŸ“… Datazione',
                'archaeology_civilizations': 'ðŸ—¿ CiviltÃ  Antiche',
                'archaeology_sites': 'ðŸ—ºï¸ Siti Archeologici',
                // Military
                'military_strategy': 'ðŸ“‹ Analisi Strategica',
                'military_intel': 'ðŸ” Intelligence',
                'military_logistics': 'ðŸ“¦ Logistica',
                'military_defense': 'ðŸ›¡ï¸ Difesa',
                // Monitor
                'monitor_system': 'ðŸ’» Monitoraggio Sistema',
                'monitor_network': 'ðŸŒ Monitoraggio Rete',
                'monitor_performance': 'ðŸ“ˆ Performance',
                'monitor_logs': 'ðŸ“œ Analisi Logs',
                // Cyber
                'cyber_threat_scan': 'ðŸ”´ Scansione Minacce',
                'cyber_intrusion': 'ðŸš¨ Rilevamento Intrusioni',
                'cyber_encryption': 'ðŸ” Crittografia',
                'cyber_pentest': 'ðŸ’€ Penetration Test',
                // Analysis
                'analysis_text': 'ðŸ“ Analisi Testuale',
                'analysis_sentiment': 'ðŸ˜Š Sentiment Analysis',
                'analysis_summary': 'ðŸ“‹ Riassunto Automatico',
                'analysis_translate': 'ðŸŒ Traduzione',
                'analysis_code': 'ðŸ’» Analisi Codice',
                // Utilities
                'utilities_calculator': 'ðŸ§® Calcolatrice',
                'utilities_converter': 'ðŸ”„ Convertitore',
                'utilities_timer': 'â° Timer/Promemoria',
                'utilities_weather': 'ðŸŒ¤ï¸ Meteo',
                'utilities_qrcode': 'ðŸ“± QR Code',
                // AI Tools
                'ai_image_gen': 'ðŸŽ¨ Genera Immagine',
                'ai_image_analyze': 'ðŸ‘ï¸ Analizza Immagine',
                'ai_voice': 'ðŸŽ¤ Assistente Vocale',
                'ai_reasoning': 'ðŸ§  Deep Reasoning',
                'ai_creative': 'âœ¨ Scrittura Creativa',
                // Data
                'data_export': 'ðŸ“¤ Esporta Chat',
                'data_import': 'ðŸ“¥ Importa Dati',
                'data_backup': 'ðŸ’¿ Backup',
                'data_history': 'ðŸ“œ Cronologia',
                'data_settings': 'âš™ï¸ Impostazioni'
            };
            
            const key = `${category}_${action}`;
            const toolName = toolNames[key] || `${category} - ${action}`;
            
            showToolbarLoading(`Esecuzione: ${toolName}`);
            
            try {
                // Call GIDEON backend API
                const response = await fetch(`${API_BASE}/api/gideon/tools/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        category: category,
                        action: action,
                        session_id: state.sessionId,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                hideToolbarLoading();
                
                // Check if AI fallback is needed
                if (result.use_ai_fallback) {
                    const query = buildToolQuery(category, action);
                    await processWithGideonAI(category, action, query, toolName);
                    return;
                }
                
                // Format and display results
                const formattedContent = formatToolResult(category, action, result);
                showResultsPanel(toolName, formattedContent);
                
                // Also add to chat as system message
                addMessage('assistant', `âœ… **${toolName}** completato.\n\n${result.summary || 'Operazione eseguita con successo.'}`);
                
            } catch (error) {
                hideToolbarLoading();
                console.error('Tool execution error:', error);
                
                // Fallback: use GIDEON AI to process the request
                const query = buildToolQuery(category, action);
                await processWithGideonAI(category, action, query, toolName);
            }
        }
        
        // Build natural language query for the tool
        function buildToolQuery(category, action) {
            const queries = {
                // Security
                'security_full_scan': 'Esegui una scansione completa della sicurezza del sistema, analizza processi, porte aperte, servizi attivi e potenziali minacce.',
                'security_vuln_check': 'Verifica le vulnerabilitÃ  del sistema, controlla aggiornamenti mancanti, configurazioni rischiose e punti deboli.',
                'security_firewall': 'Analizza lo stato del firewall, regole attive, porte bloccate e traffico di rete.',
                'security_audit': 'Esegui un audit completo della sicurezza del sistema con raccomandazioni.',
                // Health
                'health_diagnostics': 'Fornisci informazioni su diagnostica medica e analisi dei sintomi. Chiedi i sintomi da analizzare.',
                'health_medications': 'Fornisci informazioni su farmaci, interazioni e dosaggi. Chiedi quale farmaco analizzare.',
                'health_wellness': 'Analizza lo stato di benessere generale e fornisci raccomandazioni per la salute.',
                'health_emergency': 'Protocollo emergenza medica: fornisci istruzioni per primo soccorso e numeri utili.',
                // Science
                'science_research': 'Cerca articoli scientifici e ricerche recenti. Chiedi l\'argomento da ricercare.',
                'science_physics': 'Esegui calcoli di fisica e spiega concetti fisici. Chiedi il problema da risolvere.',
                'science_biology': 'Analisi biologica: genetica, cellulare, ecosistemi. Chiedi cosa analizzare.',
                'science_simulation': 'Crea una simulazione scientifica o modello matematico.',
                // Chemistry
                'chemistry_compounds': 'Analizza composti chimici, struttura molecolare e proprietÃ . Chiedi quale composto.',
                'chemistry_reactions': 'Simula e spiega reazioni chimiche, bilanciamento equazioni.',
                'chemistry_periodic': 'Informazioni dettagliate sugli elementi della tavola periodica.',
                'chemistry_molecular': 'Crea e analizza modelli molecolari 3D.',
                // Archaeology
                'archaeology_artifacts': 'Database dei reperti archeologici, classificazione e storia.',
                'archaeology_dating': 'Metodi di datazione archeologica: carbonio-14, dendrocronologia, etc.',
                'archaeology_civilizations': 'Informazioni sulle civiltÃ  antiche: storia, cultura, tecnologia.',
                'archaeology_sites': 'Database dei siti archeologici mondiali con mappe e informazioni.',
                // Military
                'military_strategy': 'Analisi strategica militare, tattica e pianificazione.',
                'military_intel': 'Raccolta e analisi di intelligence, OSINT, SIGINT.',
                'military_logistics': 'Logistica militare: supply chain, movimentazione, supporto.',
                'military_defense': 'Sistemi di difesa, fortificazioni, protezione perimetrale.',
                // Monitor
                'monitor_system': 'Monitora CPU, RAM, disco, processi del sistema operativo.',
                'monitor_network': 'Analizza traffico di rete, connessioni attive, latenza.',
                'monitor_performance': 'Benchmark e analisi performance del sistema.',
                'monitor_logs': 'Analizza i log di sistema per errori e anomalie.',
                // Cyber
                'cyber_threat_scan': 'Scansione per malware, rootkit, backdoor e minacce attive.',
                'cyber_intrusion': 'Rilevamento intrusioni: analizza accessi sospetti e attivitÃ  anomale.',
                'cyber_encryption': 'Strumenti di crittografia: genera chiavi, cifra/decifra dati.',
                'cyber_pentest': 'Simulazione penetration test: identifica vulnerabilitÃ  sfruttabili.',
                // Analysis
                'analysis_text': 'Analizza il testo fornito: estrai keyword, conta parole, valuta leggibilitÃ  e struttura.',
                'analysis_sentiment': 'Esegui analisi del sentiment: identifica emozioni, tono, polaritÃ  positiva/negativa.',
                'analysis_summary': 'Crea un riassunto automatico del testo, estrai i punti chiave principali.',
                'analysis_translate': 'Traduci il testo nella lingua richiesta, mantieni il significato originale.',
                'analysis_code': 'Analizza il codice: trova bug, suggerisci ottimizzazioni, verifica sicurezza.',
                // Utilities
                'utilities_calculator': 'Calcolatrice scientifica: esegui calcoli matematici, equazioni, conversioni.',
                'utilities_converter': 'Converti unitÃ  di misura: lunghezza, peso, temperatura, valuta, dati.',
                'utilities_timer': 'Gestisci timer, sveglie e promemoria. Dimmi cosa impostare.',
                'utilities_weather': 'Fornisci previsioni meteo. Indica la cittÃ .',
                'utilities_qrcode': 'Genera o leggi QR Code. Dimmi il contenuto.',
                // AI Tools
                'ai_image_gen': 'Genera un\'immagine AI. Descrivi cosa vuoi creare.',
                'ai_image_analyze': 'Analizza un\'immagine: riconosci oggetti, scene, testo (OCR).',
                'ai_voice': 'Attiva l\'assistente vocale per comandi vocali.',
                'ai_reasoning': 'Attiva modalitÃ  deep reasoning per problemi complessi. Poni la tua domanda.',
                'ai_creative': 'Scrivi contenuti creativi: poesie, racconti, script, canzoni. Indica il tema.',
                // Data
                'data_export': 'Esporta la conversazione attuale. Scegli il formato: JSON, TXT, Markdown.',
                'data_import': 'Importa dati da file. Formati supportati: JSON, CSV, TXT.',
                'data_backup': 'Crea un backup dei dati e delle conversazioni.',
                'data_history': 'Mostra la cronologia delle conversazioni passate.',
                'data_settings': 'Apri le impostazioni: aspetto, notifiche, privacy, preferenze AI.'
            };
            
            return queries[`${category}_${action}`] || `Esegui ${action} nella categoria ${category}`;
        }
        
        // Process with GIDEON AI as fallback
        async function processWithGideonAI(category, action, query, toolName) {
            showToolbarLoading(`GIDEON sta elaborando: ${toolName}`);
            
            try {
                // Use WebSocket if available, otherwise REST API
                if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                    // Send via WebSocket
                    state.ws.send(JSON.stringify({
                        type: 'cognitive_process',
                        text: query,
                        session_id: state.sessionId,
                        context: {
                            tool_category: category,
                            tool_action: action,
                            request_type: 'tool_execution'
                        }
                    }));
                    
                    // Result will come via WebSocket message handler
                    setTimeout(() => hideToolbarLoading(), 5000); // Timeout safety
                    return;
                }
                
                // Fallback to REST API
                const response = await fetch(`${API_BASE}/api/gideon/process`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: query,
                        context: {
                            tool_category: category,
                            tool_action: action,
                            request_type: 'tool_execution'
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                hideToolbarLoading();
                
                const content = result.response || result.message || result.text || 'Elaborazione completata.';
                showResultsPanel(toolName, `<div class="result-section"><h4>ðŸ“Š Risultato GIDEON</h4><pre>${content}</pre></div>`);
                addMessage('assistant', `**${toolName}**\n\n${content}`);
                
            } catch (error) {
                hideToolbarLoading();
                console.error('GIDEON AI error:', error);
                showResultsPanel('âŒ Errore', `<div class="result-section" style="border-color: #ff4444;"><h4>Errore di Elaborazione</h4><p>Non Ã¨ stato possibile completare l'operazione. Verifica che il backend GIDEON sia attivo su ${API_BASE}</p><p>Errore: ${error.message}</p></div>`);
            }
        }
        
        // Format tool results for display
        function formatToolResult(category, action, result) {
            let html = '';
            
            if (result.data) {
                html += `<div class="result-section"><h4>ðŸ“Š Dati</h4><pre>${JSON.stringify(result.data, null, 2)}</pre></div>`;
            }
            
            if (result.summary) {
                html += `<div class="result-section"><h4>ðŸ“ Riepilogo</h4><p>${result.summary}</p></div>`;
            }
            
            if (result.recommendations) {
                html += `<div class="result-section"><h4>ðŸ’¡ Raccomandazioni</h4><ul>`;
                result.recommendations.forEach(rec => {
                    html += `<li>${rec}</li>`;
                });
                html += `</ul></div>`;
            }
            
            if (result.status) {
                const statusColor = result.status === 'success' ? '#00ff88' : (result.status === 'warning' ? '#ffd700' : '#ff4444');
                html += `<div class="result-section" style="border-color: ${statusColor};"><h4>Stato: ${result.status.toUpperCase()}</h4></div>`;
            }
            
            if (!html) {
                html = `<div class="result-section"><h4>âœ… Operazione Completata</h4><pre>${JSON.stringify(result, null, 2)}</pre></div>`;
            }
            
            return html;
        }
        
        // ============ MODE COLORS ============
        const modeColors = {
            passive: '#888888',
            copilot: '#00f5ff',
            pilot: '#00ff88',
            executive: '#ff00ff'
        };
        
        const modeDescriptions = {
            passive: 'Solo risponde, nessuna azione',
            copilot: 'Suggerisce e chiede conferma',
            pilot: 'Controllo totale, esegue senza conferma'
        };
        
        // ============ ADVANCED TOOLS INTEGRATION ============
        
        // Execute advanced GIDEON tool
        async function executeAdvancedTool(tool, action, params = {}) {
            const toolNames = {
                // Security
                'security_predictive_risk_mapping': 'ðŸ”’ Predictive Risk Mapping',
                'security_anomaly_narrator': 'ðŸ”’ Anomaly Narrator',
                'security_defensive_scenario_simulator': 'ðŸ”’ Defensive Scenario Simulator',
                // Cyber
                'cyber_behavioral_baseline_builder': 'ðŸ›¡ï¸ Behavioral Baseline Builder',
                'cyber_incident_explainability_engine': 'ðŸ›¡ï¸ Incident Explainability Engine',
                'cyber_supply_chain_trust_scanner': 'ðŸ›¡ï¸ Supply Chain Trust Scanner',
                // Science
                'science_molecular_pattern_validator': 'ðŸ§¬ Molecular Pattern Validator',
                'science_environmental_contamination_scan': 'ðŸ§¬ Environmental Contamination Scan',
                'science_scientific_cross_check': 'ðŸ§¬ Scientific Cross-Check',
                // Archaeology
                'archaeology_predictive_reconstruction': 'ðŸ›ï¸ Predictive Reconstruction',
                'archaeology_temporal_layer_fusion': 'ðŸ›ï¸ Temporal Layer Fusion',
                'archaeology_authenticity_risk_assessment': 'ðŸ›ï¸ Authenticity Risk Assessment',
                // Core
                'core_multi_tool_reasoning': 'ðŸ§  Multi-Tool Reasoning',
                'core_confidence_weighted_output': 'ðŸ§  Confidence Weighted Output',
                'core_human_override_gate': 'ðŸ§  Human Override Gate',
                'core_audit_trail': 'ðŸ§  Audit Trail',
                'core_bias_and_drift_monitor': 'ðŸ§  Bias & Drift Monitor',
                'core_failsafe_trigger': 'ðŸ§  Failsafe Trigger'
            };
            
            const key = `${tool}_${action}`;
            const toolName = toolNames[key] || `${tool} - ${action}`;
            
            showToolbarLoading(`Esecuzione avanzata: ${toolName}`);
            
            try {
                const response = await fetch(`${API_BASE}/api/gideon/tools/advanced/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tool: tool,
                        action: action,
                        params: params
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                hideToolbarLoading();
                
                // Format advanced tool result
                const formattedContent = formatAdvancedToolResult(tool, action, result);
                showResultsPanel(toolName, formattedContent);
                
                // Add summary to chat
                const summary = result.summary || 'Operazione completata.';
                const confidence = result.confidence ? ` (Confidenza: ${Math.round(result.confidence * 100)}%)` : '';
                addMessage('assistant', `âœ… **${toolName}** completato${confidence}.\n\n${summary}`);
                
            } catch (error) {
                hideToolbarLoading();
                console.error('Advanced tool error:', error);
                showResultsPanel('âŒ Errore', `<div class="result-section" style="border-color: #ff4444;"><h4>Errore Tool Avanzato</h4><p>${error.message}</p></div>`);
            }
        }
        
        // Format advanced tool results
        function formatAdvancedToolResult(tool, action, result) {
            let html = '';
            
            // Confidence badge
            if (result.confidence !== undefined) {
                const confPercent = Math.round(result.confidence * 100);
                const confColor = confPercent >= 80 ? '#00ff88' : (confPercent >= 60 ? '#ffd700' : '#ff4444');
                html += `<div class="result-section" style="border-color: ${confColor};">
                    <h4>ðŸ“Š Confidenza: ${confPercent}%</h4>
                    <div style="background: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; height: 10px;">
                        <div style="width: ${confPercent}%; height: 100%; background: ${confColor};"></div>
                    </div>
                </div>`;
            }
            
            // Main data
            if (result.data) {
                html += `<div class="result-section"><h4>ðŸ“‹ Analisi</h4><pre style="max-height: 400px; overflow-y: auto;">${JSON.stringify(result.data, null, 2)}</pre></div>`;
            }
            
            // Summary
            if (result.summary) {
                html += `<div class="result-section"><h4>ðŸ“ Riepilogo</h4><p>${result.summary}</p></div>`;
            }
            
            // Recommendations
            if (result.recommendations && result.recommendations.length > 0) {
                html += `<div class="result-section"><h4>ðŸ’¡ Raccomandazioni</h4><ul>`;
                result.recommendations.forEach(rec => {
                    html += `<li>${rec}</li>`;
                });
                html += `</ul></div>`;
            }
            
            // Disclaimer
            if (result.disclaimer) {
                html += `<div class="result-section" style="border-color: #ffd700; background: rgba(255,215,0,0.1);">
                    <h4>âš ï¸ Disclaimer</h4>
                    <p style="font-size: 0.9em;">${result.disclaimer}</p>
                </div>`;
            }
            
            // Error handling
            if (!result.success && result.error) {
                html = `<div class="result-section" style="border-color: #ff4444;">
                    <h4>âŒ Errore</h4>
                    <p>${result.error}</p>
                    ${result.message ? `<p>${result.message}</p>` : ''}
                </div>`;
            }
            
            return html || `<div class="result-section"><h4>âœ… Completato</h4><pre>${JSON.stringify(result, null, 2)}</pre></div>`;
        }
        
        // Get advanced tool capabilities
        async function loadAdvancedCapabilities() {
            try {
                const response = await fetch(`${API_BASE}/api/gideon/tools/advanced/capabilities`);
                if (response.ok) {
                    const data = await response.json();
                    return data.capabilities || {};
                }
            } catch (e) {
                console.error('Failed to load advanced capabilities:', e);
            }
            return {};
        }
        
        // ============ INITIALIZATION ============
        function init() {
            document.getElementById('welcome-time').textContent = formatTime(new Date());
            document.getElementById('today-date').textContent = formatDate(new Date());
            
            chatInput.addEventListener('input', handleInputChange);
            chatInput.addEventListener('keydown', handleKeyDown);
            sendBtn.addEventListener('click', sendMessage);
            stopBtn.addEventListener('click', stopResponse);
            
            modeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.mode === 'pilot') {
                        showPilotDialog();
                    } else {
                        changeMode(btn.dataset.mode);
                    }
                });
            });
            
            // Quick actions - support both messages and direct actions
            quickActions.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.action) {
                        // Direct action execution
                        const params = btn.dataset.params ? JSON.parse(btn.dataset.params) : {};
                        executeAction(btn.dataset.action, params);
                    } else if (btn.dataset.message) {
                        // Send as chat message
                        chatInput.value = btn.dataset.message;
                        handleInputChange();
                        sendMessage();
                    }
                });
            });
            
            // Response mode selector
            document.querySelectorAll('.response-mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    setResponseMode(btn.dataset.mode);
                });
            });
            
            chatInput.addEventListener('input', autoResizeTextarea);
            setInterval(updateSessionTime, 1000);
            initWebSocket();
            initVoiceRecognition();
            
            // Voice controls
            voiceBtn.addEventListener('click', toggleVoiceRecognition);
            voiceActivateBtn.addEventListener('click', toggleVoiceRecognition);
            handsfreeToggle.addEventListener('click', toggleHandsFree);
            ttsToggle.addEventListener('click', toggleTTS);
            stopSpeechBtn.addEventListener('click', stopSpeech);
            avatar.addEventListener('click', stopSpeech); // Click avatar to stop speech
            
            chatInput.focus();
            
            // Check TTS voices availability
            if (state.synthesis) {
                // Voices may not be loaded immediately
                if (state.synthesis.getVoices().length > 0) {
                    checkTTSVoices();
                } else {
                    state.synthesis.onvoiceschanged = checkTTSVoices;
                }
            }
            
            // Welcome speech
            if (state.isTTSEnabled) {
                setTimeout(() => speak("Ciao! Sono Gideon, pronto ad aiutarti."), 1000);
            }
        }
        
        // ============ WEBSOCKET ============
        let wsReconnectAttempts = 0;
        const WS_MAX_RECONNECT = 10;
        const WS_RECONNECT_DELAY = 3000;
        
        function initWebSocket() {
            try {
                if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                    console.log('WebSocket already connected');
                    return;
                }
                
                state.ws = new WebSocket(`${WS_BASE}/ws`);
                
                state.ws.onopen = () => {
                    console.log('âœ… WebSocket connected');
                    wsReconnectAttempts = 0;
                    updateStatus('Online â€¢ WebSocket Connesso');
                    updateDebugWsStatus('connected');
                    debugLog('WebSocket connesso con successo', 'success');
                    
                    // Send initial handshake
                    state.ws.send(JSON.stringify({
                        type: 'handshake',
                        payload: {
                            sessionId: state.sessionId,
                            mode: state.currentMode,
                            timestamp: Date.now()
                        }
                    }));
                };
                
                state.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (e) {
                        console.error('WebSocket parse error:', e);
                        debugLog(`WS parse error: ${e.message}`, 'error');
                    }
                };
                
                state.ws.onclose = (event) => {
                    console.log('WebSocket disconnected, code:', event.code);
                    updateDebugWsStatus('disconnected');
                    
                    if (wsReconnectAttempts < WS_MAX_RECONNECT) {
                        wsReconnectAttempts++;
                        updateStatus(`Offline â€¢ Riconnessione ${wsReconnectAttempts}/${WS_MAX_RECONNECT}...`);
                        debugLog(`WebSocket chiuso. Tentativo riconnessione ${wsReconnectAttempts}`, 'info');
                        setTimeout(initWebSocket, WS_RECONNECT_DELAY);
                    } else {
                        updateStatus('Offline â€¢ WebSocket non disponibile');
                        debugLog('WebSocket: max tentativi raggiunti, uso REST API', 'error');
                    }
                };
                
                state.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateDebugWsStatus('error');
                    debugLog('WebSocket errore connessione', 'error');
                };
            } catch (e) {
                console.log('WebSocket not available, using REST API');
                debugLog('WebSocket non disponibile, uso REST API', 'info');
                updateDebugWsStatus('unavailable');
            }
        }
        
        function updateDebugWsStatus(status) {
            const wsStatus = document.getElementById('debug-ws-status');
            if (!wsStatus) return;
            
            const statusMap = {
                connected: 'âœ… Connesso',
                disconnected: 'âŒ Disconnesso',
                error: 'âš ï¸ Errore',
                unavailable: 'ðŸš« Non disponibile',
                connecting: 'ðŸ”„ Connessione...'
            };
            wsStatus.innerHTML = statusMap[status] || status;
        }
        
        function sendViaWebSocket(type, payload) {
            if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                state.ws.send(JSON.stringify({ type, payload }));
                debugLog(`WS Sent: ${type}`, 'info');
                return true;
            }
            debugLog(`WS not available for: ${type}`, 'info');
            return false;
        }
        
        function handleWebSocketMessage(data) {
            debugLog(`WS Received: ${data.type}`, 'info');
            
            switch(data.type) {
                case 'reasoning_step':
                    showReasoningStep(data.step);
                    break;
                    
                case 'response':
                case 'message_result':
                case 'command_result':
                    hideTyping();
                    const payload = data.payload || data;
                    addAssistantMessage(
                        payload.text || payload.response || data.text,
                        payload.mode || state.currentMode,
                        payload.confidence || 0.9
                    );
                    // TTS for response
                    if (state.isTTSEnabled && payload.text) {
                        speak(payload.text);
                    }
                    break;
                    
                case 'cognitive_result':
                    hideTyping();
                    const cogPayload = data.payload || {};
                    addAssistantMessage(
                        cogPayload.response || cogPayload.text,
                        state.currentMode,
                        cogPayload.confidence || 0.95
                    );
                    if (state.isTTSEnabled && cogPayload.response) {
                        speak(cogPayload.response);
                    }
                    break;
                    
                case 'mode_changed':
                    const modeInfo = data.payload || data;
                    updateModeUI(modeInfo.mode || modeInfo.name);
                    debugLog(`Mode changed to: ${modeInfo.mode || modeInfo.name}`, 'success');
                    break;
                    
                case 'action_executed':
                    const action = data.payload || {};
                    addSystemMessage(`âœ… Azione eseguita: ${action.action || action.name}`);
                    debugLog(`Action executed: ${action.action}`, 'success');
                    break;
                    
                case 'error':
                    const error = data.payload || data;
                    addSystemMessage(`âŒ Errore: ${error.error || error.message}`);
                    debugLog(`Server error: ${error.error}`, 'error');
                    break;
                    
                case 'system_status':
                    // Real-time system updates
                    updateSystemStatus(data.payload);
                    break;
                    
                case 'notification':
                    showNotification(data.payload);
                    break;
                    
                case 'pong':
                    // Heartbeat response
                    debugLog('Heartbeat OK', 'success');
                    break;
                    
                default:
                    console.log('Unknown WS message type:', data.type);
            }
        }
        
        function updateSystemStatus(status) {
            if (status.cpu) document.getElementById('debug-cpu')?.textContent = status.cpu + '%';
            if (status.ram) document.getElementById('debug-ram')?.textContent = status.ram + '%';
        }
        
        function showNotification(notification) {
            const text = notification.text || notification.message;
            const type = notification.type || 'info';
            addSystemMessage(`ðŸ”” ${text}`);
            if (state.isTTSEnabled && notification.speak) {
                speak(text);
            }
        }
        
        // WebSocket heartbeat to keep connection alive
        setInterval(() => {
            if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                state.ws.send(JSON.stringify({ type: 'ping', payload: { timestamp: Date.now() } }));
            }
        }, 30000);
        
        // ============ RESPONSE MODE ============
        function setResponseMode(mode) {
            state.responseMode = mode;
            
            // Update UI
            document.querySelectorAll('.response-mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });
            
            // Show feedback
            const modeNames = {
                eco: 'ðŸ’š ECO - Risposte brevi',
                fast: 'âš¡ FAST - Bilanciato',
                deep: 'ðŸ§  DEEP - Approfondito'
            };
            addSystemMessage(`ModalitÃ : ${modeNames[mode] || mode}`);
        }
        
        // ============ MESSAGE HANDLING ============
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || state.isProcessing) return;
            
            state.isProcessing = true;
            state.abortController = new AbortController();
            sendBtn.disabled = true;
            sendBtn.classList.add('hidden');
            stopBtn.classList.add('active');
            
            addUserMessage(message);
            chatInput.value = '';
            autoResizeTextarea();
            handleInputChange();
            showTyping();
            
            state.conversationContext.push({
                role: 'user',
                content: message,
                timestamp: Date.now()
            });
            
            // Try WebSocket first for real-time communication
            const wsAvailable = state.ws && state.ws.readyState === WebSocket.OPEN;
            
            if (wsAvailable && !state.isTTSEnabled) {
                // Use WebSocket for faster response (no TTS needed via WS)
                debugLog('Sending via WebSocket...', 'info');
                sendViaWebSocket('text_message', {
                    text: message,
                    session_id: state.sessionId,
                    mode: state.currentMode,
                    response_mode: state.responseMode
                });
                // Response will come via handleWebSocketMessage
                return;
            }
            
            try {
                // ðŸš€ FAST ENDPOINT: Chat + Voice in one request (eliminates lag)
                const useFastEndpoint = state.isTTSEnabled;
                const endpoint = useFastEndpoint 
                    ? `${API_BASE}/api/chat/send-with-voice`
                    : `${API_BASE}/api/chat/send`;
                
                debugLog(`Sending via REST: ${endpoint}`, 'info');
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        session_id: state.sessionId,
                        mode: state.currentMode,
                        response_mode: state.responseMode,  // eco, fast, deep
                        include_voice: useFastEndpoint
                    }),
                    signal: state.abortController.signal
                });
                
                if (response.ok) {
                    const data = await response.json();
                    hideTyping();
                    
                    // Add message to UI
                    addAssistantMessageFast(
                        data.response || data.text || "Risposta ricevuta",
                        data.mode || state.currentMode,
                        data.confidence || 0.9
                    );
                    
                    // ðŸ”Š Play audio immediately if available (no second request!)
                    if (useFastEndpoint && data.audio_base64) {
                        playAudioFromBase64(data.audio_base64);
                    }
                    
                    // Also notify via WebSocket if connected
                    if (wsAvailable) {
                        sendViaWebSocket('message_received', {
                            text: data.response,
                            timestamp: Date.now()
                        });
                    }
                } else {
                    throw new Error('API error');
                }
            } catch (error) {
                hideTyping();
                if (error.name === 'AbortError') {
                    addSystemMessage("â¹ï¸ Risposta interrotta. Puoi fare una nuova domanda.");
                    stopSpeech();
                } else {
                    console.error('Error:', error);
                    debugLog(`Send error: ${error.message}`, 'error');
                    addAssistantMessageFast(
                        "âš ï¸ Errore di connessione. Verifica che il backend sia attivo.",
                        state.currentMode,
                        0.5
                    );
                }
            }
            
            finishProcessing();
        }
        
        // Send message via WebSocket (for real-time streaming)
        function sendMessageViaWS(message) {
            if (!state.ws || state.ws.readyState !== WebSocket.OPEN) {
                debugLog('WebSocket not available, falling back to REST', 'info');
                return false;
            }
            
            sendViaWebSocket('cognitive_process', {
                text: message,
                context: {
                    session_id: state.sessionId,
                    mode: state.currentMode,
                    response_mode: state.responseMode,
                    history: state.conversationContext.slice(-5)
                }
            });
            
            return true;
        }
        
        // ðŸ”Š Play audio from base64 string (no HTTP request needed!)
        function playAudioFromBase64(base64Audio) {
            if (!base64Audio) return;
            
            try {
                // Convert base64 to blob
                const binaryString = atob(base64Audio);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const audioBlob = new Blob([bytes], { type: 'audio/mpeg' });
                const audioUrl = URL.createObjectURL(audioBlob);
                
                // Play immediately
                state.isSpeaking = true;
                avatar.classList.add('speaking');
                ttsToggle.classList.add('speaking');
                stopSpeechBtn.classList.add('active');
                showTTSStatus('ðŸ”Š GIDEON sta parlando...', 'speaking');
                
                gideonAudioPlayer.src = audioUrl;
                gideonAudioPlayer.play().catch(e => {
                    console.error('Playback error:', e);
                    state.isSpeaking = false;
                    avatar.classList.remove('speaking');
                });
            } catch (e) {
                console.error('Audio decode error:', e);
            }
        }
        
        // Fast version that doesn't trigger separate TTS call
        function addAssistantMessageFast(text, mode, confidence = 0.9) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            
            const formattedText = formatText(text);
            
            let confClass = 'confidence-high';
            if (confidence < 0.6) confClass = 'confidence-low';
            else if (confidence < 0.8) confClass = 'confidence-medium';
            
            messageDiv.innerHTML = `
                <div class="message-content" style="border-left-color: ${modeColors[mode] || modeColors.copilot}">
                    ${formattedText}
                    <div class="confidence-bar ${confClass}">
                        <div class="confidence-fill" style="width: ${confidence * 100}%"></div>
                    </div>
                </div>
                <div class="message-meta">
                    <span class="message-mode-badge" style="color: ${modeColors[mode] || modeColors.copilot}">${(mode || 'copilot').toUpperCase()}</span>
                    <span>${formatTime(new Date())}</span>
                </div>
            `;
            
            insertBeforeTyping(messageDiv);
            scrollToBottom();
            
            state.messages.push({ role: 'assistant', text, mode, confidence, timestamp: Date.now() });
            state.conversationContext.push({
                role: 'assistant',
                content: text,
                timestamp: Date.now()
            });
            
            updateStats();
            // NOTE: No speak() call here - audio comes from combined endpoint!
        }
        
        
        function finishProcessing() {
            state.isProcessing = false;
            state.abortController = null;
            stopBtn.classList.remove('active');
            sendBtn.classList.remove('hidden');
            sendBtn.disabled = !chatInput.value.trim();
            state.turnCount++;
            updateStats();
        }
        
        function stopResponse() {
            if (state.abortController) {
                state.abortController.abort();
            }
            // Stop TTS
            if (state.synthesis.speaking) {
                state.synthesis.cancel();
                state.isSpeaking = false;
            }
            hideTyping();
        }
        
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-content">${escapeHtml(text)}</div>
                <div class="message-meta">
                    <span>${formatTime(new Date())}</span>
                    <span>âœ“âœ“</span>
                </div>
            `;
            
            insertBeforeTyping(messageDiv);
            scrollToBottom();
            
            state.messages.push({ role: 'user', text, timestamp: Date.now() });
            updateStats();
        }
        
        function addAssistantMessage(text, mode, confidence = 0.9) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            
            const formattedText = formatText(text);
            
            let confClass = 'confidence-high';
            if (confidence < 0.6) confClass = 'confidence-low';
            else if (confidence < 0.8) confClass = 'confidence-medium';
            
            messageDiv.innerHTML = `
                <div class="message-content" style="border-left-color: ${modeColors[mode] || modeColors.copilot}">
                    ${formattedText}
                    <div class="confidence-bar ${confClass}">
                        <div class="confidence-fill" style="width: ${confidence * 100}%"></div>
                    </div>
                </div>
                <div class="message-meta">
                    <span class="message-mode-badge" style="color: ${modeColors[mode] || modeColors.copilot}">${(mode || 'copilot').toUpperCase()}</span>
                    <span>${formatTime(new Date())}</span>
                </div>
            `;
            
            insertBeforeTyping(messageDiv);
            scrollToBottom();
            
            state.messages.push({ role: 'assistant', text, mode, confidence, timestamp: Date.now() });
            state.conversationContext.push({
                role: 'assistant',
                content: text,
                timestamp: Date.now()
            });
            
            updateStats();
            
            // TTS: GIDEON speaks the response
            if (state.isTTSEnabled) {
                speak(text);
            }
        }
        
        function insertBeforeTyping(element) {
            chatContainer.insertBefore(element, typingIndicator);
        }
        
        // ============ TYPING INDICATOR ============
        function showTyping() {
            typingIndicator.classList.add('active');
            scrollToBottom();
            updateStatus('Elaborando...');
        }
        
        function hideTyping() {
            typingIndicator.classList.remove('active');
            reasoningPreview.classList.remove('active');
            updateStatus('Online â€¢ Pronto ad aiutarti');
        }
        
        function showReasoningStep(step) {
            reasoningPreview.textContent = `ðŸ§  ${step}`;
            reasoningPreview.classList.add('active');
        }
        
        // ============ MODE MANAGEMENT ============
        function changeMode(mode) {
            state.currentMode = mode;
            updateModeUI(mode);
            addSystemMessage(`ModalitÃ  cambiata: ${mode.toUpperCase()} - ${modeDescriptions[mode]}`);
            
            // Notify backend via WebSocket
            if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                sendViaWebSocket('set_mode', { mode: mode });
                debugLog(`Mode changed via WebSocket: ${mode}`, 'info');
            }
        }
        
        function updateModeUI(mode) {
            document.documentElement.style.setProperty('--current-mode-color', modeColors[mode]);
            modeText.textContent = mode.toUpperCase();
            
            modeBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            document.querySelector('.avatar').style.boxShadow = `0 0 30px ${modeColors[mode]}`;
            document.querySelector('.avatar').style.borderColor = modeColors[mode];
            
            // Update debug panel
            const debugMode = document.getElementById('debug-mode');
            if (debugMode) debugMode.textContent = mode.toUpperCase();
        }
        
        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'date-divider';
            messageDiv.innerHTML = `<span>âš™ï¸ ${text}</span>`;
            insertBeforeTyping(messageDiv);
            scrollToBottom();
        }
        
        // ============ UI HELPERS ============
        function handleInputChange() {
            const hasText = chatInput.value.trim().length > 0;
            sendBtn.disabled = !hasText || state.isProcessing;
        }
        
        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        function autoResizeTextarea() {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
        }
        
        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }
        
        function updateStatus(text) {
            statusText.textContent = text;
        }
        
        function updateStats() {
            msgCount.textContent = state.messages.length;
            turnCount.textContent = state.turnCount;
        }
        
        function updateSessionTime() {
            const elapsed = Math.floor((Date.now() - state.sessionStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            sessionTime.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // ============ FORMATTING ============
        function formatTime(date) {
            return date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
        }
        
        function formatDate(date) {
            const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('it-IT', options).toUpperCase();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatText(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }
        
        // ============ VOICE RECOGNITION ============
        function initVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('Speech Recognition not supported');
                voiceBtn.style.display = 'none';
                voiceActivateBtn.style.display = 'none';
                handsfreeToggle.style.display = 'none';
                addSystemMessage('âš ï¸ Riconoscimento vocale non supportato dal browser');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            state.recognition = new SpeechRecognition();
            state.recognition.lang = 'it-IT';
            state.recognition.continuous = true;
            state.recognition.interimResults = true;
            state.recognition.maxAlternatives = 1;
            
            state.recognition.onstart = () => {
                state.isListening = true;
                voiceBtn.classList.add('listening');
                voiceActivateBtn.classList.add('listening');
                voiceActivateBtn.querySelector('span').textContent = 'ASCOLTANDO...';
                voiceStatusBar.classList.add('active');
                voiceTranscript.textContent = 'In ascolto...';
                updateStatus('ðŸŽ¤ In ascolto...');
            };
            
            state.recognition.onend = () => {
                state.isListening = false;
                voiceBtn.classList.remove('listening');
                voiceActivateBtn.classList.remove('listening');
                voiceActivateBtn.querySelector('span').textContent = 'PARLA';
                
                // Restart if hands-free mode
                if (state.isHandsFree && !state.isProcessing && !state.isSpeaking) {
                    setTimeout(() => {
                        if (state.isHandsFree) {
                            try { state.recognition.start(); } catch(e) {}
                        }
                    }, 500);
                } else {
                    voiceStatusBar.classList.remove('active');
                    updateStatus('Online â€¢ Pronto ad aiutarti');
                }
            };
            
            state.recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Show interim results
                if (interimTranscript) {
                    voiceTranscript.textContent = 'ðŸŽ¤ ' + interimTranscript;
                }
                
                // Process final result
                if (finalTranscript.trim()) {
                    voiceTranscript.textContent = 'âœ“ ' + finalTranscript;
                    
                    // Check for wake word in hands-free mode
                    const text = finalTranscript.toLowerCase().trim();
                    
                    // Wake words: "gideon", "ehi gideon", "ok gideon"
                    const wakeWords = ['gideon', 'ehi gideon', 'ok gideon', 'hey gideon'];
                    const hasWakeWord = wakeWords.some(w => text.includes(w));
                    
                    if (state.isHandsFree) {
                        // In hands-free, process commands after wake word
                        if (hasWakeWord) {
                            // Extract command after wake word
                            let command = text;
                            wakeWords.forEach(w => {
                                command = command.replace(w, '').trim();
                            });
                            
                            if (command) {
                                processVoiceCommand(command);
                            } else {
                                speak("SÃ¬? Come posso aiutarti?");
                            }
                        }
                    } else {
                        // Not hands-free: process any spoken text
                        processVoiceCommand(finalTranscript.trim());
                    }
                }
            };
            
            state.recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech' && state.isHandsFree) {
                    // Continue listening in hands-free mode
                    return;
                }
                voiceBtn.classList.remove('listening');
                voiceStatusBar.classList.remove('active');
                
                if (event.error === 'not-allowed') {
                    addSystemMessage('âš ï¸ Microfono non autorizzato. Abilita l\'accesso al microfono nelle impostazioni del browser.');
                }
            };
        }
        
        function toggleVoiceRecognition() {
            if (!state.recognition) {
                addSystemMessage('âš ï¸ Riconoscimento vocale non supportato');
                return;
            }
            
            if (state.isListening) {
                state.recognition.stop();
            } else {
                try {
                    state.recognition.start();
                } catch (e) {
                    console.error('Error starting recognition:', e);
                }
            }
        }
        
        function toggleHandsFree() {
            state.isHandsFree = !state.isHandsFree;
            handsfreeToggle.classList.toggle('active', state.isHandsFree);
            
            if (state.isHandsFree) {
                addSystemMessage('ðŸŽ¤ ModalitÃ  Hands-Free ATTIVA - DÃ¬ "Gideon" seguito dal comando');
                if (!state.isListening && state.recognition) {
                    try { state.recognition.start(); } catch(e) {}
                }
            } else {
                addSystemMessage('ðŸŽ¤ ModalitÃ  Hands-Free disattivata');
                if (state.isListening && state.recognition) {
                    state.recognition.stop();
                }
            }
        }
        
        function toggleTTS() {
            state.isTTSEnabled = !state.isTTSEnabled;
            ttsToggle.classList.toggle('active', state.isTTSEnabled);
            
            if (state.isTTSEnabled) {
                addSystemMessage('ðŸ”Š Text-to-Speech ATTIVO - GIDEON parlerÃ ');
                showTTSStatus('ðŸ”Š TTS Attivato', 'speaking');
                speak("TTS attivato");
            } else {
                state.synthesis.cancel();
                addSystemMessage('ðŸ”‡ Text-to-Speech disattivato');
                showTTSStatus('ðŸ”‡ TTS Disattivato', '');
            }
        }
        
        function checkTTSVoices() {
            const ttsStatusIndicator = document.getElementById('tts-status-indicator');
            const ttsStatusText = document.getElementById('tts-status-text');
            
            if (!state.synthesis) {
                ttsToggle.classList.add('no-voices');
                showTTSStatus('âŒ TTS Non Supportato', 'error');
                console.error('TTS: SpeechSynthesis non supportato');
                return;
            }
            
            const voices = state.synthesis.getVoices();
            const italianVoices = voices.filter(v => v.lang.startsWith('it') || v.lang.includes('IT'));
            
            console.log('TTS Voices disponibili:', voices.length);
            console.log('TTS Voci italiane:', italianVoices.length, italianVoices.map(v => v.name));
            
            if (voices.length === 0) {
                ttsToggle.classList.add('no-voices');
                showTTSStatus('âš ï¸ Caricamento voci...', 'error');
                // Riprova dopo un secondo
                setTimeout(checkTTSVoices, 1000);
            } else if (italianVoices.length === 0) {
                showTTSStatus('âš ï¸ Nessuna voce italiana (usando ' + (voices[0]?.name || 'default') + ')', '');
                setTimeout(() => hideTTSStatus(), 5000);
            } else {
                showTTSStatus('âœ… TTS Pronto - ' + italianVoices[0].name, 'speaking');
                setTimeout(() => hideTTSStatus(), 3000);
            }
        }
        
        function showTTSStatus(message, statusClass) {
            const ttsStatusIndicator = document.getElementById('tts-status-indicator');
            const ttsStatusText = document.getElementById('tts-status-text');
            
            ttsStatusText.textContent = message;
            ttsStatusIndicator.className = 'tts-status-indicator visible';
            if (statusClass) {
                ttsStatusIndicator.classList.add(statusClass);
            }
        }
        
        function hideTTSStatus() {
            const ttsStatusIndicator = document.getElementById('tts-status-indicator');
            ttsStatusIndicator.classList.remove('visible');
        }
        
        function processVoiceCommand(text) {
            chatInput.value = text;
            handleInputChange();
            sendMessage();
        }
        
        // ============ TEXT-TO-SPEECH - VOCE DI GIDEON ============
        // La voce di Gideon viene generata dal backend con Edge TTS (alta qualitÃ )
        
        // Unlock audio on first user interaction (Chrome autoplay policy)
        function unlockAudio() {
            if (audioUnlocked) return;
            gideonAudioPlayer.play().then(() => {
                gideonAudioPlayer.pause();
                gideonAudioPlayer.currentTime = 0;
                audioUnlocked = true;
                console.log('ðŸ”Š Audio unlocked');
            }).catch(e => {});
        }
        document.addEventListener('click', unlockAudio, { once: true });
        document.addEventListener('touchstart', unlockAudio, { once: true });
        document.addEventListener('keydown', unlockAudio, { once: true });
        
        gideonAudioPlayer.addEventListener('ended', () => {
            state.isSpeaking = false;
            avatar.classList.remove('speaking');
            ttsToggle.classList.remove('speaking');
            stopSpeechBtn.classList.remove('active');
            hideTTSStatus();
            updateStatus('Online â€¢ Pronto ad aiutarti');
            
            // Resume listening in hands-free mode
            if (state.isHandsFree && state.recognition) {
                setTimeout(() => {
                    try { state.recognition.start(); } catch(e) {}
                }, 300);
            }
        });
        
        gideonAudioPlayer.addEventListener('error', (e) => {
            console.error('âŒ Audio playback error:', e);
            state.isSpeaking = false;
            avatar.classList.remove('speaking');
            ttsToggle.classList.remove('speaking');
            stopSpeechBtn.classList.remove('active');
            hideTTSStatus();
            // NO fallback - Gideon usa SOLO la sua voce ufficiale
            addSystemMessage('âš ï¸ Errore riproduzione audio. Riprova.');
        });
        
        // Funzione principale - FA PARLARE GIDEON
        async function speak(text) {
            if (!state.isTTSEnabled || !text || !text.trim()) return;
            
            console.log('ðŸŽ¤ Gideon sta parlando:', text.substring(0, 50) + '...');
            
            // Mostra indicatori
            state.isSpeaking = true;
            avatar.classList.add('speaking');
            ttsToggle.classList.add('speaking');
            stopSpeechBtn.classList.add('active');
            showTTSStatus('ðŸ”Š GIDEON sta parlando...', 'speaking');
            updateStatus('ðŸ”Š Gideon sta parlando...');
            
            // Pause recognition while speaking
            if (state.isListening && state.recognition) {
                state.recognition.stop();
            }
            
            try {
                // Richiedi audio al backend
                console.log('ðŸ”Š Requesting TTS from backend...');
                const response = await fetch(`${API_BASE}/api/tts/speak`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                
                if (!response.ok) {
                    throw new Error('TTS request failed: ' + response.status);
                }
                
                // Crea blob audio e riproduci
                const audioBlob = await response.blob();
                console.log('ðŸ”Š Audio blob received, size:', audioBlob.size);
                const audioUrl = URL.createObjectURL(audioBlob);
                
                gideonAudioPlayer.dataset.text = text;
                gideonAudioPlayer.src = audioUrl;
                
                // Play with promise handling
                const playPromise = gideonAudioPlayer.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('ðŸ”Š Audio playback started');
                    }).catch(error => {
                        console.error('ðŸ”‡ Autoplay blocked:', error);
                        // Show notification to click
                        addSystemMessage("ðŸ”Š Clicca sulla pagina per attivare l'audio, poi riprova!");
                        state.isSpeaking = false;
                        avatar.classList.remove('speaking');
                    });
                }
                
            } catch (error) {
                console.error('âŒ Gideon TTS error:', error);
                // NON usare fallback browser - la voce deve essere SEMPRE quella di GIDEON
                addSystemMessage('âš ï¸ Errore TTS: ' + error.message + '. Riprova o verifica che il backend sia attivo.');
                state.isSpeaking = false;
                avatar.classList.remove('speaking');
                ttsToggle.classList.remove('speaking');
                stopSpeechBtn.classList.remove('active');
                hideTTSStatus();
            }
        }
        
        // Test voice button function (call from console)
        window.testGideonVoice = function() {
            speak("Ciao! Sono Gideon, la mia voce funziona correttamente!");
        };
        
        // Funzione per fermare Gideon
        function stopSpeech() {
            // Ferma audio player
            if (gideonAudioPlayer) {
                gideonAudioPlayer.pause();
                gideonAudioPlayer.currentTime = 0;
            }
            
            // Ferma anche TTS browser se attivo
            if (state.synthesis && state.synthesis.speaking) {
                state.synthesis.cancel();
            }
            
            state.isSpeaking = false;
            avatar.classList.remove('speaking');
            ttsToggle.classList.remove('speaking');
            stopSpeechBtn.classList.remove('active');
            hideTTSStatus();
            updateStatus('Online â€¢ Voce interrotta');
            addSystemMessage("ðŸ”‡ Voce interrotta. Puoi fare una nuova domanda.");
            
            // Resume listening in hands-free mode
            if (state.isHandsFree && state.recognition) {
                setTimeout(() => {
                    try { state.recognition.start(); } catch(e) {}
                }, 300);
            }
        }
        
        // GIDEON USA SOLO LA SUA VOCE UFFICIALE (Edge TTS - it-IT-GiuseppeNeural)
        // Nessun fallback al TTS del browser - la voce di Gideon Ã¨ UNICA
        
        // ============ AUTOMATION PANEL ============
        function toggleAutomationPanel() {
            const panel = document.getElementById('automation-panel');
            panel.classList.toggle('active');
        }
        
        // ============ DEBUG PANEL ============
        let debugErrorCount = 0;
        let debugLogEntries = [];
        
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            const btn = document.getElementById('debug-btn');
            panel.classList.toggle('active');
            btn.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                refreshDebugInfo();
            }
        }
        
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { timestamp, message, type };
            debugLogEntries.push(entry);
            
            // Keep only last 100 entries
            if (debugLogEntries.length > 100) {
                debugLogEntries.shift();
            }
            
            const logContainer = document.getElementById('debug-log');
            if (logContainer) {
                const entryDiv = document.createElement('div');
                entryDiv.className = `debug-log-entry ${type}`;
                entryDiv.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
                logContainer.appendChild(entryDiv);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            if (type === 'error') {
                debugErrorCount++;
                const errorSpan = document.getElementById('debug-error-count');
                if (errorSpan) errorSpan.textContent = debugErrorCount;
            }
            
            console.log(`[DEBUG ${type.toUpperCase()}] ${message}`);
        }
        
        async function refreshDebugInfo() {
            // Connection status
            document.getElementById('debug-api-url').textContent = API_BASE;
            
            // Test backend
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    document.getElementById('debug-backend-status').innerHTML = 'âœ… Connesso';
                } else {
                    document.getElementById('debug-backend-status').innerHTML = 'âŒ Errore: ' + response.status;
                }
            } catch (e) {
                document.getElementById('debug-backend-status').innerHTML = 'âŒ Non raggiungibile';
            }
            
            // WebSocket status - Now properly integrated!
            const wsStatus = document.getElementById('debug-ws-status');
            if (state.ws) {
                switch(state.ws.readyState) {
                    case WebSocket.CONNECTING:
                        wsStatus.innerHTML = 'ðŸ”„ Connessione in corso...';
                        break;
                    case WebSocket.OPEN:
                        wsStatus.innerHTML = 'âœ… Connesso';
                        break;
                    case WebSocket.CLOSING:
                        wsStatus.innerHTML = 'â³ Chiusura in corso...';
                        break;
                    case WebSocket.CLOSED:
                        wsStatus.innerHTML = 'âŒ Disconnesso';
                        break;
                    default:
                        wsStatus.innerHTML = 'âš ï¸ Stato sconosciuto';
                }
            } else {
                wsStatus.innerHTML = 'ðŸ”„ Inizializzazione...';
                // Try to initialize WebSocket if not exists
                initWebSocket();
            }
            
            // TTS status
            document.getElementById('debug-tts-active').textContent = state.isTTSEnabled ? 'âœ… Attivo' : 'âŒ Disattivo';
            
            // Voice recognition
            const voiceRec = document.getElementById('debug-voice-rec');
            voiceRec.textContent = ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) ? 'âœ… Disponibile' : 'âŒ Non supportato';
            
            // Audio player
            const audioPlayer = document.getElementById('debug-audio-player');
            audioPlayer.textContent = gideonAudioPlayer ? 'âœ… Inizializzato' : 'âŒ Non inizializzato';
            
            // Mode
            document.getElementById('debug-mode').textContent = state.currentMode.toUpperCase();
            
            // Message count
            document.getElementById('debug-msg-count').textContent = state.messageCount || messageCount || 0;
            
            debugLog('Debug info refreshed', 'info');
        }
        
        // Test WebSocket connection
        async function testWebSocketConnection() {
            debugLog('Testing WebSocket connection...', 'info');
            
            if (!state.ws || state.ws.readyState !== WebSocket.OPEN) {
                debugLog('WebSocket not connected, attempting to connect...', 'info');
                initWebSocket();
                return;
            }
            
            // Send test message
            const testResult = sendViaWebSocket('ping', { test: true, timestamp: Date.now() });
            if (testResult) {
                debugLog('WebSocket ping sent', 'success');
            } else {
                debugLog('WebSocket ping failed', 'error');
            }
        }
        
        async function testBackendConnection() {
            debugLog('Testing backend connection...', 'info');
            
            try {
                // Test health endpoint
                const healthResponse = await fetch(`${API_BASE}/health`);
                if (healthResponse.ok) {
                    debugLog('âœ… Health endpoint OK', 'success');
                } else {
                    debugLog(`âŒ Health endpoint failed: ${healthResponse.status}`, 'error');
                }
                
                // Test chat endpoint
                const chatResponse = await fetch(`${API_BASE}/chat/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'ping' })
                });
                
                if (chatResponse.ok) {
                    const data = await chatResponse.json();
                    debugLog(`âœ… Chat endpoint OK - Response: ${data.response?.substring(0, 50)}...`, 'success');
                } else {
                    debugLog(`âŒ Chat endpoint failed: ${chatResponse.status}`, 'error');
                }
                
            } catch (e) {
                debugLog(`âŒ Connection error: ${e.message}`, 'error');
            }
        }
        
        function clearDebugLog() {
            const logContainer = document.getElementById('debug-log');
            if (logContainer) {
                logContainer.innerHTML = '';
            }
            debugLogEntries = [];
            debugErrorCount = 0;
            document.getElementById('debug-error-count').textContent = '0';
            debugLog('Log cleared', 'info');
        }
        
        function exportDebugLog() {
            const logData = {
                timestamp: new Date().toISOString(),
                entries: debugLogEntries,
                state: {
                    mode: currentMode,
                    messageCount: messageCount,
                    ttsEnabled: ttsEnabled,
                    apiBase: API_BASE
                }
            };
            
            const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gideon-debug-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            debugLog('Log exported', 'success');
        }
        
        // ============ IMAGE/CAMERA FUNCTIONS ============
        let selectedImageData = null;
        
        function showImageOptions() {
            const popup = document.getElementById('image-options-popup');
            if (!popup) {
                console.error('Popup non trovato!');
                return;
            }
            const isHidden = popup.style.display === 'none' || popup.style.display === '';
            popup.style.display = isHidden ? 'block' : 'none';
            console.log('Popup display:', popup.style.display);
        }
        
        function hideImageOptions() {
            const popup = document.getElementById('image-options-popup');
            if (popup) popup.style.display = 'none';
        }
        
        // Chiudi popup se clicchi fuori
        document.addEventListener('click', function(e) {
            const popup = document.getElementById('image-options-popup');
            const cameraBtn = document.getElementById('camera-btn');
            if (popup && popup.style.display === 'block') {
                if (!popup.contains(e.target) && e.target !== cameraBtn && !cameraBtn.contains(e.target)) {
                    popup.style.display = 'none';
                }
            }
        });
        
        function openGallery() {
            hideImageOptions();
            document.getElementById('image-upload').click();
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedImageData = e.target.result;
                    showImagePreview(selectedImageData);
                };
                reader.readAsDataURL(file);
            }
        }
        
        function showImagePreview(imageData) {
            const container = document.getElementById('image-preview-container');
            const preview = document.getElementById('image-preview');
            preview.src = imageData;
            container.style.display = 'block';
            document.getElementById('image-question').focus();
        }
        
        function removeImagePreview() {
            selectedImageData = null;
            document.getElementById('image-preview-container').style.display = 'none';
            document.getElementById('image-upload').value = '';
        }
        
        async function openCamera() {
            hideImageOptions();
            addSystemMessage('ðŸ“¸ Apertura fotocamera... Vedrai l\'anteprima in tempo reale!');
            
            try {
                // Request camera access with higher resolution
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                // Create video element for capture
                const video = document.createElement('video');
                video.srcObject = stream;
                video.autoplay = true;
                video.playsInline = true;
                video.muted = true;
                
                // Create modal for camera preview
                const modal = document.createElement('div');
                modal.id = 'camera-modal';
                modal.innerHTML = `
                    <div class="camera-modal-content">
                        <h3>ðŸ“¸ Anteprima Fotocamera</h3>
                        <p style="color: #aaa; margin-bottom: 10px; font-size: 0.9em;">Vedi cosa stai inquadrando in tempo reale</p>
                        <div class="camera-preview-container"></div>
                        <div class="camera-controls">
                            <button class="camera-capture-btn" onclick="capturePhoto()">ðŸ“· Scatta Foto</button>
                            <button class="camera-switch-btn" onclick="switchCamera()">ðŸ”„ Cambia Camera</button>
                            <button class="camera-cancel-btn" onclick="closeCamera()">âœ• Annulla</button>
                        </div>
                    </div>
                `;
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.95); z-index: 2000;
                    display: flex; align-items: center; justify-content: center;
                `;
                
                const style = document.createElement('style');
                style.textContent = `
                    .camera-modal-content {
                        background: linear-gradient(145deg, rgba(20, 25, 45, 0.98), rgba(30, 40, 60, 0.95));
                        border: 2px solid rgba(0, 245, 255, 0.5);
                        border-radius: 20px;
                        padding: 25px;
                        text-align: center;
                        max-width: 90vw;
                    }
                    .camera-modal-content h3 {
                        font-family: 'Orbitron', monospace;
                        color: var(--neon-cyan);
                        margin-bottom: 5px;
                        font-size: 1.5em;
                    }
                    .camera-preview-container {
                        position: relative;
                        display: inline-block;
                    }
                    .camera-preview-container video {
                        width: 100%;
                        max-width: 640px;
                        min-width: 320px;
                        border-radius: 12px;
                        border: 3px solid rgba(0, 245, 255, 0.6);
                        box-shadow: 0 0 30px rgba(0, 245, 255, 0.3);
                    }
                    .camera-preview-container::after {
                        content: 'ðŸ”´ LIVE';
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        background: rgba(255, 0, 0, 0.8);
                        color: white;
                        padding: 5px 10px;
                        border-radius: 5px;
                        font-size: 0.8em;
                        font-weight: bold;
                        animation: livePulse 1s infinite;
                    }
                    @keyframes livePulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.5; }
                    }
                    .camera-controls {
                        display: flex;
                        gap: 12px;
                        justify-content: center;
                        margin-top: 20px;
                        flex-wrap: wrap;
                    }
                    .camera-capture-btn, .camera-cancel-btn, .camera-switch-btn {
                        padding: 14px 28px;
                        border-radius: 10px;
                        border: none;
                        cursor: pointer;
                        font-family: 'Orbitron', monospace;
                        font-size: 1em;
                        transition: all 0.3s ease;
                    }
                    .camera-capture-btn {
                        background: linear-gradient(135deg, rgba(0, 255, 100, 0.4), rgba(0, 200, 100, 0.3));
                        color: #00ff66;
                        border: 2px solid rgba(0, 255, 100, 0.6);
                        font-size: 1.1em;
                    }
                    .camera-capture-btn:hover {
                        background: rgba(0, 255, 100, 0.5);
                        box-shadow: 0 0 25px rgba(0, 255, 100, 0.6);
                        transform: scale(1.05);
                    }
                    .camera-switch-btn {
                        background: rgba(100, 100, 255, 0.2);
                        color: #aaf;
                        border: 1px solid rgba(100, 100, 255, 0.4);
                    }
                    .camera-switch-btn:hover {
                        background: rgba(100, 100, 255, 0.4);
                    }
                    .camera-cancel-btn {
                        background: rgba(255, 0, 100, 0.2);
                        color: #ff6699;
                        border: 1px solid rgba(255, 0, 100, 0.3);
                    }
                    .camera-cancel-btn:hover {
                        background: rgba(255, 0, 100, 0.4);
                    }
                `;
                document.head.appendChild(style);
                document.body.appendChild(modal);
                
                modal.querySelector('.camera-preview-container').appendChild(video);
                
                // Store stream and facing mode for later
                window.currentCameraStream = stream;
                window.currentCameraVideo = video;
                window.currentFacingMode = 'user';
                
            } catch (error) {
                console.error('Camera error:', error);
                addSystemMessage('âŒ Errore accesso fotocamera: ' + error.message);
            }
        }
        
        function capturePhoto() {
            const video = window.currentCameraVideo;
            if (!video) return;
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            selectedImageData = canvas.toDataURL('image/jpeg', 0.9);
            showImagePreview(selectedImageData);
            closeCamera();
            addSystemMessage('âœ… Foto scattata!');
        }
        
        async function switchCamera() {
            if (!window.currentCameraStream) return;
            
            // Stop current stream
            window.currentCameraStream.getTracks().forEach(track => track.stop());
            
            // Toggle facing mode
            window.currentFacingMode = window.currentFacingMode === 'user' ? 'environment' : 'user';
            
            try {
                const newStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: window.currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                window.currentCameraStream = newStream;
                window.currentCameraVideo.srcObject = newStream;
                
                addSystemMessage('ðŸ“· Fotocamera: ' + (window.currentFacingMode === 'user' ? 'Frontale' : 'Posteriore'));
            } catch (error) {
                console.error('Switch camera error:', error);
                addSystemMessage('âš ï¸ Errore cambio fotocamera');
            }
        }
        
        function closeCamera() {
            if (window.currentCameraStream) {
                window.currentCameraStream.getTracks().forEach(track => track.stop());
                window.currentCameraStream = null;
            }
            const modal = document.getElementById('camera-modal');
            if (modal) modal.remove();
        }
        
        async function takeScreenshot() {
            hideImageOptions();
            addSystemMessage('ðŸ–¥ï¸ Cattura screenshot...');
            
            try {
                const response = await fetch(`${API_BASE}/api/smart/vision/screenshot`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.success && result.image_base64) {
                    selectedImageData = `data:image/png;base64,${result.image_base64}`;
                    showImagePreview(selectedImageData);
                    addSystemMessage('âœ… Screenshot catturato!');
                } else {
                    addSystemMessage('âŒ Errore screenshot: ' + (result.error || 'Sconosciuto'));
                }
            } catch (error) {
                console.error('Screenshot error:', error);
                addSystemMessage('âŒ Errore screenshot: ' + error.message);
            }
        }
        
        async function sendImageForAnalysis() {
            if (!selectedImageData) {
                addSystemMessage('âš ï¸ Nessuna immagine selezionata');
                return;
            }
            
            const question = document.getElementById('image-question').value || 'Analizza questa immagine in dettaglio';
            
            // Show user message with image
            const msgElement = document.createElement('div');
            msgElement.className = 'message user';
            msgElement.innerHTML = `
                <div class="message-content">
                    <img src="${selectedImageData}" style="max-width: 200px; border-radius: 10px; margin-bottom: 10px;">
                    <p>${escapeHtml(question)}</p>
                </div>
                <div class="message-meta">
                    <span>${formatTime(new Date())}</span>
                    <span>âœ“âœ“</span>
                </div>
            `;
            insertBeforeTyping(msgElement);
            scrollToBottom();
            
            // Show loading
            showTyping();
            
            try {
                const response = await fetch(`${API_BASE}/api/smart/vision/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_base64: selectedImageData.split(',')[1],
                        question: question
                    })
                });
                
                const result = await response.json();
                hideTyping();
                
                if (result.success) {
                    addAssistantMessage(result.analysis, state.currentMode, 0.9);
                } else {
                    addAssistantMessage('âŒ Errore nell\'analisi: ' + (result.error || 'Sconosciuto'), state.currentMode, 0.5);
                }
            } catch (error) {
                hideTyping();
                console.error('Vision analysis error:', error);
                addAssistantMessage('âŒ Errore di connessione per l\'analisi', state.currentMode, 0.5);
            }
            
            // Clear the preview
            removeImagePreview();
        }
        
        // Handle Enter on image question input
        document.addEventListener('DOMContentLoaded', function() {
            const imageQuestionInput = document.getElementById('image-question');
            if (imageQuestionInput) {
                imageQuestionInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendImageForAnalysis();
                    }
                });
            }
        });

        // ============ EXECUTE ACTIONS ============
        async function executeAction(action, params = {}) {
            addSystemMessage(`âš¡ Esecuzione: ${action}...`);
            
            try {
                const response = await fetch(`${API_BASE}/api/jarvis/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        params: params,
                        bypass_security: false
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResultPopup(`âœ… ${action}: ${result.output || 'Completato'}`, 'success');
                    if (state.isTTSEnabled) {
                        speak(`Azione ${action} completata`);
                    }
                } else {
                    showResultPopup(`âŒ Errore: ${result.error || 'Azione fallita'}`, 'error');
                }
                
                return result;
            } catch (error) {
                console.error('Execute action error:', error);
                showResultPopup(`âŒ Errore di connessione`, 'error');
                return { success: false, error: error.message };
            }
        }
        
        // ============ EMERGENCY ACTIONS ============
        async function emergencyAction(action) {
            const confirmMsg = {
                kill: 'â›” Vuoi attivare il KILL SWITCH? Tutte le operazioni verranno interrotte.',
                safe_mode: 'ðŸ›¡ï¸ Vuoi entrare in SAFE MODE? Le operazioni rischiose saranno bloccate.',
                lockdown: 'ðŸ” Vuoi attivare il LOCKDOWN? Il sistema sarÃ  completamente bloccato.',
                resume: 'âœ… Vuoi riprendere le operazioni normali?'
            };
            
            if (action !== 'resume' && !confirm(confirmMsg[action])) {
                return;
            }
            
            addSystemMessage(`ðŸš¨ Emergenza: ${action.toUpperCase()}...`);
            
            try {
                const response = await fetch(`${API_BASE}/api/system/emergency`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        reason: `Manual ${action} from UI`
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResultPopup(`ðŸš¨ ${action.toUpperCase()}: Attivato`, action === 'resume' ? 'success' : 'error');
                    if (state.isTTSEnabled) {
                        speak(`Emergenza ${action} attivata`);
                    }
                } else {
                    showResultPopup(`âŒ Errore: ${result.detail || 'Operazione fallita'}`, 'error');
                }
            } catch (error) {
                console.error('Emergency action error:', error);
                showResultPopup(`âŒ Errore di connessione`, 'error');
            }
        }
        
        // ============ RUN WORKFLOWS ============
        async function runWorkflow(workflowId) {
            // Descrizioni workflow
            const workflowDescriptions = {
                morning_routine: 'ðŸŒ… Routine Mattina: Apertura app, check email, news, meteo',
                work_setup: 'ðŸ’¼ Setup Lavoro: Apertura IDE, browser, comunicazioni',
                meeting_prep: 'ðŸ“… Prepara Meeting: Check calendario, preparazione materiali',
                end_of_day: 'ðŸŒ™ Fine Giornata: Backup, chiusura app, report',
                backup_routine: 'ðŸ’¾ Backup Routine: Salvataggio dati importanti',
                cleanup_routine: 'ðŸ§¹ Pulizia Routine: File temporanei, cache, log',
                security_routine: 'ðŸ”’ Routine Sicurezza: Scansione, aggiornamenti, check',
                custom: 'âœ¨ Crea un nuovo workflow personalizzato'
            };
            
            if (workflowId === 'custom') {
                // Apri il workflow builder
                window.open('workflows.html', '_blank');
                return;
            }
            
            const description = workflowDescriptions[workflowId] || `Workflow: ${workflowId}`;
            
            if (!confirm(`Vuoi eseguire:\n\n${description}`)) {
                return;
            }
            
            addSystemMessage(`âš™ï¸ Avvio workflow: ${workflowId}...`);
            showTyping();
            
            try {
                const response = await fetch(`${API_BASE}/api/hub/workflows/presets/${workflowId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                hideTyping();
                
                if (result.success || result.workflow_id) {
                    showResultPopup(`âœ… Workflow "${workflowId}" avviato con successo!`, 'success');
                    addAssistantMessage(`âœ… **Workflow avviato!**\n\n${description}\n\nID Esecuzione: \`${result.workflow_id || result.execution_id || 'N/A'}\``, state.currentMode, 0.95);
                    
                    if (state.isTTSEnabled) {
                        speak(`Workflow ${workflowId.replace(/_/g, ' ')} avviato`);
                    }
                } else {
                    showResultPopup(`âŒ Errore: ${result.error || 'Workflow fallito'}`, 'error');
                    addAssistantMessage(`âŒ Errore nell'avvio del workflow: ${result.error || 'Errore sconosciuto'}`, state.currentMode, 0.5);
                }
                
                return result;
            } catch (error) {
                hideTyping();
                console.error('Run workflow error:', error);
                showResultPopup(`âŒ Errore di connessione`, 'error');
                addAssistantMessage(`âŒ Errore di connessione al server per il workflow`, state.currentMode, 0.5);
                return { success: false, error: error.message };
            }
        }
        
        // ============ SECURITY & PRIVACY TOOLS ============
        async function runSecurityTool(tool) {
            const toolMessages = {
                security_scan: 'ðŸ” Scansione Sicurezza avviata... Analisi completa del sistema.',
                check_vulnerabilities: 'ðŸ›¡ï¸ Check VulnerabilitÃ  in corso... Verifica punti deboli.',
                clear_browser_data: 'ðŸ§¹ Pulizia Browser in corso... Eliminazione dati.',
                check_passwords: 'ðŸ”‘ Audit Password avviato... Analisi sicurezza credenziali.',
                network_scan: 'ðŸ“¡ Scansione Rete avviata... Analisi dispositivi connessi.',
                check_permissions: 'ðŸ“‹ Check Permessi in corso... Verifica autorizzazioni.',
                backup_credentials: 'ðŸ’¾ Backup Credenziali avviato... Salvataggio sicuro.',
                check_updates: 'ðŸ”„ Verifica Aggiornamenti Sicurezza in corso...'
            };
            
            addSystemMessage(toolMessages[tool] || `ðŸ”’ Security tool ${tool} avviato`);
            
            let output = '';
            switch(tool) {
                case 'security_scan':
                    output = `ðŸ” **Scansione Sicurezza**\n\nâœ… Firewall: Attivo\nâœ… Antivirus: Aggiornato\nâœ… Windows Defender: Attivo\nâš ï¸ Ultimi aggiornamenti: Verificare\n\nðŸ›¡ï¸ Sistema generalmente protetto.`;
                    break;
                case 'check_vulnerabilities':
                    output = `ðŸ›¡ï¸ **Check VulnerabilitÃ **\n\nðŸ“‹ Analisi completata:\n- Porte aperte: Controllate\n- Servizi esposti: Verificati\n- Software obsoleto: Check in corso\n\nðŸ’¡ Consiglio: Mantieni il sistema aggiornato.`;
                    break;
                case 'clear_browser_data':
                    output = `ðŸ§¹ **Pulizia Browser**\n\nðŸ—‘ï¸ Dati eliminabili:\n- Cache\n- Cookies\n- Cronologia\n- Download\n\nâš ï¸ Usa le impostazioni del browser per procedere.`;
                    break;
                case 'check_passwords':
                    output = `ðŸ”‘ **Audit Password**\n\nðŸ“Š Best Practices:\n- Usa password di almeno 12 caratteri\n- Combina lettere, numeri e simboli\n- Non riutilizzare le password\n- Usa un password manager\n\nðŸ” Vuoi che generi una password sicura?`;
                    break;
                case 'network_scan':
                    output = `ðŸ“¡ **Scansione Rete**\n\nðŸŒ Analisi in corso...\n- Gateway: Rilevato\n- Dispositivi connessi: Scanning\n- QualitÃ  connessione: Verificata\n\nðŸ“¶ Rete monitorata.`;
                    break;
                case 'check_permissions':
                    output = `ðŸ“‹ **Check Permessi**\n\nðŸ” Verifica autorizzazioni:\n- App con accesso microfono\n- App con accesso camera\n- App con accesso posizione\n- Permessi amministratore\n\nâš™ï¸ Gestisci da Impostazioni > Privacy.`;
                    break;
                case 'backup_credentials':
                    output = `ðŸ’¾ **Backup Credenziali**\n\nðŸ”’ Opzioni di backup:\n- Export password browser\n- Sincronizzazione cloud sicura\n- Password manager dedicato\n\nâš ï¸ Conserva i backup in modo sicuro!`;
                    break;
                case 'check_updates':
                    output = `ðŸ”„ **Aggiornamenti Sicurezza**\n\nðŸ“¥ Verifica in corso:\n- Windows Update\n- Driver\n- Software installato\n- Definizioni antivirus\n\nðŸ’¡ Aggiornamenti regolari = Sistema sicuro.`;
                    break;
                default:
                    output = `ðŸ”’ **${tool.replace(/_/g, ' ').toUpperCase()}**\n\nTool di sicurezza pronto. Eseguo analisi...`;
            }
            
            addAssistantMessage(output, state.currentMode, 0.9);
            if (state.isTTSEnabled) speak(toolMessages[tool]);
        }
        
        // ============ HEALTH & WELLNESS TOOLS ============
        async function runHealthTool(tool) {
            const toolMessages = {
                posture_reminder: 'ðŸ§˜ Reminder Postura attivato... Ricordati di stare dritto!',
                eye_break: 'ðŸ‘ï¸ Pausa Occhi (20-20-20)... Guarda a 20 piedi per 20 secondi.',
                hydration_reminder: 'ðŸ’§ Reminder Idratazione... Ãˆ ora di bere acqua!',
                stretch_break: 'ðŸ¤¸ Pausa Stretching... Allunga i muscoli.',
                screen_time_report: 'ðŸ“Š Report Tempo Schermo in generazione...',
                blue_light_filter: 'ðŸŒ™ Filtro Luce Blu attivato/disattivato.',
                focus_mode: 'ðŸŽ¯ ModalitÃ  Focus attivata... Eliminando distrazioni.',
                wellness_summary: 'ðŸ“‹ Riepilogo Benessere in generazione...'
            };
            
            addSystemMessage(toolMessages[tool] || `ðŸ’Š Health tool ${tool} avviato`);
            
            let output = '';
            switch(tool) {
                case 'posture_reminder':
                    output = `ðŸ§˜ **Reminder Postura**\n\nðŸ“ Checklist postura corretta:\n- Schiena dritta\n- Spalle rilassate\n- Schermo all'altezza degli occhi\n- Piedi appoggiati a terra\n- Braccia a 90Â°\n\nâ° Prossimo reminder tra 30 minuti.`;
                    break;
                case 'eye_break':
                    output = `ðŸ‘ï¸ **Regola 20-20-20**\n\nâ±ï¸ Ogni 20 minuti:\n1. Guarda qualcosa a 6 metri (20 piedi)\n2. Per almeno 20 secondi\n3. Sbatti le palpebre\n\nðŸŒŸ I tuoi occhi ti ringrazieranno!`;
                    break;
                case 'hydration_reminder':
                    output = `ðŸ’§ **Idratazione**\n\nðŸ¥¤ Obiettivo giornaliero: 2L di acqua\n\nâ° Bevi un bicchiere d'acqua ogni ora!\n\nâœ… Benefici:\n- Concentrazione migliore\n- Energia costante\n- Pelle piÃ¹ sana`;
                    break;
                case 'stretch_break':
                    output = `ðŸ¤¸ **Pausa Stretching**\n\n5 esercizi rapidi (30 sec ciascuno):\n1. ðŸ™† Rotazione collo\n2. ðŸ’ª Stretching braccia\n3. ðŸ”„ Rotazione spalle\n4. ðŸ¦µ Stretching gambe\n5. ðŸ§˜ Respirazione profonda\n\nðŸ’ª Fatto! Ti sentirai meglio.`;
                    break;
                case 'screen_time_report':
                    const sessionMinutes = state.sessionStartTime ? Math.floor((Date.now() - state.sessionStartTime) / 60000) : 0;
                    output = `ðŸ“Š **Report Tempo Schermo**\n\nâ±ï¸ Sessione attuale: ${sessionMinutes} minuti\nðŸ“… Oggi: In monitoraggio\n\nðŸ’¡ Consiglio: Fai una pausa ogni 50 minuti.`;
                    break;
                case 'blue_light_filter':
                    output = `ðŸŒ™ **Filtro Luce Blu**\n\nðŸ–¥ï¸ Per attivare:\n- Windows: Impostazioni > Schermo > Luce notturna\n- Monitor: ModalitÃ  lettura/eye care\n\nðŸ˜´ Riduce affaticamento e migliora il sonno.`;
                    break;
                case 'focus_mode':
                    output = `ðŸŽ¯ **ModalitÃ  Focus**\n\nðŸš« Distrazioni eliminate:\n- Notifiche silenziate\n- App social bloccate\n- Timer Pomodoro attivo\n\nâ±ï¸ Focus per 25 minuti, poi pausa!`;
                    break;
                case 'wellness_summary':
                    output = `ðŸ“‹ **Riepilogo Benessere**\n\nâœ… Checklist giornaliera:\n- [ ] 8 bicchieri d'acqua\n- [ ] 3 pause stretching\n- [ ] 5 pause occhi\n- [ ] Postura controllata\n- [ ] 30 min movimento\n\nðŸŒŸ Come stai oggi?`;
                    break;
                default:
                    output = `ðŸ’Š **${tool.replace(/_/g, ' ').toUpperCase()}**\n\nTool benessere attivo.`;
            }
            
            addAssistantMessage(output, state.currentMode, 0.9);
            if (state.isTTSEnabled) speak(toolMessages[tool]);
        }
        
        // ============ PREVENTION & MAINTENANCE TOOLS ============
        async function runPreventionTool(tool) {
            const toolMessages = {
                disk_health: 'ðŸ’½ Analisi Salute Disco in corso...',
                battery_health: 'ðŸ”‹ Verifica Salute Batteria...',
                temp_cleanup: 'ðŸ§¹ Pulizia File Temporanei in corso...',
                defrag_analyze: 'ðŸ“€ Analisi Frammentazione Disco...',
                startup_optimize: 'ðŸš€ Ottimizzazione Avvio Sistema...',
                driver_check: 'ðŸ”§ Verifica Driver in corso...',
                event_log_analyze: 'ðŸ“ Analisi Log Eventi Sistema...',
                full_maintenance: 'âš¡ Manutenzione Completa avviata...'
            };
            
            addSystemMessage(toolMessages[tool] || `ðŸ› ï¸ Maintenance tool ${tool} avviato`);
            
            let output = '';
            switch(tool) {
                case 'disk_health':
                    output = `ðŸ’½ **Salute Disco**\n\nðŸ“Š Analisi:\n- Spazio utilizzato: Verificando...\n- Settori danneggiati: Check in corso\n- Temperatura: Normale\n- S.M.A.R.T.: Attivo\n\nðŸ’¡ Esegui CHKDSK periodicamente.`;
                    break;
                case 'battery_health':
                    output = `ðŸ”‹ **Salute Batteria**\n\nðŸ“Š Report:\n- CapacitÃ  attuale: Verificando...\n- Cicli di carica: N/A\n- Stato: Controllato\n\nðŸ’¡ Mantieni la carica tra 20% e 80%.`;
                    break;
                case 'temp_cleanup':
                    output = `ðŸ§¹ **Pulizia File Temporanei**\n\nðŸ—‘ï¸ File da eliminare:\n- Cache di sistema\n- File temporanei\n- Cestino\n- Cache browser\n- Log vecchi\n\nðŸ’¾ Spazio recuperabile: Calcolando...`;
                    break;
                case 'defrag_analyze':
                    output = `ðŸ“€ **Analisi Frammentazione**\n\nðŸ’¿ Per SSD: Non necessaria (TRIM automatico)\nðŸ’¿ Per HDD: Esegui deframmentazione\n\nâš™ï¸ Windows ottimizza automaticamente.`;
                    break;
                case 'startup_optimize':
                    output = `ðŸš€ **Ottimizzazione Avvio**\n\nðŸ“‹ Controlla:\n- Task Manager > Avvio\n- Disabilita app non necessarie\n- Riduci servizi all'avvio\n\nâ±ï¸ Avvio piÃ¹ veloce!`;
                    break;
                case 'driver_check':
                    output = `ðŸ”§ **Check Driver**\n\nðŸ“‹ Verifica:\n- Driver GPU: Controllare aggiornamenti\n- Driver Audio: OK\n- Driver Rete: OK\n- Driver USB: OK\n\nðŸ’¡ Usa Windows Update o sito produttore.`;
                    break;
                case 'event_log_analyze':
                    output = `ðŸ“ **Analisi Log Eventi**\n\nðŸ” Controllo:\n- Errori critici: Scanning\n- Warning: Verificando\n- Eventi sicurezza: Monitorati\n\nâš™ï¸ Visualizzatore Eventi Windows.`;
                    break;
                case 'full_maintenance':
                    output = `âš¡ **Manutenzione Completa**\n\nðŸ”„ Esecuzione:\n1. âœ… Pulizia disco\n2. âœ… Check driver\n3. âœ… Aggiornamenti\n4. âœ… Ottimizzazione\n5. âœ… Scansione sicurezza\n\nðŸŽ‰ Sistema ottimizzato!`;
                    break;
                default:
                    output = `ðŸ› ï¸ **${tool.replace(/_/g, ' ').toUpperCase()}**\n\nTool manutenzione attivo.`;
            }
            
            addAssistantMessage(output, state.currentMode, 0.9);
            if (state.isTTSEnabled) speak(toolMessages[tool]);
        }
        
        // ============ CYBERSECURITY TOOLS ============
        async function runCyberTool(tool) {
            const toolMessages = {
                port_scan: 'ðŸ”Œ Port Scanner avviato... Analisi porte in corso.',
                firewall_check: 'ðŸ§± Verifica Firewall in corso... Controllo regole.',
                malware_scan: 'ðŸ¦  Scansione Malware avviata... Analisi sistema.',
                intrusion_detect: 'ðŸš¨ Intrusion Detection attivo... Monitoraggio traffico.',
                vuln_assessment: 'ðŸ”“ Vulnerability Assessment in corso... Scanning.',
                traffic_monitor: 'ðŸ“Š Traffic Monitor attivo... Analisi pacchetti.',
                ssl_check: 'ðŸ”’ Verifica SSL/TLS in corso... Controllo certificati.',
                dns_lookup: 'ðŸŒ DNS Lookup avviato... Risoluzione domini.',
                whois: 'ðŸ“‹ WHOIS Lookup in corso... Ricerca informazioni.',
                hash_check: 'ðŸ” Hash Verification avviata... Controllo integritÃ .',
                password_strength: 'ðŸ’ª Password Strength Analyzer pronto... Inserisci password.',
                breach_check: 'âš ï¸ Breach Check in corso... Verifica compromissioni.'
            };
            
            addSystemMessage(toolMessages[tool] || `ðŸ–¥ï¸ Cyber tool ${tool} avviato`);
            
            try {
                const response = await fetch(`${API_BASE}/api/jarvis/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: `cyber_${tool}`,
                        params: { tool_type: tool },
                        bypass_security: false
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    addAssistantMessage(`ðŸ–¥ï¸ **${tool.toUpperCase()}**\n\n${result.output || 'Operazione completata'}`, state.currentMode, 0.95);
                } else {
                    addAssistantMessage(`ðŸ–¥ï¸ Tool ${tool} in modalitÃ  demo. FunzionalitÃ  complete disponibili con integrazione API.`, state.currentMode, 0.8);
                }
                
                if (state.isTTSEnabled) speak(toolMessages[tool]);
            } catch (error) {
                addAssistantMessage(`ðŸ–¥ï¸ Tool ${tool} inizializzato. Inserisci i parametri per procedere.`, state.currentMode, 0.8);
                if (state.isTTSEnabled) speak(toolMessages[tool]);
            }
        }
        
        // ============ MILITARY/INTELLIGENCE TOOLS ============
        async function runMilitaryTool(tool) {
            const toolMessages = {
                sigint: 'ðŸ›°ï¸ SIGINT Analysis attiva... Canali in monitoraggio.',
                osint: 'ðŸ” OSINT Gathering avviato... Raccolta intelligence pubblica.',
                tactical: 'ðŸŽ¯ Tactical AI pronto... Definisci scenario operativo.',
                cyber_defense: 'ðŸ›¡ï¸ Cyber Defense attiva... Perimetro protetto.',
                c4isr: 'ðŸ“¡ C4ISR Network connessa... Tutti i nodi operativi.',
                intel_fusion: 'ðŸ—„ï¸ Intelligence Fusion Engine online... Fonti aggregate.',
                geospatial: 'ðŸ—ºï¸ Geospatial Intel attivo... Caricamento mappe.',
                threat_assess: 'âš ï¸ Threat Assessment in corso... Analisi minacce.',
                comms_secure: 'ðŸ“» Secure Communications attive... Canale criptato.',
                crypto_ops: 'ðŸ” Crypto Operations pronte... Algoritmi caricati.'
            };
            
            addSystemMessage(toolMessages[tool] || `âš”ï¸ Military tool ${tool} avviato`);
            
            try {
                const response = await fetch(`${API_BASE}/api/jarvis/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: `military_${tool}`,
                        params: { tool_type: tool },
                        bypass_security: false
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    addAssistantMessage(`âš”ï¸ **${tool.toUpperCase()}**\n\n${result.output || 'Operazione completata'}`, state.currentMode, 0.95);
                } else {
                    addAssistantMessage(`âš”ï¸ Tool ${tool} in modalitÃ  simulazione. Accesso completo richiede autorizzazione.`, state.currentMode, 0.8);
                }
                
                if (state.isTTSEnabled) speak(toolMessages[tool]);
            } catch (error) {
                addAssistantMessage(`âš”ï¸ Tool ${tool} inizializzato. ModalitÃ  simulazione attiva.`, state.currentMode, 0.8);
                if (state.isTTSEnabled) speak(toolMessages[tool]);
            }
        }
        
        // ============ SCIENCE TOOLS ============
        async function runScienceTool(tool) {
            const toolMessages = {
                data_analysis: 'ðŸ“Š Data Analysis Engine avviato... Carica un dataset.',
                genomics: 'ðŸ§¬ Genomics Lab pronto... Inserisci sequenza FASTA.',
                chemistry: 'ðŸ§ª Chemistry Lab attivo... Inserisci formula molecolare.',
                physics: 'âš›ï¸ Physics Simulator inizializzato... Descrivi scenario.',
                astronomy: 'ðŸ”­ Astronomy Tools connessi... Database celeste caricato.',
                climate: 'ðŸŒ¡ï¸ Climate Modeling attivo... Parametri pronti.',
                ml_lab: 'ðŸ¤– ML/AI Lab pronto... Seleziona modello o dataset.',
                simulation: 'ðŸ–¥ï¸ Simulation Engine online... Definisci parametri.'
            };
            
            addSystemMessage(toolMessages[tool] || `ðŸ”¬ Science tool ${tool} avviato`);
            
            try {
                const response = await fetch(`${API_BASE}/api/jarvis/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: `science_${tool}`,
                        params: { tool_type: tool },
                        bypass_security: false
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    addAssistantMessage(`ðŸ”¬ **${tool.toUpperCase()}**\n\n${result.output || 'Tool pronto'}`, state.currentMode, 0.95);
                } else {
                    addAssistantMessage(`ðŸ”¬ Tool ${tool} pronto. Descrivi l'analisi o la simulazione da eseguire.`, state.currentMode, 0.8);
                }
                
                if (state.isTTSEnabled) speak(toolMessages[tool]);
            } catch (error) {
                addAssistantMessage(`ðŸ”¬ Tool ${tool} inizializzato. Fornisci i dati per procedere.`, state.currentMode, 0.8);
                if (state.isTTSEnabled) speak(toolMessages[tool]);
            }
        }
        
        // ============ MEDICAL TOOLS ============
        async function runMedicalTool(tool) {
            const toolMessages = {
                diagnostics: 'ðŸ©º Diagnostica AI pronta... Descrivi i sintomi.',
                biometry: 'ðŸ«€ Biometria attiva... Connetti dispositivo o inserisci dati.',
                neuro: 'ðŸ§  Neuroimaging analysis ready... Carica immagini MRI/CT.',
                pharma: 'ðŸ’Š Database farmacologico caricato... Cerca farmaco.',
                epidemiology: 'ðŸ¦  Epidemiology tracker attivo... Seleziona area.',
                telemedicine: 'ðŸ“± Telemedicina connessa... Avvia sessione.',
                radiology: 'ðŸ©» Radiologia AI pronta... Carica immagini diagnostiche.',
                patient_monitor: 'ðŸ“ˆ Patient Monitor attivo... Inserisci parametri vitali.'
            };
            
            addSystemMessage(toolMessages[tool] || `ðŸ¥ Medical tool ${tool} avviato`);
            
            try {
                const response = await fetch(`${API_BASE}/api/jarvis/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: `medical_${tool}`,
                        params: { tool_type: tool },
                        bypass_security: false
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    addAssistantMessage(`ðŸ¥ **${tool.toUpperCase()}**\n\n${result.output || 'Sistema pronto'}`, state.currentMode, 0.95);
                } else {
                    addAssistantMessage(`ðŸ¥ Tool ${tool} pronto. âš ï¸ Nota: Questo tool Ã¨ solo a scopo informativo e non sostituisce il parere medico.`, state.currentMode, 0.8);
                }
                
                if (state.isTTSEnabled) speak(toolMessages[tool]);
            } catch (error) {
                addAssistantMessage(`ðŸ¥ Tool ${tool} inizializzato. âš ï¸ Solo a scopo informativo.`, state.currentMode, 0.8);
                if (state.isTTSEnabled) speak(toolMessages[tool]);
            }
        }
        
        // ============ MONITOR TOOLS ============
        async function runMonitorTool(tool) {
            const toolMessages = {
                cpu_usage: 'ðŸ”¥ Monitoraggio CPU avviato... Analisi utilizzo processore.',
                ram_usage: 'ðŸ’¾ Monitoraggio RAM avviato... Analisi memoria.',
                disk_usage: 'ðŸ’½ Monitoraggio Disco avviato... Analisi spazio.',
                network_traffic: 'ðŸ“¡ Monitoraggio Rete avviato... Analisi traffico.',
                processes: 'ðŸ“‹ Lista processi in aggiornamento...',
                services: 'âš™ï¸ Stato servizi in caricamento...',
                temperatures: 'ðŸŒ¡ï¸ Lettura temperature sistema...',
                battery: 'ðŸ”‹ Stato batteria in analisi...',
                gpu_usage: 'ðŸŽ® Monitoraggio GPU avviato...',
                system_uptime: 'â±ï¸ Calcolo uptime sistema...',
                event_logs: 'ðŸ“ Caricamento log eventi recenti...',
                full_report: 'ðŸ“Š Generazione report completo del sistema...'
            };
            
            addSystemMessage(toolMessages[tool] || `ðŸ“Š Monitor ${tool} avviato`);
            
            try {
                const response = await fetch(`${API_BASE}/api/system/dev/status`);
                const data = await response.json();
                
                let output = '';
                switch(tool) {
                    case 'cpu_usage':
                        output = `ðŸ”¥ **CPU Usage**\n\nUtilizzo: ${data.system_load?.cpu_percent || 'N/A'}%\nCore: ${navigator.hardwareConcurrency || 'N/A'}`;
                        break;
                    case 'ram_usage':
                        output = `ðŸ’¾ **RAM Usage**\n\nUtilizzo: ${data.system_load?.memory_percent || 'N/A'}%`;
                        break;
                    case 'disk_usage':
                        output = `ðŸ’½ **Disk Usage**\n\nUtilizzo: ${data.system_load?.disk_percent || 'N/A'}%`;
                        break;
                    case 'full_report':
                        output = `ðŸ“Š **System Report**\n\n`;
                        output += `CPU: ${data.system_load?.cpu_percent || 'N/A'}%\n`;
                        output += `RAM: ${data.system_load?.memory_percent || 'N/A'}%\n`;
                        output += `Disco: ${data.system_load?.disk_percent || 'N/A'}%\n`;
                        output += `Backend: ${data.api_status || 'Online'}\n`;
                        output += `Versione: ${data.version || 'N/A'}`;
                        break;
                    default:
                        output = `ðŸ“Š **${tool.toUpperCase()}**\n\nDati disponibili dal sistema di monitoraggio.`;
                }
                
                addAssistantMessage(output, state.currentMode, 0.95);
                if (state.isTTSEnabled) speak(toolMessages[tool]);
            } catch (error) {
                addAssistantMessage(`ðŸ“Š Monitor ${tool} - Dati non disponibili. Verifica la connessione al backend.`, state.currentMode, 0.6);
            }
        }
        
        // ============ WORK/PRODUCTIVITY TOOLS ============
        async function runWorkTool(tool) {
            const toolMessages = {
                pomodoro: 'ðŸ… Pomodoro Timer avviato... 25 minuti di focus.',
                task_list: 'ðŸ“ Task List aperta... Gestisci le tue attivitÃ .',
                calendar: 'ðŸ“… Calendario aperto... Visualizza i tuoi impegni.',
                notes: 'ðŸ—’ï¸ Note Rapide pronte... Scrivi le tue idee.',
                time_tracker: 'â° Time Tracker avviato... Monitora il tuo tempo.',
                project_manager: 'ðŸ“‹ Project Manager aperto... Gestisci i tuoi progetti.',
                email_draft: 'âœ‰ï¸ Editor Email pronto... Scrivi la tua email.',
                meeting_notes: 'ðŸŽ¤ Note Meeting pronte... Documenta la riunione.',
                code_snippets: 'ðŸ’» Code Snippets Manager aperto... Salva il tuo codice.',
                document_gen: 'ðŸ“„ Generatore Documenti pronto... Crea il tuo documento.',
                productivity_stats: 'ðŸ“ˆ Statistiche ProduttivitÃ  in caricamento...',
                daily_summary: 'ðŸ“Š Generazione Riepilogo Giornata...'
            };
            
            addSystemMessage(toolMessages[tool] || `ðŸ’¼ Work tool ${tool} avviato`);
            
            let output = '';
            switch(tool) {
                case 'pomodoro':
                    output = `ðŸ… **Pomodoro Timer**\n\nâ±ï¸ 25 minuti di lavoro focus\nâ˜• 5 minuti di pausa\n\nDici "avvia pomodoro" per iniziare!`;
                    break;
                case 'task_list':
                    output = `ðŸ“ **Task List**\n\nComandi disponibili:\n- "aggiungi task [descrizione]"\n- "lista task"\n- "completa task [numero]"\n- "elimina task [numero]"`;
                    break;
                case 'calendar':
                    const today = new Date();
                    output = `ðŸ“… **Calendario**\n\nOggi: ${today.toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n\nDici "mostra eventi" per vedere i tuoi appuntamenti.`;
                    break;
                case 'notes':
                    output = `ðŸ—’ï¸ **Note Rapide**\n\nDici "nota: [testo]" per salvare una nota.\nDici "mostra note" per vedere le note salvate.`;
                    break;
                case 'email_draft':
                    output = `âœ‰ï¸ **Email Draft**\n\nDimmi:\n- Destinatario\n- Oggetto\n- Contenuto\n\nE creerÃ² una bozza email professionale!`;
                    break;
                case 'document_gen':
                    output = `ðŸ“„ **Generatore Documenti**\n\nPosso creare:\n- Report\n- Lettere formali\n- Presentazioni\n- Riassunti\n\nDescrivimi cosa ti serve!`;
                    break;
                case 'daily_summary':
                    output = `ðŸ“Š **Riepilogo Giornata**\n\nðŸ“… ${new Date().toLocaleDateString('it-IT')}\nâ° Sessione attiva da: ${state.sessionStartTime ? Math.floor((Date.now() - state.sessionStartTime) / 60000) : 0} minuti\nðŸ’¬ Messaggi: ${state.messageCount || 0}\nâœ… Azioni completate: ${state.turnCount || 0}`;
                    break;
                default:
                    output = `ðŸ’¼ **${tool.replace(/_/g, ' ').toUpperCase()}**\n\nTool di produttivitÃ  pronto. Dimmi cosa vuoi fare!`;
            }
            
            addAssistantMessage(output, state.currentMode, 0.9);
            if (state.isTTSEnabled) speak(toolMessages[tool]);
        }
        
        // ============ RESOURCES & DATABASE TOOLS ============
        async function runResourceTool(tool) {
            const toolMessages = {
                knowledge_base: 'ðŸ§  Accesso Knowledge Base GIDEON... Database con milioni di articoli e documentazione.',
                wiki_search: 'ðŸ“– Wiki Search attivato... Ricerca semantica su Wikipedia e archivi enciclopedici.',
                paper_search: 'ðŸ“„ Paper Search avviato... Ricerca su arXiv, PubMed, IEEE, ACM.',
                patent_db: 'ðŸ’¡ Patent Database aperto... Accesso a USPTO, EPO, WIPO.',
                legal_db: 'âš–ï¸ Legal Database connesso... Leggi, sentenze, giurisprudenza.',
                financial_data: 'ðŸ“ˆ Financial Data loading... Dati real-time mercati finanziari.',
                news_aggregator: 'ðŸ“° News Aggregator attivo... Notizie multi-fonte con AI filtering.',
                open_data: 'ðŸŒ Open Data connesso... Dataset governativi aperti.',
                api_catalog: 'ðŸ”Œ API Catalog aperto... Catalogo API pubbliche organizzate.',
                code_repos: 'ðŸ’» Code Repos search... Ricerca in GitHub, GitLab, Bitbucket.'
            };
            
            addSystemMessage(toolMessages[tool] || `ðŸ“š Resource ${tool} avviato`);
            
            let output = '';
            switch(tool) {
                case 'knowledge_base':
                    output = `ðŸ§  **GIDEON Knowledge Base**\n\nðŸ“Š Database Entries: 50M+\nðŸ“š Categorie: Tecnologia, Scienza, Storia, Arte, Medicina\nðŸ” Ricerca: Semantica + Keywords\n\n**Comandi:**\n- "cerca [argomento]"\n- "spiega [concetto]"\n- "approfondisci [topic]"`;
                    break;
                case 'wiki_search':
                    output = `ðŸ“– **Wikipedia Search**\n\nðŸŒ Lingue: 300+\nðŸ“„ Articoli: 60M+\nðŸ”„ Traduzione automatica\n\n**Esempio:** "cerca wiki Einstein"`;
                    break;
                case 'paper_search':
                    output = `ðŸ“„ **Academic Paper Search**\n\nðŸ”¬ arXiv: AI, Physics, Math\nðŸ¥ PubMed: Medicina, Biologia\nðŸ’» IEEE/ACM: Computer Science\n\n**Filtri:** anno, citazioni, impact factor\n**Esempio:** "cerca paper machine learning 2025"`;
                    break;
                case 'patent_db':
                    output = `ðŸ’¡ **Patent Database**\n\nðŸ‡ºðŸ‡¸ USPTO: Brevetti USA\nðŸ‡ªðŸ‡º EPO: Brevetti Europei\nðŸŒ WIPO: Brevetti Internazionali\n\n**Funzioni:** Prior art, Patent family, Citations\n**Esempio:** "cerca brevetto batterie"`;
                    break;
                case 'legal_db':
                    output = `âš–ï¸ **Legal Database**\n\nðŸ“œ Codice Civile/Penale\nðŸ›ï¸ Sentenze Cassazione\nðŸ‡ªðŸ‡º Normativa Europea\n\n**Esempio:** "cerca legge GDPR"`;
                    break;
                case 'financial_data':
                    output = `ðŸ“ˆ **Financial Data**\n\nðŸ’¹ Azioni: Real-time quotes\nâ‚¿ Crypto: BTC, ETH, +1000\nðŸ’± Forex: Major pairs\nðŸ“Š Analisi: Tecnica + Fondamentale\n\n**Esempio:** "prezzo bitcoin" o "analizza AAPL"`;
                    break;
                case 'news_aggregator':
                    output = `ðŸ“° **News Aggregator AI**\n\nðŸŒ Fonti: 10,000+\nðŸ¤– AI: Fake news filter\nâš¡ Breaking news alerts\nðŸ“Š Trend analysis\n\n**Categorie:** Tech, Finance, Politics, Science\n**Esempio:** "ultime notizie AI"`;
                    break;
                case 'open_data':
                    output = `ðŸŒ **Open Data Portal**\n\nðŸ‡®ðŸ‡¹ ISTAT: Statistiche Italia\nðŸ‡ªðŸ‡º Eurostat: Dati Europa\nðŸ‡ºðŸ‡¸ data.gov: USA datasets\n\n**Funzioni:** Visualizzazione, Export, API\n**Esempio:** "dati popolazione Italia"`;
                    break;
                case 'api_catalog':
                    output = `ðŸ”Œ **API Catalog**\n\nðŸ“‚ Categorie: 50+\nðŸ”— API: 5,000+\nðŸ“– Documentazione integrata\nðŸ§ª Test endpoint live\n\n**Esempio:** "cerca API meteo" o "lista API gratuite"`;
                    break;
                case 'code_repos':
                    output = `ðŸ’» **Code Repository Search**\n\nðŸ™ GitHub: 200M+ repos\nðŸ¦Š GitLab: Self-hosted + Cloud\nðŸ”’ Security: Vulnerability scan\n\n**Esempio:** "cerca repo python chatbot"\n**Analisi:** Dipendenze, Licenze, Security`;
                    break;
                default:
                    output = `ðŸ“š **${tool.toUpperCase()}**\n\nRisorsa pronta. Dimmi cosa cercare!`;
            }
            
            addAssistantMessage(output, state.currentMode, 0.95);
            if (state.isTTSEnabled) speak(toolMessages[tool]);
        }
        
        // ============ ARCHAEOLOGY & HISTORY TOOLS ============
        async function runArchaeologyTool(tool) {
            const toolMessages = {
                site_analysis: 'ðŸ—¿ Analisi sito archeologico... AI per ricostruzione e datazione.',
                artifact_id: 'ðŸº Sistema identificazione reperti... Confronto con database museali.',
                dating_calc: 'ðŸ“… Calcolatore datazione... C-14, dendrocronologia, termoluminescenza.',
                ancient_texts: 'ðŸ“œ Database testi antichi... Papiri, iscrizioni, manoscritti.',
                '3d_reconstruction': 'ðŸ—ï¸ Ricostruzione 3D... Monumenti e cittÃ  antiche.',
                historical_maps: 'ðŸ—ºï¸ Archivio mappe storiche... Georeferenziate e overlay.',
                dynasty_db: 'ðŸ‘‘ Database dinastie... Genealogie e collegamenti storici.',
                museum_catalog: 'ðŸ›ï¸ Catalogo musei... Collezioni mondiali, tour virtuali.'
            };
            
            addSystemMessage(toolMessages[tool] || `ðŸ›ï¸ Archaeology tool ${tool} avviato`);
            
            let output = '';
            switch(tool) {
                case 'site_analysis':
                    output = `ðŸ—¿ **Archaeological Site Analysis**\n\nðŸ›°ï¸ Analisi immagini satellitari\nðŸ“ Mappatura GIS stratigrafica\nðŸ—ï¸ Ricostruzione 3D AI\nðŸ“… Datazione automatica\n\n**Input:** Coordinate o nome sito\n**Output:** Report completo + 3D model`;
                    break;
                case 'artifact_id':
                    output = `ðŸº **Artifact Identification**\n\nðŸ“¸ Image Recognition AI\nðŸ›ï¸ Database: Louvre, British Museum, Met, +500\nðŸ“Š Confidence score\nðŸ“– Scheda tecnica completa\n\n**Come usare:** Carica foto del reperto`;
                    break;
                case 'dating_calc':
                    output = `ðŸ“… **Dating Calculator**\n\nâ˜¢ï¸ Carbonio-14 (fino a 50,000 anni)\nðŸŒ³ Dendrocronologia (anelli alberi)\nðŸ’¡ Termoluminescenza (ceramiche)\nðŸ§² Paleomagnetismo\n\n**Input:** Tipo campione + dati misurazione\n**Output:** Data Â± errore + calibrazione`;
                    break;
                case 'ancient_texts':
                    output = `ðŸ“œ **Ancient Texts Database**\n\nðŸ“š Papiri egizi\nðŸ›ï¸ Iscrizioni romane\nðŸ“– Manoscritti medievali\nðŸ”¤ OCR scritture antiche\n\n**Lingue:** Geroglifico, Latino, Greco, Sumero\n**Funzione:** Trascrizione + Traduzione AI`;
                    break;
                case '3d_reconstruction':
                    output = `ðŸ—ï¸ **3D Historical Reconstruction**\n\nðŸ›ï¸ Monumenti: Colosseo, Partenone, Piramidi\nðŸ˜ï¸ CittÃ : Pompei, Roma Antica, Babilonia\nðŸ“ Basato su dati archeologici reali\nðŸŽ® Esplorazione VR disponibile\n\n**Esempio:** "ricostruisci foro romano"`;
                    break;
                case 'historical_maps':
                    output = `ðŸ—ºï¸ **Historical Maps Archive**\n\nðŸ“œ Mappe dal 3000 a.C.\nðŸŒ Georeferenziazione moderna\nðŸ”„ Overlay comparativo\nðŸ“Š Analisi cambiamenti territoriali\n\n**Collezioni:** Tabula Peutingeriana, Portolani, Cartografia coloniale`;
                    break;
                case 'dynasty_db':
                    output = `ðŸ‘‘ **Dynasty Database**\n\nðŸŒ³ Alberi genealogici interattivi\nðŸ”— Collegamenti tra dinastie\nðŸ“… Timeline interattiva\nðŸ—ºï¸ Espansione territoriale\n\n**Dinastie:** Faraoni, Imperatori Romani, Monarchie Europee, Shogun`;
                    break;
                case 'museum_catalog':
                    output = `ðŸ›ï¸ **World Museum Catalog**\n\nðŸŽ¨ Collezioni: 10,000+ musei\nðŸ–¼ï¸ Opere: 50M+ digitalizzate\nðŸŽ§ Audio guide AI\nðŸ¥½ Tour virtuali 360Â°\n\n**Funzioni:** Ricerca, Confronto, Prestiti\n**Esempio:** "cerca mummie British Museum"`;
                    break;
                default:
                    output = `ðŸ›ï¸ **${tool.toUpperCase()}**\n\nStrumento archeologico pronto. Cosa vuoi esplorare?`;
            }
            
            addAssistantMessage(output, state.currentMode, 0.95);
            if (state.isTTSEnabled) speak(toolMessages[tool]);
        }

        // ============ SYSTEM INFO FUNCTIONS ============
        async function showProcesses() {
            try {
                const response = await fetch(`${API_BASE}/api/system/dev/status`);
                const data = await response.json();
                
                let info = "ðŸ“‹ **Processi e Sistema**\n\n";
                if (data.system_load) {
                    info += `CPU: ${data.system_load.cpu_percent}%\n`;
                    info += `RAM: ${data.system_load.memory_percent}%\n`;
                    info += `Disco: ${data.system_load.disk_percent}%\n`;
                }
                
                addAssistantMessage(info, state.currentMode, 0.95);
                if (state.isTTSEnabled) {
                    speak("Ecco le informazioni sui processi");
                }
            } catch (error) {
                showResultPopup('âŒ Impossibile ottenere info processi', 'error');
            }
        }
        
        async function showWindows() {
            addAssistantMessage("ðŸªŸ Per vedere le finestre aperte, usa il comando: 'mostra finestre aperte'", state.currentMode, 0.9);
        }
        
        async function showSystemInfo() {
            try {
                const response = await fetch(`${API_BASE}/api/gideon/health`);
                const data = await response.json();
                
                let info = "ðŸ“Š **Info Sistema GIDEON**\n\n";
                info += `Versione: ${data.version}\n`;
                info += `Stato: ${data.status}\n\n`;
                info += "**Componenti:**\n";
                for (const [key, value] of Object.entries(data.components)) {
                    info += `â€¢ ${key}: ${value ? 'âœ…' : 'âŒ'}\n`;
                }
                
                if (data.system_load) {
                    info += `\n**Carico Sistema:**\n`;
                    info += `â€¢ CPU: ${data.system_load.cpu_percent}%\n`;
                    info += `â€¢ RAM: ${data.system_load.memory_percent}%\n`;
                }
                
                addAssistantMessage(info, state.currentMode, 0.95);
            } catch (error) {
                showResultPopup('âŒ Impossibile ottenere info sistema', 'error');
            }
        }
        
        async function showResourceUsage() {
            try {
                const response = await fetch(`${API_BASE}/api/system/load`);
                const data = await response.json();
                
                if (data.success && data.load) {
                    let info = "ðŸ“ˆ **Utilizzo Risorse**\n\n";
                    info += `ðŸ”² CPU: ${data.load.cpu_percent}%\n`;
                    info += `ðŸ’¾ RAM: ${data.load.memory_percent}%\n`;
                    info += `ðŸ’½ Disco: ${data.load.disk_percent}%\n`;
                    info += `\nâš¡ Stato: ${data.load.status}`;
                    
                    addAssistantMessage(info, state.currentMode, 0.95);
                    if (state.isTTSEnabled) {
                        speak(`CPU al ${data.load.cpu_percent} percento, RAM al ${data.load.memory_percent} percento`);
                    }
                }
            } catch (error) {
                showResultPopup('âŒ Impossibile ottenere utilizzo risorse', 'error');
            }
        }
        
        // ============ PILOT MODE DIALOG ============
        function showPilotDialog() {
            document.getElementById('pilot-dialog').classList.add('active');
            document.getElementById('pilot-phrase').focus();
        }
        
        function closePilotDialog() {
            document.getElementById('pilot-dialog').classList.remove('active');
            document.getElementById('pilot-phrase').value = '';
        }
        
        function confirmPilotMode() {
            const phrase = document.getElementById('pilot-phrase').value.trim().toLowerCase();
            const correctPhrase = 'autorizzazione pilot alfa zero uno';
            
            if (phrase === correctPhrase) {
                changeMode('pilot');
                closePilotDialog();
                addSystemMessage('ðŸš€ PILOT MODE ATTIVATO - Controllo totale abilitato');
                if (state.isTTSEnabled) {
                    speak("Pilot mode attivato. Controllo totale abilitato.");
                }
            } else {
                alert('âŒ Frase di autorizzazione non corretta');
                document.getElementById('pilot-phrase').value = '';
                document.getElementById('pilot-phrase').focus();
            }
        }
        
        // Enter key in pilot dialog
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('pilot-dialog').classList.contains('active')) {
                confirmPilotMode();
            }
            if (e.key === 'Escape') {
                closePilotDialog();
                const panel = document.getElementById('automation-panel');
                if (panel.classList.contains('active')) {
                    panel.classList.remove('active');
                }
            }
        });
        
        // ============ RESULT POPUP ============
        function showResultPopup(message, type = 'info') {
            // Remove existing popups
            document.querySelectorAll('.result-popup').forEach(p => p.remove());
            
            const popup = document.createElement('div');
            popup.className = `result-popup ${type}`;
            popup.innerHTML = message;
            document.body.appendChild(popup);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                popup.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => popup.remove(), 300);
            }, 4000);
        }
        
        // ============ AI HUB FUNCTIONS ============
        let currentAIHubMode = null;
        
        const aiHubForms = {
            image: {
                title: 'ðŸŽ¨ Genera Immagine AI',
                fields: [
                    { name: 'prompt', label: 'Descrivi l\'immagine', type: 'textarea', placeholder: 'Es: Un gatto astronauta sulla luna, stile pittura a olio' },
                    { name: 'size', label: 'Dimensione', type: 'select', options: ['1024x1024', '1792x1024', '1024x1792'] },
                    { name: 'style', label: 'Stile', type: 'select', options: ['vivid', 'natural'] }
                ]
            },
            video: {
                title: 'ðŸŽ¬ Genera Video AI',
                fields: [
                    { name: 'prompt', label: 'Descrivi il video', type: 'textarea', placeholder: 'Es: Un tramonto sul mare con onde che si infrangono' },
                    { name: 'script', label: 'Script (opzionale)', type: 'textarea', placeholder: 'Testo da far leggere all\'avatar' },
                    { name: 'avatar_id', label: 'Avatar ID (HeyGen)', type: 'text', placeholder: 'Lascia vuoto per default' }
                ]
            },
            music: {
                title: 'ðŸŽµ Genera Musica AI',
                fields: [
                    { name: 'prompt', label: 'Descrivi la musica', type: 'textarea', placeholder: 'Es: Una melodia jazz rilassante con pianoforte e sassofono' },
                    { name: 'style', label: 'Genere', type: 'select', options: ['pop', 'rock', 'jazz', 'classical', 'electronic', 'hip-hop'] },
                    { name: 'duration', label: 'Durata (secondi)', type: 'number', value: 30 }
                ]
            },
            presentation: {
                title: 'ðŸ“Š Crea Presentazione AI',
                fields: [
                    { name: 'topic', label: 'Argomento', type: 'text', placeholder: 'Es: Intelligenza Artificiale nel 2025' },
                    { name: 'slides', label: 'Numero slide', type: 'number', value: 10 },
                    { name: 'style', label: 'Stile', type: 'select', options: ['professional', 'creative', 'minimal', 'tech'] }
                ]
            },
            podcast: {
                title: 'ðŸŽ™ï¸ Crea Podcast AI',
                fields: [
                    { name: 'content', label: 'Contenuto da discutere', type: 'textarea', placeholder: 'Incolla qui il testo o l\'argomento da trasformare in podcast' },
                    { name: 'title', label: 'Titolo', type: 'text', placeholder: 'Es: Tech Talk con GIDEON' },
                    { name: 'hosts', label: 'Numero host', type: 'number', value: 2 },
                    { name: 'duration_minutes', label: 'Durata (minuti)', type: 'number', value: 5 }
                ]
            },
            workflows: {
                title: 'âš™ï¸ Automazioni & Workflow',
                fields: [
                    { name: 'preset', label: 'Preset', type: 'select', options: ['daily_summary', 'voice_assistant', 'content_creator', 'email_responder', 'custom'] },
                    { name: 'name', label: 'Nome workflow', type: 'text', placeholder: 'Es: Il mio workflow' },
                    { name: 'description', label: 'Descrizione', type: 'textarea', placeholder: 'Descrivi cosa deve fare' }
                ]
            }
        };
        
        function openAIHub(mode) {
            currentAIHubMode = mode;
            const config = aiHubForms[mode];
            if (!config) return;
            
            document.getElementById('ai-hub-title').textContent = config.title;
            
            const formContainer = document.getElementById('ai-hub-form-container');
            formContainer.innerHTML = config.fields.map(field => {
                if (field.type === 'textarea') {
                    return `
                        <label>${field.label}</label>
                        <textarea name="${field.name}" placeholder="${field.placeholder || ''}">${field.value || ''}</textarea>
                    `;
                } else if (field.type === 'select') {
                    return `
                        <label>${field.label}</label>
                        <select name="${field.name}">
                            ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                    `;
                } else if (field.type === 'number') {
                    return `
                        <label>${field.label}</label>
                        <input type="number" name="${field.name}" value="${field.value || 0}">
                    `;
                } else {
                    return `
                        <label>${field.label}</label>
                        <input type="text" name="${field.name}" placeholder="${field.placeholder || ''}" value="${field.value || ''}">
                    `;
                }
            }).join('');
            
            document.getElementById('ai-hub-result').style.display = 'none';
            document.getElementById('ai-hub-modal').classList.add('active');
        }
        
        function closeAIHub() {
            document.getElementById('ai-hub-modal').classList.remove('active');
            currentAIHubMode = null;
        }
        
        async function submitAIHub() {
            if (!currentAIHubMode) return;
            
            const formContainer = document.getElementById('ai-hub-form-container');
            const formData = {};
            
            formContainer.querySelectorAll('input, textarea, select').forEach(el => {
                formData[el.name] = el.type === 'number' ? parseInt(el.value) : el.value;
            });
            
            const resultDiv = document.getElementById('ai-hub-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'â³ Elaborazione in corso...';
            resultDiv.style.background = 'rgba(138, 43, 226, 0.2)';
            
            try {
                let endpoint = '';
                let body = formData;
                
                switch(currentAIHubMode) {
                    case 'image': endpoint = '/api/hub/image'; break;
                    case 'video': endpoint = '/api/hub/video'; break;
                    case 'music': endpoint = '/api/hub/music'; break;
                    case 'presentation': endpoint = '/api/hub/presentation'; break;
                    case 'podcast': endpoint = '/api/hub/podcast'; break;
                    case 'workflows':
                        if (formData.preset !== 'custom') {
                            endpoint = `/api/hub/workflows/presets/${formData.preset}`;
                            body = {};
                        } else {
                            endpoint = '/api/hub/workflows';
                        }
                        break;
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const result = await response.json();
                
                if (result.success || result.workflow_id) {
                    resultDiv.style.background = 'rgba(0, 255, 100, 0.2)';
                    
                    if (result.image_base64) {
                        resultDiv.innerHTML = `
                            <p>âœ… Immagine generata!</p>
                            <img src="data:image/png;base64,${result.image_base64}" style="max-width: 100%; border-radius: 10px; margin-top: 10px;">
                        `;
                    } else if (result.audio_base64) {
                        resultDiv.innerHTML = `
                            <p>âœ… Audio generato!</p>
                            <audio controls src="data:audio/mp3;base64,${result.audio_base64}" style="width: 100%; margin-top: 10px;"></audio>
                        `;
                    } else if (result.content) {
                        resultDiv.innerHTML = `
                            <p>âœ… Contenuto generato!</p>
                            <pre style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${result.content}</pre>
                        `;
                    } else if (result.script) {
                        resultDiv.innerHTML = `
                            <p>âœ… Podcast script generato!</p>
                            <pre style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${result.script}</pre>
                        `;
                    } else if (result.workflow_id) {
                        resultDiv.innerHTML = `
                            <p>âœ… Workflow creato!</p>
                            <p>ID: <code>${result.workflow_id}</code></p>
                            <p>Nome: ${result.name}</p>
                        `;
                    } else {
                        resultDiv.innerHTML = `<p>âœ… Operazione completata!</p><pre>${JSON.stringify(result, null, 2)}</pre>`;
                    }
                    
                    addSystemMessage(`ðŸš€ AI Hub: ${currentAIHubMode} completato!`);
                } else {
                    resultDiv.style.background = 'rgba(255, 100, 100, 0.2)';
                    resultDiv.innerHTML = `<p>âŒ Errore: ${result.error || 'Operazione fallita'}</p>`;
                }
            } catch (error) {
                resultDiv.style.background = 'rgba(255, 100, 100, 0.2)';
                resultDiv.innerHTML = `<p>âŒ Errore di connessione: ${error.message}</p>`;
            }
        }
        
        // ============ START ============
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
